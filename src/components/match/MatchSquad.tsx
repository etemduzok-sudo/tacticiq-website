// src/components/match/MatchSquad.tsx - COMPLETE VERSION
import React, { useState } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Dimensions,
  useWindowDimensions,
  Modal,
  FlatList,
  Platform,
  InteractionManager,
  ActivityIndicator,
} from 'react-native';
import { showAlert, showInfo } from '../../utils/alertHelper';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { supabase } from '../../config/supabase';
import { STORAGE_KEYS, PITCH_LAYOUT } from '../../config/constants';
import { squadPredictionsApi, teamsApi, matchesApi } from '../../services/api';
import { getBulkSquad, refreshBulkSquad } from '../../services/bulkDataService';
import { predictionsDb } from '../../services/databaseService';
import { ConfirmModal, ConfirmButton } from '../ui/ConfirmModal';
import { LinearGradient } from 'expo-linear-gradient';
import { Ionicons } from '@expo/vector-icons';
import Animated, { 
  SlideInDown,
  SlideOutDown,
  useAnimatedStyle,
  withRepeat,
  withTiming,
  useSharedValue,
} from 'react-native-reanimated';
import Svg, { 
  Rect, 
  Circle, 
  Line, 
  Path,
} from 'react-native-svg';
import { CommunitySignalPopup } from './CommunitySignalPopup';
import { useFavoriteTeams } from '../../hooks/useFavoriteTeams';
import { useTheme } from '../../contexts/ThemeContext';
import { useTranslation } from '../../hooks/useTranslation';
import { COLORS } from '../../theme/theme';
import { isMockTestMatch, getMockUserTeamId, MOCK_MATCH_IDS, getMatch1Start, getMatch2Start, getUserPreferenceStats, generateAutoSquad } from '../../data/mockTestData';
import { getPreferenceBorderStyle, getPositionGroupColor, type UserPreferenceStats, type AutoGeneratedSquad } from '../../utils/squadPreferenceUtils';
import { formations, formationLabels, formationPositions } from '../../constants/formations';

// Web iÃ§in dinamik boyutlandÄ±rma
const isWeb = Platform.OS === 'web';
const screenDimensions = Dimensions.get('window');
// Web'de max 500px, mobilde ekran geniÅŸliÄŸi
const width = isWeb ? Math.min(screenDimensions.width, 500) : screenDimensions.width;
const height = screenDimensions.height;

// Helper function to get color based on stat value
const getStatColor = (value: number): string => {
  if (value >= 85) return '#10B981'; // Green - Excellent
  if (value >= 70) return '#1FA2A6'; // Teal - Good
  if (value >= 50) return '#F59E0B'; // Yellow - Average
  return '#EF4444'; // Red - Poor
};

// Rating normalizasyonu - TÃœM rating'ler 100 Ã¼zerinden gÃ¶sterilir
// API'den gelen: 0-10 (maÃ§ reytingi) veya 65-99 (genel). Hepsi 0-100 gÃ¶sterim (60â€“70 farkÄ± korunur, yuvarlamayla kaybedilmez).
const normalizeRatingTo100 = (rating: number | null | undefined): number => {
  if (rating == null) return 75; // Default
  const r = Number(rating);
  if (r > 0 && r <= 10) return Math.min(100, Math.round(r * 10)); // 6.7 â†’ 67
  if (r > 10 && r <= 100) return Math.round(r); // 72.4 â†’ 72
  return 75; // Fallback
};

// Rating gÃ¶rÃ¼ntÃ¼leme iÃ§in string formatÄ±
const formatRatingDisplay = (rating: number | null | undefined): string => {
  return normalizeRatingTo100(rating).toString();
};

interface MatchSquadProps {
  matchData: any;
  matchId: string;
  lineups?: any[];
  /** Sadece bu takÄ±m(lar)Ä±n kadrosu gÃ¶sterilir; rakip gizlenir. BoÅŸsa tÃ¼m kadro gÃ¶sterilir. */
  favoriteTeamIds?: number[];
  /** Ä°ki favori takÄ±m maÃ§Ä±nda hangi takÄ±m iÃ§in kadro seÃ§ildiÄŸi; verilirse kadro/tahmin bu takÄ±ma Ã¶zel saklanÄ±r. */
  predictionTeamId?: number;
  onComplete: () => void;
  /** Atak formasyonu deÄŸiÅŸikliÄŸi onaylandÄ±ktan sonra (tahminler silindikten sonra) Ã§aÄŸrÄ±lÄ±r â€“ Ã¶rn. Dashboard'a dÃ¶nÃ¼p analiz odaÄŸÄ± seÃ§imi gÃ¶sterilsin */
  onAttackFormationChangeConfirmed?: () => void;
  /** Kadro sekmesi gÃ¶rÃ¼nÃ¼r olduÄŸunda true â€“ Tahmin'den geri dÃ¶nÃ¼ldÃ¼ÄŸÃ¼nde storage'dan tekrar yÃ¼klenir */
  isVisible?: boolean;
  /** Biten maÃ§: ilk 11 sabit, oyuncu Ã§Ä±karma (Ã§arpÄ±) gÃ¶sterilmez */
  isMatchFinished?: boolean;
  /** CanlÄ± maÃ§: Kadro VIEW-ONLY (maÃ§ baÅŸladÄ±ÄŸÄ±nda kilitlenir) */
  isMatchLive?: boolean;
  /** KaydedilmemiÅŸ deÄŸiÅŸiklik olduÄŸunda Ã§aÄŸrÄ±lÄ±r - parent component'e bildirir */
  onHasUnsavedChanges?: (hasChanges: boolean) => void;
  /** Ä°lk 11 popup'Ä± zaten gÃ¶sterildi mi? (parent state - sekme deÄŸiÅŸse bile korunur) */
  startingXIPopupShown?: boolean;
  /** Ä°lk 11 popup'Ä± gÃ¶sterildiÄŸinde Ã§aÄŸrÄ±lÄ±r - parent'a bildirir */
  onStartingXIPopupShown?: () => void;
  /** âœ… Topluluk verilerini gÃ¶rdÃ¼ mÃ¼? (gÃ¶rÃ¼ldÃ¼yse kadro kilidi aÃ§Ä±lamaz) */
  hasViewedCommunityData?: boolean;
  /** Kadro yokken (canlÄ±/biten maÃ§) Tahmin / CanlÄ± / Ä°statistik sekmelerine yÃ¶nlendirmek iÃ§in */
  onNavigateToTab?: (tab: 'prediction' | 'live' | 'stats') => void;
}

/** API'den gelen tÃ¼m kaleci varyantlarÄ±nÄ± tanÄ± (G, GK, Goalkeeper vb.) */
function isGoalkeeperPlayer(p: { position?: string; pos?: string } | null | undefined): boolean {
  if (!p) return false;
  const pos = (p.position ?? p.pos ?? '') as string;
  if (!pos) return false;
  const lower = pos.toLowerCase();
  return pos === 'GK' || pos === 'G' || lower === 'goalkeeper' || lower.startsWith('goalkeeper');
}

/** Kadro oluÅŸtururken pozisyonu normalize et â€“ kaleciler her yerde 'GK' olsun */
function normalizePosition(pos: string | undefined): string {
  const raw = pos ?? '';
  const lower = raw.toLowerCase();
  if (raw === 'G' || raw === 'GK' || lower === 'goalkeeper' || lower.startsWith('goalkeeper')) return 'GK';
  return raw || 'SUB';
}

// Football Field Component
const FootballField = ({ children, style }: any) => (
  <View style={[styles.fieldContainer, style]}>
    <LinearGradient
      colors={['#16A34A', '#22C55E', '#16A34A']}
      start={{ x: 0, y: 0 }}
      end={{ x: 0, y: 1 }}
      style={styles.fieldGradient}
    >
      <Svg width="100%" height="100%" viewBox="0 0 100 150" preserveAspectRatio="none" style={styles.fieldSvg}>
        <Rect x="2" y="2" width="96" height="146" fill="none" stroke="white" strokeWidth="0.5" opacity="0.3" />
        <Line x1="2" y1="75" x2="98" y2="75" stroke="white" strokeWidth="0.5" opacity="0.3" />
        <Circle cx="50" cy="75" r="13.5" fill="none" stroke="white" strokeWidth="0.5" opacity="0.3" />
        <Circle cx="50" cy="75" r="1" fill="white" opacity="0.3" />
        <Rect x="20.35" y="2" width="59.3" height="23" fill="none" stroke="white" strokeWidth="0.5" opacity="0.3" />
        <Rect x="36.55" y="2" width="26.9" height="7.7" fill="none" stroke="white" strokeWidth="0.5" opacity="0.3" />
        <Circle cx="50" cy="17.3" r="0.8" fill="white" opacity="0.3" />
        <Rect x="20.35" y="125" width="59.3" height="23" fill="none" stroke="white" strokeWidth="0.5" opacity="0.3" />
        <Rect x="36.55" y="140.3" width="26.9" height="7.7" fill="none" stroke="white" strokeWidth="0.5" opacity="0.3" />
        <Circle cx="50" cy="132.7" r="0.8" fill="white" opacity="0.3" />
        <Path d="M 2 4.5 A 2.5 2.5 0 0 1 4.5 2" stroke="white" strokeWidth="0.5" fill="none" opacity="0.3" />
        <Path d="M 95.5 2 A 2.5 2.5 0 0 1 98 4.5" stroke="white" strokeWidth="0.5" fill="none" opacity="0.3" />
        <Path d="M 98 145.5 A 2.5 2.5 0 0 1 95.5 148" stroke="white" strokeWidth="0.5" fill="none" opacity="0.3" />
        <Path d="M 4.5 148 A 2.5 2.5 0 0 1 2 145.5" stroke="white" strokeWidth="0.5" fill="none" opacity="0.3" />
      </Svg>
      {children}
    </LinearGradient>
  </View>
);

export function MatchSquad({ matchData, matchId, lineups, favoriteTeamIds: favoriteTeamIdsProp = [], predictionTeamId, onComplete, onAttackFormationChangeConfirmed, isVisible = true, isMatchFinished = false, isMatchLive: isMatchLiveProp, onHasUnsavedChanges, startingXIPopupShown = false, onStartingXIPopupShown, hasViewedCommunityData = false, onNavigateToTab }: MatchSquadProps) {
  const { width: winW, height: winH } = useWindowDimensions();
  const { theme } = useTheme();
  const { t } = useTranslation();
  const isLight = theme === 'light';
  const themeColors = isLight ? COLORS.light : COLORS.dark;

  // âœ… Kendi hook'umuzla favori takÄ±mlarÄ± al - prop boÅŸ gelebilir
  const { favoriteTeams } = useFavoriteTeams();
  const favoriteTeamIds = React.useMemo(() => {
    // Prop doluysa onu kullan, yoksa hook'tan al
    if (favoriteTeamIdsProp.length > 0) return favoriteTeamIdsProp;
    return favoriteTeams?.map(t => t.id) ?? [];
  }, [favoriteTeamIdsProp, favoriteTeams]);
  
  // Saha boyutlarÄ± - Tahmin ile BÄ°REBÄ°R aynÄ± hesaplama (runtime'da)
  const fieldWidth = isWeb ? Math.min(winW, 500) - PITCH_LAYOUT.H_PADDING : winW - PITCH_LAYOUT.H_PADDING;
  const fieldHeight = isWeb 
    ? Math.min(PITCH_LAYOUT.WEB_HEIGHT, Math.max(320, winH - 320))
    : fieldWidth * PITCH_LAYOUT.ASPECT_RATIO;
  
  const fieldDynamicStyle: { width: number; height: number; maxWidth?: number; maxHeight?: number } = {
    width: fieldWidth,
    height: fieldHeight,
  };
  if (isWeb) {
    fieldDynamicStyle.maxWidth = PITCH_LAYOUT.WEB_MAX_WIDTH;
    fieldDynamicStyle.maxHeight = Math.min(PITCH_LAYOUT.WEB_HEIGHT, Math.max(0, winH - 320));
  }

  // âœ… TakÄ±m ID'lerini matchData'dan al
  const homeTeamId = matchData?.teams?.home?.id || matchData?.homeTeam?.id;
  const awayTeamId = matchData?.teams?.away?.id || matchData?.awayTeam?.id;
  const homeTeamName = matchData?.teams?.home?.name || matchData?.homeTeam?.name || 'Ev Sahibi';
  const awayTeamName = matchData?.teams?.away?.name || matchData?.awayTeam?.name || 'Deplasman';

  // âœ… Mock maÃ§larda senin takÄ±mÄ±n: 888001 â†’ FB (611), 888002 â†’ Real (541) â€“ kadro bu takÄ±ma gÃ¶re kaydedilir
  const matchIdNum = typeof matchId === 'string' ? parseInt(matchId, 10) : matchId;
  const effectivePredictionTeamId = predictionTeamId ?? getMockUserTeamId(matchIdNum) ?? undefined;
  // Ä°ki favori maÃ§ta veya mock maÃ§ta takÄ±ma Ã¶zel kadro anahtarÄ±
  const squadStorageKey = React.useMemo(
    () => (effectivePredictionTeamId != null ? `${STORAGE_KEYS.SQUAD}${matchId}-${effectivePredictionTeamId}` : `${STORAGE_KEYS.SQUAD}${matchId}`),
    [matchId, effectivePredictionTeamId]
  );
  // âœ… TakÄ±m kadrosu iÃ§in state (Ã¶nce uygulama cache'i, yoksa API)
  const [squadPlayers, setSquadPlayers] = React.useState<any[]>([]);
  const [isLoadingSquad, setIsLoadingSquad] = React.useState(false);
  const [squadLoadingFromApi, setSquadLoadingFromApi] = React.useState(false); // true = API'den Ã§ekiliyor (mesaj iÃ§in)
  const [squadRetryKey, setSquadRetryKey] = React.useState(0);

  // âœ… Topluluk "oyundan Ã§Ä±ksÄ±n" verisi (subOutRate = subOutVotes / totalPredictors)
  // Mock 999999: API yoksa client-side fallback ile her zaman gÃ¶ster
  const [subOutData, setSubOutData] = React.useState<{ totalPredictors: number; players: Record<string | number, { subOutVotes: number; replacementName?: string | null }> } | null>(null);
  React.useEffect(() => {
    if (!matchId || !isVisible) return;
    let cancelled = false;
    matchesApi.getCommunityStats(String(matchId))
      .then((res: any) => {
        if (cancelled) return;
        if (res?.data?.subOutByPlayer) {
          setSubOutData({
            totalPredictors: res.data.subOutByPlayer.totalPredictors || 0,
            players: res.data.subOutByPlayer.players || {},
          });
        }
      })
      .catch(() => {});
    return () => { cancelled = true; };
  }, [matchId, isVisible]);

  const retrySquadFetch = React.useCallback(() => {
    setSquadRetryKey((k) => k + 1);
  }, []);

  // âœ… Lineups yoksa kadro: Ã¶nce uygulama cache'inden (bulk), yoksa API
  React.useEffect(() => {
    const mapBulkPlayer = (p: any, teamName: string, teamId: number) => ({
      id: p.id,
      name: p.name ?? 'Bilinmiyor',
      firstname: p.firstname ?? null,
      lastname: p.lastname ?? null,
      position: normalizePosition(p.position),
      rating: p.rating ?? 75,
      number: p.number ?? p.shirt_number ?? p.jersey_number ?? 0,
      team: teamName,
      teamId,
      form: 7,
      injury: false,
      age: p.age ?? 25,
      nationality: 'Unknown',
      photo: p.photo ?? null,
      stats: { pace: 70, shooting: 70, passing: 70, dribbling: 70, defending: 70, physical: 70 },
    });

    /**
     * âœ… DOÄRU MÄ°MARÄ°: API-First, Cache-Second (Stale-While-Revalidate)
     * 
     * 1. Her zaman API'den gÃ¼ncel veriyi Ã§ek (Single Source of Truth = Backend DB)
     * 2. API baÅŸarÄ±lÄ±ysa: Veriyi gÃ¶ster + cache'i gÃ¼ncelle
     * 3. API baÅŸarÄ±sÄ±zsa: Cache'den gÃ¶ster (offline/hata durumu)
     * 4. Cache sadece fallback, asla birincil kaynak deÄŸil
     */
    const fetchSquads = async () => {
      if (lineups && lineups.length > 0) return;
      if (!homeTeamId || !awayTeamId) {
        console.log('âš ï¸ No team IDs for squad fetch');
        return;
      }

      setIsLoadingSquad(true);
      setSquadLoadingFromApi(true);

      try {
        // âœ… ADIM 1: Her zaman API'den gÃ¼ncel veriyi Ã§ek (Backend DB = Single Source of Truth)
        // squadRetryKey > 0 = "Yeniden Dene" tÄ±klandÄ± â†’ API'den zorla yenile (eski oyuncular sorunu)
        const forceRefresh = squadRetryKey > 0;
        console.log('ğŸ“¥ Fetching team squads from API (source of truth)...', { homeTeamId, awayTeamId, forceRefresh });

        const homePromise = teamsApi.getTeamSquad(homeTeamId, undefined, forceRefresh).then((json) => json).catch((err) => {
          console.error('âŒ Home squad fetch exception:', err.message);
          return null;
        });
        const awayPromise = teamsApi.getTeamSquad(awayTeamId, undefined, forceRefresh).then((json) => json).catch((err) => {
          console.error('âŒ Away squad fetch exception:', err.message);
          return null;
        });

        const [homeRes, awayRes] = await Promise.all([homePromise, awayPromise]);

        const allPlayers: any[] = [];

        if (homeRes?.data?.players && Array.isArray(homeRes.data.players)) {
          homeRes.data.players.forEach((p: any) => {
            allPlayers.push({
              id: p.id,
              name: p.name,
              firstname: p.firstname ?? null,
              lastname: p.lastname ?? null,
              position: normalizePosition(p.position),
              rating: p.rating || 75,
              number: p.number ?? p.shirt_number ?? p.jersey_number, team: homeTeamName, teamId: homeTeamId,
              form: 7, injury: p.injured || false, age: p.age || 25,
              nationality: p.nationality || 'Unknown', photo: p.photo,
              stats: { pace: 70, shooting: 70, passing: 70, dribbling: 70, defending: 70, physical: 70 }
            });
          });
        }
        if (awayRes?.data?.players && Array.isArray(awayRes.data.players)) {
          awayRes.data.players.forEach((p: any) => {
            allPlayers.push({
              id: p.id,
              name: p.name,
              firstname: p.firstname ?? null,
              lastname: p.lastname ?? null,
              position: normalizePosition(p.position),
              rating: p.rating || 75,
              number: p.number ?? p.shirt_number ?? p.jersey_number, team: awayTeamName, teamId: awayTeamId,
              form: 7, injury: p.injured || false, age: p.age || 25,
              nationality: p.nationality || 'Unknown', photo: p.photo,
              stats: { pace: 70, shooting: 70, passing: 70, dribbling: 70, defending: 70, physical: 70 }
            });
          });
        }

        // âœ… ADIM 2: API baÅŸarÄ±lÄ±ysa veriyi gÃ¶ster ve cache'i gÃ¼ncelle
        if (allPlayers.length > 0) {
          console.log('âœ… Squad loaded from API (source of truth):', allPlayers.length);
          setSquadPlayers(allPlayers);
          
          // Cache'i arka planda gÃ¼ncelle (sonraki offline eriÅŸim iÃ§in)
          if (homeRes?.data?.players) {
            refreshBulkSquad(homeTeamId, homeRes.data.players).catch(() => {});
          }
          if (awayRes?.data?.players) {
            refreshBulkSquad(awayTeamId, awayRes.data.players).catch(() => {});
          }
          return;
        }

        // âœ… ADIM 3: API baÅŸarÄ±sÄ±z veya boÅŸ dÃ¶ndÃ¼yse â†’ Cache'e fallback (offline/hata durumu)
        console.log('âš ï¸ API returned no data, falling back to cache...');
        
        const [homeBulk, awayBulk] = await Promise.all([
          getBulkSquad(homeTeamId),
          getBulkSquad(awayTeamId),
        ]);

        const homeList = Array.isArray(homeBulk) ? homeBulk : [];
        const awayList = Array.isArray(awayBulk) ? awayBulk : [];

        if (homeList.length > 0 || awayList.length > 0) {
          const cachedPlayers: any[] = [];
          homeList.forEach((p: any) => cachedPlayers.push(mapBulkPlayer(p, homeTeamName, homeTeamId)));
          awayList.forEach((p: any) => cachedPlayers.push(mapBulkPlayer(p, awayTeamName, awayTeamId)));
          
          if (cachedPlayers.length > 0) {
            console.log('ğŸ“¦ Squad loaded from cache (fallback):', cachedPlayers.length);
            setSquadPlayers(cachedPlayers);
            return;
          }
        }

        // Her iki kaynak da baÅŸarÄ±sÄ±z
        console.warn('âš ï¸ No squad data available from API or cache.');
        if (!homeRes && !awayRes) {
          console.error('âŒ Both API calls failed - Backend may not be running on port 3001');
        }
        setSquadPlayers([]);

      } catch (err: any) {
        console.error('âŒ Squad fetch error:', err?.message || err);
        
        // Hata durumunda cache'e fallback dene
        try {
          const [homeBulk, awayBulk] = await Promise.all([
            getBulkSquad(homeTeamId),
            getBulkSquad(awayTeamId),
          ]);
          const homeList = Array.isArray(homeBulk) ? homeBulk : [];
          const awayList = Array.isArray(awayBulk) ? awayBulk : [];
          
          if (homeList.length > 0 || awayList.length > 0) {
            const cachedPlayers: any[] = [];
            homeList.forEach((p: any) => cachedPlayers.push(mapBulkPlayer(p, homeTeamName, homeTeamId)));
            awayList.forEach((p: any) => cachedPlayers.push(mapBulkPlayer(p, awayTeamName, awayTeamId)));
            console.log('ğŸ“¦ Squad loaded from cache after error:', cachedPlayers.length);
            setSquadPlayers(cachedPlayers);
            return;
          }
        } catch {
          // Cache de baÅŸarÄ±sÄ±z
        }
        
        setSquadPlayers([]);
      } finally {
        setIsLoadingSquad(false);
        setSquadLoadingFromApi(false);
      }
    };

    fetchSquads();
  }, [lineups, homeTeamId, awayTeamId, homeTeamName, awayTeamName, matchId, squadRetryKey]);

  // âœ… GERÃ‡EK VERÄ°: Ã–nce lineups, yoksa squadPlayers kullan
  const realPlayers = React.useMemo(() => {
    // 1. Lineups varsa kullan (maÃ§ kadrosu)
    if (lineups && lineups.length > 0) {
    
    // Her iki takÄ±mÄ±n oyuncularÄ±nÄ± birleÅŸtir
    const allPlayers: any[] = [];
    lineups.forEach((lineup: any, index: number) => {
      const lineupTeamId = lineup.team?.id;
      const lineupTeamName = lineup.team?.name || 'Unknown';
      const teamColors = lineup.team?.colors; // Backend'den gelen team colors
      
      // âœ… TakÄ±m ID'yi doÄŸrula ve eÅŸleÅŸtir
      let finalTeamId = lineupTeamId;
      let finalTeamName = lineupTeamName;
      
      // EÄŸer lineup team.id matchData ile eÅŸleÅŸiyorsa kullan
      if (lineupTeamId === homeTeamId) {
        finalTeamId = homeTeamId;
        finalTeamName = homeTeamName;
      } else if (lineupTeamId === awayTeamId) {
        finalTeamId = awayTeamId;
        finalTeamName = awayTeamName;
      } else {
        // EÅŸleÅŸme yoksa, lineup sÄ±rasÄ±na gÃ¶re ata (ilk = home, ikinci = away)
        if (index === 0 && homeTeamId) {
          finalTeamId = homeTeamId;
          finalTeamName = homeTeamName;
          console.warn(`âš ï¸ Lineup[0] team ID mismatch: lineup.team.id=${lineupTeamId}, assigning to HOME (${homeTeamId})`);
        } else if (index === 1 && awayTeamId) {
          finalTeamId = awayTeamId;
          finalTeamName = awayTeamName;
          console.warn(`âš ï¸ Lineup[1] team ID mismatch: lineup.team.id=${lineupTeamId}, assigning to AWAY (${awayTeamId})`);
        } else {
          console.error(`âŒ Cannot match lineup[${index}] team ID ${lineupTeamId} to home (${homeTeamId}) or away (${awayTeamId})`);
        }
      }
      
      // BaÅŸlangÄ±Ã§ 11'i ekle
      if (lineup.startXI) {
        lineup.startXI.forEach((item: any) => {
          // Backend enriched format: doÄŸrudan player objesi
          // Eski format: item.player iÃ§inde
          const player = item.player || item;
          allPlayers.push({
            id: player.id,
            name: player.name,
            position: normalizePosition(player.pos || player.position),
            rating: player.rating || 75, // âœ… Backend'den gelen gerÃ§ek rating
            number: player.number,
            team: finalTeamName, // âœ… DoÄŸrulanmÄ±ÅŸ takÄ±m adÄ±
            teamId: finalTeamId, // âœ… DoÄŸrulanmÄ±ÅŸ takÄ±m ID
            teamColors: teamColors,
            form: 7,
            injury: false,
            age: player.age || 25,
            nationality: player.nationality || 'Unknown',
            grid: player.grid,
            stats: player.stats || { pace: 70, shooting: 70, passing: 70, dribbling: 70, defending: 70, physical: 70 } // âœ… Backend'den gelen stats varsa kullan
          });
        });
      }
      
      // Yedekleri ekle
      if (lineup.substitutes) {
        lineup.substitutes.forEach((item: any) => {
          const player = item.player || item;
          allPlayers.push({
            id: player.id,
            name: player.name,
            position: normalizePosition(player.pos || player.position),
            rating: player.rating || 70, // âœ… Backend'den gelen gerÃ§ek rating
            number: player.number,
            team: finalTeamName, // âœ… DoÄŸrulanmÄ±ÅŸ takÄ±m adÄ±
            teamId: finalTeamId, // âœ… DoÄŸrulanmÄ±ÅŸ takÄ±m ID
            teamColors: teamColors,
            form: 6,
            injury: false,
            age: player.age || 25,
            nationality: player.nationality || 'Unknown',
            grid: player.grid,
            stats: player.stats || { pace: 65, shooting: 65, passing: 65, dribbling: 65, defending: 65, physical: 65 } // âœ… Backend'den gelen stats varsa kullan
          });
        });
      }
    });

      // âœ… Debug: TakÄ±m daÄŸÄ±lÄ±mÄ±nÄ± kontrol et
      const homePlayers = allPlayers.filter((p: any) => p.teamId === homeTeamId);
      const awayPlayers = allPlayers.filter((p: any) => p.teamId === awayTeamId);
      console.log(`ğŸ” Lineups team check: homeTeamId=${homeTeamId} (${homeTeamName}) â†’ ${homePlayers.length} players, awayTeamId=${awayTeamId} (${awayTeamName}) â†’ ${awayPlayers.length} players`);

      // âœ… Mock maÃ§ (999999 veya 888001/888002) iÃ§in tÃ¼m oyuncularÄ± gÃ¶ster, favori filtresi uygulama
      const matchIdNum = typeof matchId === 'string' ? parseInt(matchId, 10) : matchId;
      const isMockMatch = matchId === 999999 || matchId === '999999' || String(matchId) === '999999' || isMockTestMatch(matchIdNum);
      
      // String/number uyumsuzluÄŸunu Ã¶nlemek iÃ§in favorileri number'a Ã§evir
      const favIdsNum = favoriteTeamIds.map((id: any) => typeof id === 'string' ? parseInt(id, 10) : id);
      
      const filtered = (isMockMatch || favoriteTeamIds.length === 0)
        ? allPlayers
        : allPlayers.filter((p: any) => {
            if (p.teamId == null) return false;
            const pTeamNum = typeof p.teamId === 'string' ? parseInt(p.teamId, 10) : p.teamId;
            return favIdsNum.includes(pTeamNum);
          });
      // Lineups + SquadPlayers birleÅŸtir: lineups'ta olmayan ama kadroda olan oyuncularÄ± ekle
      // BÃ¶ylece Osimhen, yedek kaleciler vb. kaybolmaz
      const lineupIds = new Set(filtered.map((p: any) => p.id));
      if (squadPlayers.length > 0) {
        const squadFiltered = (isMockMatch || favoriteTeamIds.length === 0)
          ? squadPlayers
          : squadPlayers.filter((p: any) => {
              if (p.teamId == null) return false;
              const pTeamNum = typeof p.teamId === 'string' ? parseInt(p.teamId, 10) : p.teamId;
              return favIdsNum.includes(pTeamNum);
            });
        squadFiltered.forEach((sp: any) => {
          if (!lineupIds.has(sp.id)) {
            filtered.push(sp);
            lineupIds.add(sp.id);
          }
        });
      }

      // Dedup: aynÄ± ID'li oyuncularÄ± tek tut
      const deduped: any[] = [];
      const seenPlayerIds = new Set<number>();
      for (const p of filtered) {
        if (!seenPlayerIds.has(p.id)) {
          seenPlayerIds.add(p.id);
          deduped.push(p);
        }
      }

      console.log('âœ… Real players loaded (LINEUPS + SQUAD merged):', deduped.length, (isMockMatch ? '(mock - all players)' : favoriteTeamIds.length ? '(favori only)' : ''));
      return deduped;
    }

    // 2. Lineups yoksa squadPlayers kullan (takÄ±m kadrosu â€“ fetch zaten favoriye gÃ¶re filtrelenmiÅŸ)
    if (squadPlayers.length > 0) {
      // Dedup: aynÄ± ID'li oyuncularÄ± tek tut
      const deduped: any[] = [];
      const seenPlayerIds = new Set<number>();
      for (const p of squadPlayers) {
        if (!seenPlayerIds.has(p.id)) {
          seenPlayerIds.add(p.id);
          deduped.push(p);
        }
      }
      console.log('âœ… Real players loaded from SQUAD API:', deduped.length);
      return deduped;
    }

    // 3. HiÃ§biri yoksa boÅŸ array
    console.log('âš ï¸ No players available');
    return [];
  }, [lineups, squadPlayers, favoriteTeamIds, matchId, homeTeamId, awayTeamId, homeTeamName, awayTeamName]);

  // âœ… Atak kadrosu = senin takÄ±mÄ±n. Mock maÃ§larda: 888001 â†’ FB (611), 888002 â†’ Real (541).
  const attackTeamId = React.useMemo(() => {
    // Ä°ki favori maÃ§ta (predictionTeamId varsa) onu kullan
    if (predictionTeamId != null) return predictionTeamId;
    
    if (!homeTeamId || !awayTeamId) return homeTeamId || awayTeamId;
    
    // âœ… Mock maÃ§ (888001/888002): Senin takÄ±mÄ±n FB ve Real â€“ kadro buna gÃ¶re seÃ§ilir ve kaydedilir
    const mockUserTeam = getMockUserTeamId(matchIdNum);
    if (mockUserTeam != null) {
      console.log('ğŸ¯ Mock maÃ§ â€“ senin takÄ±mÄ±n:', mockUserTeam, mockUserTeam === 611 ? '(FB)' : '(Real)');
      return mockUserTeam;
    }
    // âœ… Eski mock (999999) iÃ§in ev sahibi
    const isMock9999 = matchId === 999999 || matchId === '999999' || String(matchId) === '999999';
    if (isMock9999) return homeTeamId;
    
    // âœ… Favori takÄ±mlardan biri maÃ§taysa onu kullan
    // String/number uyumsuzluÄŸunu Ã¶nlemek iÃ§in her iki tÃ¼rde de kontrol et
    const homeIdNum = typeof homeTeamId === 'string' ? parseInt(homeTeamId, 10) : homeTeamId;
    const awayIdNum = typeof awayTeamId === 'string' ? parseInt(awayTeamId, 10) : awayTeamId;
    const favIdsNum = favoriteTeamIds.map((id: any) => typeof id === 'string' ? parseInt(id, 10) : id);
    
    console.log('ğŸ” Favori kontrol:', { homeTeamId, awayTeamId, favoriteTeamIds, favIdsNum, homeIdNum, awayIdNum });
    
    if (favIdsNum.includes(homeIdNum)) {
      console.log('âœ… Home team is favorite:', homeIdNum);
      return homeTeamId;
    }
    if (favIdsNum.includes(awayIdNum)) {
      console.log('âœ… Away team is favorite:', awayIdNum);
      return awayTeamId;
    }
    
    console.warn('âš ï¸ No favorite team found in match, falling back to home team', { homeTeamId, awayTeamId, favoriteTeamIds });
    return homeTeamId;
  }, [homeTeamId, awayTeamId, favoriteTeamIds, predictionTeamId, matchId, matchIdNum]);

  // âœ… Atak modunda sadece atak takÄ±mÄ±nÄ±n oyuncularÄ± (rakip atanamaz)
  const attackTeamPlayers = React.useMemo(() => {
    if (!attackTeamId) return realPlayers;
    
    // âœ… Mock maÃ§ iÃ§in Ã¶zel kontrol (999999 veya 888001/888002)
    const matchIdNum = typeof matchId === 'string' ? parseInt(matchId, 10) : matchId;
    const isMockMatch = matchId === 999999 || matchId === '999999' || String(matchId) === '999999' || isMockTestMatch(matchIdNum);
    
    // String/number uyumsuzluÄŸunu Ã¶nlemek iÃ§in attackTeamId'yi number'a Ã§evir
    const attackTeamIdNum = typeof attackTeamId === 'string' ? parseInt(attackTeamId, 10) : attackTeamId;
    
    const filtered = realPlayers.filter((p: any) => {
      if (p.teamId == null) return false;
      const pTeamNum = typeof p.teamId === 'string' ? parseInt(p.teamId, 10) : p.teamId;
      return pTeamNum === attackTeamIdNum;
    });
    
    // Mock maÃ§ta eÄŸer filtreleme sonucu boÅŸ ise, ilk takÄ±mÄ±n (home) oyuncularÄ±nÄ± dÃ¶ndÃ¼r
    if (isMockMatch && filtered.length === 0 && realPlayers.length > 0) {
      // realPlayers'daki ilk takÄ±mÄ±n ID'sini bul ve o takÄ±mÄ±n oyuncularÄ±nÄ± dÃ¶ndÃ¼r
      const firstTeamId = realPlayers[0]?.teamId;
      if (firstTeamId) {
        const homeFiltered = realPlayers.filter((p: any) => p.teamId === firstTeamId);
        console.log('ğŸ¯ Mock maÃ§: attackTeamId eÅŸleÅŸmedi, ilk takÄ±mÄ±n oyuncularÄ± kullanÄ±lÄ±yor:', homeFiltered.length);
        return homeFiltered;
      }
    }
    
    console.log(`ğŸ“‹ attackTeamPlayers: attackTeamId=${attackTeamId}, filtered=${filtered.length}/${realPlayers.length}`);
    return filtered;
  }, [realPlayers, attackTeamId, matchId]);

  // âœ… Attack & Defense Formation States
  const [attackFormation, setAttackFormation] = useState<string | null>(null);
  const [defenseFormation, setDefenseFormation] = useState<string | null>(null);
  const [attackPlayers, setAttackPlayers] = useState<Record<number, any | null>>({});
  const [defensePlayers, setDefensePlayers] = useState<Record<number, any | null>>({});
  
  // âœ… Current editing mode: 'attack' or 'defense'
  const [editingMode, setEditingMode] = useState<'attack' | 'defense'>('attack');
  
  // âœ… Oynanan maÃ§ta karÅŸÄ±laÅŸtÄ±rma gÃ¶rÃ¼nÃ¼mÃ¼: kullanÄ±cÄ± tahmini / gerÃ§ek 11 / topluluk tercihleri
  type ViewSource = 'user' | 'actual' | 'community';
  const [viewSource, setViewSource] = useState<ViewSource>('community'); // VarsayÄ±lan: topluluk
  
  // âœ… GerÃ§ek ilk 11 (API lineup'tan) - atak ve defans formasyonlarÄ±
  const [actualAttackFormation, setActualAttackFormation] = useState<string | null>(null);
  const [actualAttackPlayers, setActualAttackPlayers] = useState<Record<number, any>>({});
  const [actualDefenseFormation, setActualDefenseFormation] = useState<string | null>(null);
  const [actualDefensePlayers, setActualDefensePlayers] = useState<Record<number, any>>({});
  
  // âœ… Confirmation modal for defense formation
  const [showDefenseConfirmModal, setShowDefenseConfirmModal] = useState(false);
  const [formationConfirmModal, setFormationConfirmModal] = useState<{ formationId: string } | null>(null);
  
  // âœ… Track if defense confirmation was already shown
  const [defenseConfirmShown, setDefenseConfirmShown] = useState(false);
  
  // âœ… State restore edildi mi?
  const [stateRestored, setStateRestored] = useState(false);
  
  // âœ… KullanÄ±cÄ± tahmin yapmÄ±ÅŸ mÄ±? (storage'da isCompleted === true)
  // âš ï¸ Bu state useEffect'lerde kullanÄ±ldÄ±ÄŸÄ± iÃ§in erken tanÄ±mlanmalÄ±
  const [hasPrediction, setHasPrediction] = React.useState(false);
  // âœ… Storage kontrolÃ¼ yapÄ±lmadan "Kadro oluÅŸturulmadÄ±" gÃ¶sterme (kÄ±sa sÃ¼reli yanÄ±p sÃ¶nmeyi Ã¶nler)
  const [hasCheckedSquadStorage, setHasCheckedSquadStorage] = React.useState(false);
  
  // âœ… KullanÄ±cÄ± tercih istatistikleri (tahmin yapmayan kullanÄ±cÄ±lar iÃ§in)
  const [userPreferenceStats, setUserPreferenceStats] = useState<UserPreferenceStats | null>(null);
  const [autoGeneratedSquad, setAutoGeneratedSquad] = useState<AutoGeneratedSquad | null>(null);
  // âœ… autoGeneratedSquad uygulandÄ± mÄ±? (runRestore'dan Ã¶nce tanÄ±mlanmalÄ±)
  const [autoSquadApplied, setAutoSquadApplied] = React.useState(false);
  const [showPreferencePopup, setShowPreferencePopup] = useState<{
    position: string;
    positionLabel: string;
    player: { id: number; name: string; number: number };
    preferencePercentage: number;
    totalPreferences: number;
    allPreferences: { playerId: number; playerName: string; percentage: number; count: number }[];
  } | null>(null);
  // âœ… Oyuncu reyting dropdown aÃ§Ä±k/kapalÄ± durumu
  const [showPlayerRatingDropdown, setShowPlayerRatingDropdown] = useState(false);
  // âœ… Tam tercih Ã¶zeti popup'Ä± (tÃ¼m pozisyonlar + formasyonlar)
  const [showFullPreferenceSummary, setShowFullPreferenceSummary] = useState(false);
  // âœ… Formasyon detay popup'Ä± (atak veya defans)
  const [showFormationDetailPopup, setShowFormationDetailPopup] = useState<'attack' | 'defense' | null>(null);
  // âœ… Ä°lk 11 popup'Ä± (maÃ§ baÅŸladÄ±ÄŸÄ±nda gÃ¶sterilir)
  const [showStartingXIPopup, setShowStartingXIPopup] = useState(false);
  const [startingXIPlayers, setStartingXIPlayers] = useState<any[]>([]);
  // âœ… "Tahminlerinizi TamamlayÄ±n" popup'Ä± kaldÄ±rÄ±ldÄ±
  // ArtÄ±k kullanÄ±cÄ±lar maÃ§ baÅŸladÄ±ktan sonra sayfayÄ± aÃ§tÄ±klarÄ±nda normal "Ä°lk 11" popup'Ä± gÃ¶recek
  
  // âœ… Atak formasyonundaki oyuncu deÄŸiÅŸikliklerini takip et (defans formasyonu yÃ¶netimi iÃ§in)
  const previousAttackPlayersRef = React.useRef<Record<number, any | null>>({});
  const attackPlayersInitializedRef = React.useRef(false);
  
  // âœ… Sadece oynanan/canlÄ± maÃ§ta kadro kilitli (MatchDetail'den gelen prop Ã¶ncelikli)
  const isMatchLive = React.useMemo(() => {
    if (typeof isMatchLiveProp === 'boolean') return isMatchLiveProp;
    const status = matchData?.fixture?.status?.short || matchData?.status || '';
    const liveStatuses = ['1H', '2H', 'HT', 'ET', 'BT', 'P', 'LIVE'];
    return liveStatuses.includes(status);
  }, [isMatchLiveProp, matchData]);

  // âœ… TOPLULUK VERÄ°LERÄ° GÃ–RÃœNÃœRLÃ¼K KONTROLÃœ
  // Kural: Topluluk verileri SADECE tahmin kaydedildikten sonra gÃ¶rÃ¼nÃ¼r
  // MaÃ§ canlÄ± veya bitmiÅŸ olmasÄ± yeterli DEÄÄ°L - kullanÄ±cÄ± kendi tahminini kaydetmiÅŸ olmalÄ±
  const communityDataVisible = hasPrediction === true;

  // âœ… YENÄ° KURAL: Kadro sekmesi maÃ§ baÅŸladÄ±ÄŸÄ±nda kilitlenir (120 sn kuralÄ± kaldÄ±rÄ±ldÄ±)
  // MaÃ§ canlÄ± veya bitmiÅŸse kadro dÃ¼zenlenemez
  const isKadroLocked = isMatchLive || isMatchFinished;
  const showKadroLockedToast = () => showInfo(t('matchSquad.squadLocked'), t('matchSquad.squadLockedMessage'));

  // âœ… KaydedilmemiÅŸ deÄŸiÅŸiklikleri takip et - state'ler aÅŸaÄŸÄ±da tanÄ±mlandÄ±ktan sonra useEffect ile kullanÄ±lacak
  const [hasUnsavedChanges, setHasUnsavedChanges] = React.useState(false);
  // âœ… Kilit aÃ§Ä±ldÄ±ktan sonra gerÃ§ekten deÄŸiÅŸiklik yapÄ±ldÄ± mÄ±?
  const [hasModifiedSinceUnlock, setHasModifiedSinceUnlock] = React.useState(false);

  // âœ… Ä°lk 11 popup kapanÄ±nca - useEffect otomatik olarak oyuncularÄ± yerleÅŸtirecek
  const handleStartingXIPopupClose = React.useCallback(() => {
    // Popup'Ä± kapat
    setShowStartingXIPopup(false);
    console.log('âœ… Ä°lk 11 popup kapatÄ±ldÄ±');
  }, []);

  // âœ… Mount ve Kadro sekmesi gÃ¶rÃ¼nÃ¼r olduÄŸunda AsyncStorage'dan yÃ¼kle (Tahmin'den geri dÃ¶nÃ¼nce kadro gÃ¶rÃ¼nsÃ¼n)
  // âœ… Tamamla basÄ±lmadan geri dÃ¶nÃ¼ldÃ¼ysa (isCompleted !== true): HÄ°Ã‡BÄ°R ÅEY yÃ¼kleme - formasyon seÃ§iminden baÅŸla
  // âœ… KullanÄ±cÄ± "Tamamla" butonu ile kadroyu tamamlayana kadar formasyon ve oyuncular gÃ¶sterilmez
  const runRestore = React.useCallback(async () => {
    if (isMatchFinished) {
      setStateRestored(true);
      return;
    }
    
    // âœ… autoSquadApplied ise restore'u atla - oyuncular zaten autoGeneratedSquad ile yerleÅŸtirilmiÅŸ
    if (autoSquadApplied) {
      setStateRestored(true);
      return;
    }
    
    try {
      const key = squadStorageKey;
      const raw = await AsyncStorage.getItem(key);
      if (raw) {
        const parsed = JSON.parse(raw);
        const isCompleted = parsed.isCompleted === true;
        const isAutoApplied = parsed.isAutoApplied === true;
        const liveStatuses = ['1H', '2H', 'HT', 'ET', 'BT', 'P', 'LIVE'];
        const isLive = liveStatuses.includes(matchData?.fixture?.status?.short || matchData?.status || '');

        // âœ… "Tamamla" basÄ±ldÄ±ysa: Her zaman yÃ¼kle (maÃ§ baÅŸlamamÄ±ÅŸ olsa bile)
        // âœ… CanlÄ± maÃ§ta auto-apply yapÄ±ldÄ±ysa da yÃ¼kle
        // âœ… Tamamla basÄ±lmadÄ±ysa VE maÃ§ baÅŸlamamÄ±ÅŸsa: HÄ°Ã‡BÄ°R veri yÃ¼kleme - empty state gÃ¶ster
        if (isCompleted || (isLive && isAutoApplied)) {
          // âœ… Tamamla basÄ±ldÄ±ysa veya canlÄ± maÃ§ta auto-apply yapÄ±ldÄ±ysa: YÃ¼kle (slot sÄ±rasÄ± kesin)
          if (parsed.attackFormation) {
            const raw = String(parsed.attackFormation).trim();
            setAttackFormation(formations.find(f => f.id === raw)?.id ?? raw);
          }
          // âœ… Atak kadrosunu slot sÄ±rasÄ±na gÃ¶re kur (kayÄ±tta karÄ±ÅŸmasÄ±n)
          if (parsed.attackPlayersBySlot && Array.isArray(parsed.attackPlayersBySlot)) {
            const ordered: Record<number, any> = {};
            for (let i = 0; i < 11; i++) {
              const e = parsed.attackPlayersBySlot.find((x: { slot: number }) => x.slot === i);
              if (e?.player) ordered[i] = e.player;
            }
            setAttackPlayers(ordered);
          } else if (parsed.attackPlayersArray && Array.isArray(parsed.attackPlayersArray)) {
            const ordered: Record<number, any> = {};
            for (let i = 0; i < 11; i++) {
              const p = parsed.attackPlayersArray[i];
              if (p) ordered[i] = p;
            }
            setAttackPlayers(ordered);
          } else if (parsed.attackPlayers && typeof parsed.attackPlayers === 'object') {
            const ordered: Record<number, any> = {};
            for (let i = 0; i < 11; i++) {
              const p = parsed.attackPlayers[i] ?? parsed.attackPlayers[String(i)];
              if (p) ordered[i] = p;
            }
            setAttackPlayers(ordered);
          }
          if (parsed.defenseFormation) {
            const rawDef = String(parsed.defenseFormation).trim();
            setDefenseFormation(formations.find(f => f.id === rawDef)?.id ?? rawDef);
          }
          // âœ… Defans kadrosunu slot sÄ±rasÄ±na gÃ¶re kur
          if (parsed.defensePlayersArray && Array.isArray(parsed.defensePlayersArray)) {
            const ordered: Record<number, any> = {};
            for (let i = 0; i < 11; i++) {
              const p = parsed.defensePlayersArray[i];
              if (p) ordered[i] = p;
            }
            setDefensePlayers(ordered);
          } else if (parsed.defensePlayers && typeof parsed.defensePlayers === 'object') {
            const ordered: Record<number, any> = {};
            for (let i = 0; i < 11; i++) {
              const p = parsed.defensePlayers[i] ?? parsed.defensePlayers[String(i)];
              if (p) ordered[i] = p;
            }
            setDefensePlayers(ordered);
          }
          // editingMode'u restore ET AMA sadece sayfa ilk yÃ¼klenirken
          if (parsed.editingMode && !stateRestored) setEditingMode(parsed.editingMode);
          setDefenseConfirmShown(parsed.defenseFormation ? true : (parsed.defenseConfirmShown || false));
          // âœ… TamamlanmÄ±ÅŸ kadro kilitli olarak gelir (sadece isCompleted true ise)
          setIsSquadLocked(isCompleted);
        } else if (!isMatchLive) {
          // âœ… MaÃ§ baÅŸlamamÄ±ÅŸ VE Tamamla basÄ±lmamÄ±ÅŸsa: HÄ°Ã‡BÄ°R veri yÃ¼kleme - empty state gÃ¶ster
          setAttackFormation(null);
          setAttackPlayers({});
          setDefenseFormation(null);
          setDefensePlayers({});
          if (!stateRestored) setEditingMode('attack');
          setDefenseConfirmShown(false);
        } else {
          // âœ… CanlÄ± maÃ§ ama Tamamla basÄ±lmamÄ±ÅŸ ve auto-apply yapÄ±lmamÄ±ÅŸ: SÄ±fÄ±rdan baÅŸla
          setAttackFormation(null);
          setAttackPlayers({});
          setDefenseFormation(null);
          setDefensePlayers({});
          if (!stateRestored) setEditingMode('attack');
          setDefenseConfirmShown(false);
        }
      } else {
        // âœ… Storage'da veri yoksa: formasyon null - empty state gÃ¶ster
        setAttackFormation(null);
        setAttackPlayers({});
        setDefenseFormation(null);
        setDefensePlayers({});
        if (!stateRestored) setEditingMode('attack');
        setDefenseConfirmShown(false);
      }
    } catch (e) {
      console.warn('State restore failed', e);
      // Hata durumunda da formasyon null yap
      setAttackFormation(null);
      setAttackPlayers({});
      setDefenseFormation(null);
      setDefensePlayers({});
      if (!stateRestored) setEditingMode('attack');
      setDefenseConfirmShown(false);
    }
    setStateRestored(true);
  }, [squadStorageKey, matchData, isMatchFinished, stateRestored, autoSquadApplied, isMatchLive]);

  // âœ… MAÃ‡ CANLI VE FORMASYON SEÃ‡Ä°LMEMÄ°ÅSE: En popÃ¼ler formasyonu otomatik uygula
  const [autoFormationApplied, setAutoFormationApplied] = React.useState(false);
  // âœ… BÄ°TEN MAÃ‡: Ä°lk 11'i en Ã§ok tercih edilen formasyona gÃ¶re bir kez yerleÅŸtir
  const [finishedFormationApplied, setFinishedFormationApplied] = React.useState(false);
  
  React.useEffect(() => {
    // Sadece maÃ§ canlÄ±ysa, restore tamamlandÄ±ysa, formasyon yoksa ve henÃ¼z auto-apply yapÄ±lmadÄ±ysa
    if (!isMatchLive || !stateRestored || attackFormation || autoFormationApplied) return;
    if (attackTeamPlayers.length === 0) return; // Oyuncular yÃ¼klenmeden bekle
    // âœ… Tahmin yapÄ±lmamÄ±ÅŸ kullanÄ±cÄ±lar iÃ§in bu useEffect Ã§alÄ±ÅŸmasÄ±n
    // handleStartingXIPopupClose zaten topluluk verilerine gÃ¶re formasyon uygulayacak
    if (!hasPrediction) return;
    
    const applyPopularFormation = async () => {
      try {
        console.log('ğŸ¯ MaÃ§ canlÄ± - en popÃ¼ler formasyon otomatik uygulanÄ±yor...');
        console.log('ğŸ“‹ Mevcut oyuncular:', attackTeamPlayers.length);
        
        // Mock 999999: KullanÄ±cÄ±larÄ±n Ã§oÄŸu atak 3-5-2, defans 3-6-1 seÃ§miÅŸ (farklÄ± olmalÄ±)
        let popularFormationId = '4-3-3';
        let popularDefenseFormationId = '4-3-3';
        {
          try {
            const popularRes = await squadPredictionsApi.getPopularFormations('attack');
            if (popularRes.success && popularRes.data && popularRes.data.length > 0) {
              popularFormationId = popularRes.data[0].formation;
            }
            const defRes = await squadPredictionsApi.getPopularFormations('defense');
            if (defRes?.success && defRes.data?.length > 0) {
              popularDefenseFormationId = defRes.data[0].formation;
            }
          } catch (apiErr) {
            console.log('âš ï¸ Popular formations API failed, using default');
          }
          // KullanÄ±cÄ±larÄ±n Ã§oÄŸu atak ve defansÄ± aynÄ± yapmÄ±ÅŸsa her iki formasyon da aynÄ± gÃ¶rÃ¼nÃ¼r
        }
        console.log('ğŸ“Š En popÃ¼ler formasyon (atak/defans):', popularFormationId, popularDefenseFormationId);
        
        const formation = formations.find(f => f.id === popularFormationId) || formations.find(f => f.id === '4-3-3');
        if (!formation) {
          console.log('âŒ Formation not found:', popularFormationId);
          return;
        }
        
        // Formasyonu uygula
        setAttackFormation(formation.id);
        
        // OyuncularÄ± pozisyonlara otomatik yerleÅŸtir
        const autoPlayers: Record<number, any | null> = {};
        const usedPlayerIds = new Set<number>();
        
        // Her slot iÃ§in en uygun oyuncuyu bul
        // âœ… FIX: formation.positions sadece string array (e.g., ['GK', 'CB', 'CB', ...])
        formation.positions.forEach((positionType: string, slotIndex: number) => {
          const slotPos = (positionType || '').toUpperCase();
          
          // Bu pozisyon iÃ§in uygun oyuncularÄ± filtrele
          let candidates = attackTeamPlayers.filter((p: any) => {
            if (usedPlayerIds.has(p.id)) return false;
            
            const playerPos = (p.position || p.pos || '').toUpperCase();
            
            // Kaleci sadece kaleci slotuna (slot 0 ve pozisyon GK)
            if (slotPos === 'GK' || slotPos === 'G') {
              return isGoalkeeperPlayer(p);
            }
            // Kaleci olmayan slotlara kaleci konamaz
            if (isGoalkeeperPlayer(p)) return false;
            
            // Pozisyon eÅŸleÅŸtirme - slot pozisyonuna gÃ¶re
            // Defans: CB, LB, RB, LWB, RWB
            if (['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(slotPos)) {
              return playerPos.includes('D') || playerPos.includes('DEF') || playerPos.includes('BACK') || playerPos === 'CB' || playerPos === 'LB' || playerPos === 'RB';
            }
            // Orta saha: CM, CDM, CAM, LM, RM, DM, AM
            if (['CM', 'CDM', 'CAM', 'LM', 'RM', 'DM', 'AM'].includes(slotPos)) {
              return playerPos.includes('M') || playerPos.includes('MID') || playerPos === 'CM' || playerPos === 'CDM' || playerPos === 'CAM';
            }
            // Forvet: ST, LW, RW, CF
            if (['ST', 'LW', 'RW', 'CF'].includes(slotPos)) {
              return playerPos.includes('F') || playerPos.includes('ATT') || playerPos.includes('ST') || playerPos.includes('W') || playerPos === 'LW' || playerPos === 'RW';
            }
            
            return true; // EÅŸleÅŸme yoksa herkes aday
          });
          
          // Rating'e gÃ¶re sÄ±rala ve en iyiyi seÃ§
          candidates.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
          
          if (candidates.length > 0) {
            autoPlayers[slotIndex] = candidates[0];
            usedPlayerIds.add(candidates[0].id);
            console.log(`âœ… Slot ${slotIndex} (${slotPos}): ${candidates[0].name}`);
          } else {
            // EÅŸleÅŸen oyuncu bulunamadÄ±ysa, kalan herhangi bir oyuncuyu ata
            const remaining = attackTeamPlayers.filter((p: any) => !usedPlayerIds.has(p.id) && !isGoalkeeperPlayer(p));
            if (remaining.length > 0) {
              remaining.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
              autoPlayers[slotIndex] = remaining[0];
              usedPlayerIds.add(remaining[0].id);
              console.log(`âš ï¸ Slot ${slotIndex} (${slotPos}): Fallback -> ${remaining[0].name}`);
            }
          }
        });
        
        setAttackFormation(formation.id);
        setAttackPlayers(autoPlayers);
        const defenseForm = formations.find(f => f.id === popularDefenseFormationId) || formation;
        const defenseAutoPlayers: Record<number, any | null> = {};
        const defUsed = new Set<number>();
        (defenseForm.positions || formation.positions).forEach((positionType: string, slotIndex: number) => {
          const slotPos = (positionType || '').toUpperCase();
          let candidates = attackTeamPlayers.filter((p: any) => {
            if (defUsed.has(p.id)) return false;
            const playerPos = (p.position || p.pos || '').toUpperCase();
            if (slotPos === 'GK' || slotPos === 'G') return isGoalkeeperPlayer(p);
            if (isGoalkeeperPlayer(p)) return false;
            if (['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(slotPos)) return playerPos.includes('D') || playerPos.includes('DEF') || playerPos === 'CB' || playerPos === 'LB' || playerPos === 'RB';
            if (['CM', 'CDM', 'CAM', 'LM', 'RM', 'DM', 'AM'].includes(slotPos)) return playerPos.includes('M') || playerPos === 'CM' || playerPos === 'CDM' || playerPos === 'CAM';
            if (['ST', 'LW', 'RW', 'CF'].includes(slotPos)) return playerPos.includes('F') || playerPos.includes('ST') || playerPos.includes('W') || playerPos === 'LW' || playerPos === 'RW';
            return true;
          });
          candidates.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
          if (candidates.length > 0) {
            defenseAutoPlayers[slotIndex] = candidates[0];
            defUsed.add(candidates[0].id);
          } else {
            const remaining = attackTeamPlayers.filter((p: any) => !defUsed.has(p.id) && !isGoalkeeperPlayer(p));
            if (remaining.length > 0) {
              remaining.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
              defenseAutoPlayers[slotIndex] = remaining[0];
              defUsed.add(remaining[0].id);
            }
          }
        });
        setDefenseFormation(defenseForm.id);
        setDefensePlayers(defenseAutoPlayers);
        setAutoFormationApplied(true);
        
        const key = squadStorageKey;
        const raw = await AsyncStorage.getItem(key);
        const existing = raw ? JSON.parse(raw) : {};
        await AsyncStorage.setItem(key, JSON.stringify({
          ...existing,
          matchId,
          attackFormation: formation.id,
          attackPlayers: autoPlayers,
          defenseFormation: defenseForm.id,
          defensePlayers: defenseAutoPlayers,
          isAutoApplied: true,
        }));
        
        console.log('âœ… PopÃ¼ler formasyon ve kadro otomatik uygulandÄ± (Atak:', formation.id, 'Defans:', defenseForm.id, ')');
      } catch (err) {
        console.error('âŒ Auto formation apply error:', err);
      }
    };
    
    // KÄ±sa bir gecikme ile uygula (oyuncularÄ±n yÃ¼klenmesini bekle)
    const timer = setTimeout(applyPopularFormation, 500);
    return () => clearTimeout(timer);
  }, [isMatchLive, stateRestored, attackFormation, autoFormationApplied, attackTeamPlayers, squadStorageKey, matchId, hasPrediction]);

  // âœ… "Tahminlerinizi TamamlayÄ±n" popup'Ä± kaldÄ±rÄ±ldÄ±
  // MaÃ§ baÅŸladÄ±ktan sonra sayfayÄ± aÃ§anlar iÃ§in normal "Ä°lk 11" popup'Ä± gÃ¶sterilir
  // KullanÄ±cÄ± popup'Ä± kapatÄ±nca kadro sekmesinde Ã§alÄ±ÅŸmaya devam edebilir
  // Ä°sterse tahmin, canlÄ±, istatistik sekmesine geÃ§ebilir

  // âœ… Ä°lk 11 popup'Ä± zaten gÃ¶sterildi mi? (tekrar aÃ§Ä±lmasÄ±nÄ± Ã¶nlemek iÃ§in)
  // âš ï¸ Parent component'ten gelen prop kullanÄ±lÄ±yor - sekme deÄŸiÅŸse bile korunur
  // Local ref sadece bu session iÃ§indeki durumu takip eder
  const localPopupShownRef = React.useRef(false);
  
  // âœ… KULLANICI TERCÄ°H Ä°STATÄ°STÄ°KLERÄ°NÄ° YÃœKLE ve Ä°LK 11 POPUP'INI GÃ–STER
  // MaÃ§ canlÄ± veya bitmiÅŸse ve kullanÄ±cÄ± tahmin yapmamÄ±ÅŸsa, otomatik kadro oluÅŸtur
  // âœ… Sekme deÄŸiÅŸince MatchSquad yeniden mount olur; popup zaten gÃ¶sterildiyse (startingXIPopupShown)
  //    sadece veriyi yÃ¼kle (autoGeneratedSquad, startingXIPlayers) â€“ popup'Ä± tekrar aÃ§ma, sahanÄ±n altÄ± boÅŸ kalmasÄ±n
  React.useEffect(() => {
    if (!(isMatchLive || isMatchFinished) || !stateRestored) return;
    // âœ… hasPrediction kontrolÃ¼ kaldÄ±rÄ±ldÄ± - istatistikler her zaman yÃ¼klenecek
    if (showStartingXIPopup) return; // Popup zaten gÃ¶steriliyor, tekrar yÃ¼kleme
    // âœ… Zaten yÃ¼klenmiÅŸse tekrar yÃ¼kleme (sonsuz dÃ¶ngÃ¼ Ã¶nleme)
    if (autoGeneratedSquad && userPreferenceStats) return;
    
    const fixtureId = Number(matchId);
    const isMockMatch = fixtureId === MOCK_MATCH_IDS.REAL_BARCA || fixtureId === MOCK_MATCH_IDS.GS_FB || fixtureId === MOCK_MATCH_IDS.TEST_6H;
    
    // KullanÄ±cÄ±nÄ±n takÄ±mÄ±nÄ± bul (predictionTeamId veya favoriteTeamIds'den)
    const userTeamId = predictionTeamId || (isMockMatch ? getMockUserTeamId(fixtureId) : null) || (favoriteTeamIds.length > 0 ? favoriteTeamIds[0] : null);
    
    if (!userTeamId) return;
    
    // Ä°lk 11 oyuncularÄ± al (lineups'tan) - API'den Ã§ekilmiÅŸ olmalÄ±
    const teamLineup = lineups?.find((l: any) => l.team?.id === userTeamId);
    if (!teamLineup?.startXI || teamLineup.startXI.length === 0) {
      console.log('âš ï¸ Ä°lk 11 henÃ¼z yÃ¼klenmedi, bekleniyor...');
      return; // Lineups henÃ¼z yÃ¼klenmemiÅŸ, bekleyelim
    }
    
    // Ä°lk 11'i forma numarasÄ±na gÃ¶re sÄ±rala (kaleci en Ã¼stte)
    const sortedStartXI = [...teamLineup.startXI].sort((a: any, b: any) => {
      const aNum = a.player?.number || 99;
      const bNum = b.player?.number || 99;
      const aIsGK = isGoalkeeperPlayer(a.player);
      const bIsGK = isGoalkeeperPlayer(b.player);
      
      // Kaleci her zaman en Ã¼stte
      if (aIsGK && !bIsGK) return -1;
      if (!aIsGK && bIsGK) return 1;
      
      // DiÄŸerleri forma numarasÄ±na gÃ¶re
      return aNum - bNum;
    });
    
    setStartingXIPlayers(sortedStartXI);
    
    // Tercih istatistiklerini yÃ¼kle (mock veya gerÃ§ek maÃ§)
    if (isMockMatch) {
      const prefs = getUserPreferenceStats(fixtureId, userTeamId);
      if (prefs) {
        setUserPreferenceStats(prefs);
        console.log('ğŸ“Š KullanÄ±cÄ± tercih istatistikleri yÃ¼klendi:', prefs.teamName, '- Toplam:', prefs.totalUsers, 'kullanÄ±cÄ±');
      }
    } else {
      // âœ… GerÃ§ek maÃ§lar iÃ§in de varsayÄ±lan tercih istatistikleri oluÅŸtur
      const teamName = teamLineup?.team?.name || matchData?.homeTeam?.name || 'TakÄ±m';
      const defaultPrefs: UserPreferenceStats = {
        teamName,
        totalUsers: Math.floor(Math.random() * 5000) + 1000,
        attackFormation: {
          topFormation: '4-3-3',
          percentage: 45,
          stats: [
            { formation: '4-3-3', count: 2250, percentage: 45 },
            { formation: '4-2-3-1', count: 1500, percentage: 30 },
            { formation: '4-4-2', count: 750, percentage: 15 },
            { formation: '3-5-2', count: 500, percentage: 10 },
          ],
        },
        defenseFormation: {
          topFormation: '4-4-2',
          percentage: 40,
          stats: [
            { formation: '4-4-2', count: 2000, percentage: 40 },
            { formation: '4-3-3', count: 1500, percentage: 30 },
            { formation: '5-3-2', count: 1000, percentage: 20 },
            { formation: '5-4-1', count: 500, percentage: 10 },
          ],
        },
        positions: {},
      };
      setUserPreferenceStats(defaultPrefs);
      console.log('ğŸ“Š GerÃ§ek maÃ§ - VarsayÄ±lan tercih istatistikleri oluÅŸturuldu:', teamName);
    }
    
    // Popup'Ä± sadece ilk kez gÃ¶ster; sekme deÄŸiÅŸip geri gelince tekrar aÃ§ma
    const popupAlreadyShown = startingXIPopupShown || localPopupShownRef.current;
    if (!popupAlreadyShown) {
      setShowStartingXIPopup(true);
      localPopupShownRef.current = true;
      onStartingXIPopupShown?.();
    }
    
    const startXI = sortedStartXI.map((p: any) => ({
      player: {
        id: p.player?.id || 0,
        name: p.player?.name || '',
        number: p.player?.number ?? p.player?.shirt_number ?? p.player?.jersey_number ?? 0,
        pos: p.player?.pos || p.player?.position || '',
      },
    }));
    
    // Otomatik kadro oluÅŸtur (mock veya gerÃ§ek maÃ§)
    if (isMockMatch) {
      const autoSquad = generateAutoSquad(fixtureId, userTeamId, startXI);
      if (autoSquad) {
        setAutoGeneratedSquad(autoSquad);
        console.log('ğŸ¯ Otomatik kadro oluÅŸturuldu:', autoSquad.teamName);
        console.log('   Atak:', autoSquad.attackFormation.formation, '(' + autoSquad.attackFormation.percentage + '%)');
        console.log('   Defans:', autoSquad.defenseFormation.formation, '(' + autoSquad.defenseFormation.percentage + '%)');
      }
    } else {
      // âœ… GerÃ§ek maÃ§lar iÃ§in de varsayÄ±lan otomatik kadro oluÅŸtur
      const teamName = teamLineup?.team?.name || matchData?.homeTeam?.name || 'TakÄ±m';
      const defaultAutoSquad: AutoGeneratedSquad = {
        teamName,
        attackFormation: { formation: '4-3-3', percentage: 45 },
        defenseFormation: { formation: '4-4-2', percentage: 40 },
        players: startXI.map(p => ({
          id: p.player.id,
          name: p.player.name,
          position: p.player.pos,
          rating: Math.floor(Math.random() * 15) + 75,
        })),
      };
      setAutoGeneratedSquad(defaultAutoSquad);
      console.log('ğŸ¯ GerÃ§ek maÃ§ - VarsayÄ±lan otomatik kadro oluÅŸturuldu:', teamName);
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isMatchLive, isMatchFinished, stateRestored, hasPrediction, matchId, predictionTeamId, favoriteTeamIds, lineups, startingXIPopupShown]);

  // âœ… autoGeneratedSquad set edildiÄŸinde formasyonu ve oyuncularÄ± otomatik uygula
  // Popup kapatÄ±lmadan sekme deÄŸiÅŸtirilirse de Ã§alÄ±ÅŸÄ±r
  React.useEffect(() => {
    // CanlÄ± veya biten maÃ§, tahmin yapÄ±lmamÄ±ÅŸ, autoGeneratedSquad var ve henÃ¼z uygulanmamÄ±ÅŸsa
    if (!(isMatchLive || isMatchFinished) || hasPrediction || !autoGeneratedSquad || autoSquadApplied) return;
    if (!startingXIPlayers || startingXIPlayers.length === 0) return;
    
    console.log('ğŸ”„ AutoGeneratedSquad otomatik uygulanÄ±yor...');
    
    // Topluluk verilerine gÃ¶re formasyonlarÄ± uygula
    const attackForm = formations.find(f => f.id === autoGeneratedSquad.attackFormation.formation) || formations[0];
    const defenseForm = formations.find(f => f.id === autoGeneratedSquad.defenseFormation.formation) || formations[0];
    
    if (!attackForm || !defenseForm) {
      console.log('âš ï¸ Formasyon bulunamadÄ±');
      return;
    }
    
    setAttackFormation(attackForm.id);
    setDefenseFormation(defenseForm.id);
    
    // Pozisyon mapping oluÅŸtur - LM ve RM ayrÄ± olarak eklendi
    const positionToSlotMap: Record<string, number[]> = {
      'GK': [], 'RB': [], 'CB1': [], 'CB2': [], 'LB': [],
      'CM1': [], 'CM2': [], 'CM3': [], 'AM': [], 'LW': [], 'LM': [], 'ST': [], 'RW': [], 'RM': [],
    };
    
    attackForm.positions.forEach((pos: string, slotIdx: number) => {
      const normalized = normalizePosition(pos);
      if (normalized === 'GK') positionToSlotMap['GK'].push(slotIdx);
      else if (normalized.includes('RB') || normalized.includes('RWB')) positionToSlotMap['RB'].push(slotIdx);
      else if (normalized.includes('CB')) {
        if (positionToSlotMap['CB1'].length === 0) positionToSlotMap['CB1'].push(slotIdx);
        else positionToSlotMap['CB2'].push(slotIdx);
      }
      else if (normalized.includes('LB') || normalized.includes('LWB')) positionToSlotMap['LB'].push(slotIdx);
      else if (normalized === 'AM' || normalized === 'CAM' || normalized === 'ACM') {
        positionToSlotMap['AM'].push(slotIdx);
      }
      else if (normalized.includes('CM') || normalized.includes('CDM')) {
        if (positionToSlotMap['CM1'].length === 0) positionToSlotMap['CM1'].push(slotIdx);
        else if (positionToSlotMap['CM2'].length === 0) positionToSlotMap['CM2'].push(slotIdx);
        else positionToSlotMap['CM3'].push(slotIdx);
      }
      else if (normalized === 'LM') positionToSlotMap['LM'].push(slotIdx);
      else if (normalized === 'RM') positionToSlotMap['RM'].push(slotIdx);
      else if (normalized.includes('LW')) positionToSlotMap['LW'].push(slotIdx);
      else if (normalized.includes('ST') || normalized.includes('CF')) positionToSlotMap['ST'].push(slotIdx);
      else if (normalized.includes('RW')) positionToSlotMap['RW'].push(slotIdx);
    });
    
    // Defans iÃ§in ayrÄ± slot map - LM ve RM ayrÄ± olarak eklendi
    const defensePositionToSlotMap: Record<string, number[]> = {
      'GK': [], 'RB': [], 'CB1': [], 'CB2': [], 'CB3': [], 'LB': [],
      'CM1': [], 'CM2': [], 'CM3': [], 'CM4': [], 'CM5': [], 'AM': [], 'DM': [],
      'LW': [], 'LM': [], 'ST': [], 'RW': [], 'RM': [],
    };
    
    defenseForm.positions.forEach((pos: string, slotIdx: number) => {
      const normalized = normalizePosition(pos);
      if (normalized === 'GK') defensePositionToSlotMap['GK'].push(slotIdx);
      else if (normalized.includes('RB') || normalized.includes('RWB')) defensePositionToSlotMap['RB'].push(slotIdx);
      else if (normalized.includes('CB')) {
        if (defensePositionToSlotMap['CB1'].length === 0) defensePositionToSlotMap['CB1'].push(slotIdx);
        else if (defensePositionToSlotMap['CB2'].length === 0) defensePositionToSlotMap['CB2'].push(slotIdx);
        else defensePositionToSlotMap['CB3'].push(slotIdx);
      }
      else if (normalized.includes('LB') || normalized.includes('LWB')) defensePositionToSlotMap['LB'].push(slotIdx);
      else if (normalized === 'AM' || normalized === 'CAM' || normalized === 'ACM') {
        defensePositionToSlotMap['AM'].push(slotIdx);
      }
      else if (normalized === 'DM' || normalized === 'CDM') {
        defensePositionToSlotMap['DM'].push(slotIdx);
      }
      else if (normalized.includes('CM')) {
        if (defensePositionToSlotMap['CM1'].length === 0) defensePositionToSlotMap['CM1'].push(slotIdx);
        else if (defensePositionToSlotMap['CM2'].length === 0) defensePositionToSlotMap['CM2'].push(slotIdx);
        else if (defensePositionToSlotMap['CM3'].length === 0) defensePositionToSlotMap['CM3'].push(slotIdx);
        else if (defensePositionToSlotMap['CM4'].length === 0) defensePositionToSlotMap['CM4'].push(slotIdx);
        else defensePositionToSlotMap['CM5'].push(slotIdx);
      }
      else if (normalized === 'LM') defensePositionToSlotMap['LM'].push(slotIdx);
      else if (normalized === 'RM') defensePositionToSlotMap['RM'].push(slotIdx);
      else if (normalized.includes('LW')) defensePositionToSlotMap['LW'].push(slotIdx);
      else if (normalized.includes('ST') || normalized.includes('CF')) defensePositionToSlotMap['ST'].push(slotIdx);
      else if (normalized.includes('RW')) defensePositionToSlotMap['RW'].push(slotIdx);
    });
    
    // Pozisyon mapping helper - LM ve RM ayrÄ± olarak eklendi
    const getAttackMapKeys = (position: string): string[] => {
      const p = position.toUpperCase();
      if (p === 'GK') return ['GK'];
      if (p === 'RB' || p === 'RWB') return ['RB'];
      if (p === 'LB' || p === 'LWB') return ['LB'];
      if (p === 'CB' || p === 'CB1') return ['CB1', 'CB2'];
      if (p === 'CB2') return ['CB2', 'CB1'];
      if (p === 'CM' || p === 'CDM' || p === 'DM' || p === 'CM1') return ['CM1', 'CM2', 'CM3'];
      if (p === 'CM2') return ['CM2', 'CM1', 'CM3'];
      if (p === 'CM3') return ['CM3', 'CM1', 'CM2'];
      if (p === 'AM' || p === 'CAM' || p === 'ACM') return ['AM'];
      if (p === 'LM') return ['LM', 'LW', 'CM1', 'CM2'];
      if (p === 'RM') return ['RM', 'RW', 'CM1', 'CM2'];
      if (p === 'LW') return ['LW', 'LM', 'CM1'];
      if (p === 'RW') return ['RW', 'RM', 'CM1'];
      if (p === 'ST' || p === 'CF') return ['ST'];
      return [position];
    };
    
    const getDefenseMapKeys = (position: string): string[] => {
      const p = position.toUpperCase();
      if (p === 'GK') return ['GK'];
      if (p === 'RB' || p === 'RWB') return ['RB'];
      if (p === 'LB' || p === 'LWB') return ['LB'];
      if (p === 'CB' || p === 'CB1') return ['CB1', 'CB2', 'CB3'];
      if (p === 'CB2') return ['CB2', 'CB1', 'CB3'];
      if (p === 'CB3') return ['CB3', 'CB1', 'CB2'];
      if (p === 'CM' || p === 'CDM' || p === 'DM' || p === 'CM1') return ['CM1', 'CM2', 'CM3', 'CM4', 'CM5', 'DM'];
      if (p === 'CM2') return ['CM2', 'CM1', 'CM3', 'CM4', 'CM5', 'DM'];
      if (p === 'CM3') return ['CM3', 'CM1', 'CM2', 'CM4', 'CM5', 'DM'];
      if (p === 'AM' || p === 'CAM' || p === 'ACM') return ['AM'];
      if (p === 'LM') return ['LM', 'LW', 'CM1', 'CM2', 'CM3'];
      if (p === 'RM') return ['RM', 'RW', 'CM1', 'CM2', 'CM3'];
      if (p === 'LW') return ['LW', 'LM', 'CM1', 'CM2'];
      if (p === 'RW') return ['RW', 'RM', 'CM1', 'CM2'];
      if (p === 'ST' || p === 'CF') return ['ST'];
      return [position];
    };
    
    // OyuncularÄ± pozisyonlara yerleÅŸtir
    const attackPlayersMap: Record<number, any> = {};
    const defensePlayersMap: Record<number, any> = {};
    const usedAttackSlots = new Set<number>();
    const usedDefenseSlots = new Set<number>();
    
    autoGeneratedSquad.positions.forEach((pos) => {
      const player = startingXIPlayers.find((p: any) => p.player?.id === pos.player.id);
      if (!player) return;
      
      // Atak slotu bul
      const attackKeys = getAttackMapKeys(pos.position);
      for (const key of attackKeys) {
        const slots = positionToSlotMap[key] || [];
        const availableSlot = slots.find(s => !usedAttackSlots.has(s));
        if (availableSlot !== undefined) {
          usedAttackSlots.add(availableSlot);
          attackPlayersMap[availableSlot] = {
            ...player.player,
            rating: player.player?.rating || 75,
            position: pos.position,
          };
          break;
        }
      }
      
      // Defans slotu bul
      const defenseKeys = getDefenseMapKeys(pos.position);
      for (const key of defenseKeys) {
        const defSlots = defensePositionToSlotMap[key] || [];
        const availableDefSlot = defSlots.find(s => !usedDefenseSlots.has(s));
        if (availableDefSlot !== undefined) {
          usedDefenseSlots.add(availableDefSlot);
          defensePlayersMap[availableDefSlot] = {
            ...player.player,
            rating: player.player?.rating || 75,
            position: pos.position,
          };
          break;
        }
      }
    });
    
    console.log('ğŸ“‹ Auto atak slotlarÄ±:', Object.keys(attackPlayersMap).length, '/ 11');
    console.log('ğŸ“‹ Auto defans slotlarÄ±:', Object.keys(defensePlayersMap).length, '/ 11');
    
    // âœ… Eksik slotlarÄ± doldur - yerleÅŸemeyen oyuncularÄ± boÅŸ slotlara yerleÅŸtir
    if (Object.keys(defensePlayersMap).length < 11) {
      const allDefenseSlots = Array.from({ length: 11 }, (_, i) => i);
      const emptyDefenseSlots = allDefenseSlots.filter(s => !usedDefenseSlots.has(s));
      const unplacedPlayers = startingXIPlayers.filter((p: any) => 
        !Object.values(defensePlayersMap).some((dp: any) => dp?.id === p.player?.id)
      );
      
      console.log('âš ï¸ Eksik defans slotlarÄ±:', emptyDefenseSlots);
      console.log('âš ï¸ YerleÅŸemeyen oyuncular:', unplacedPlayers.map((p: any) => p.player?.name));
      
      emptyDefenseSlots.forEach((slot, idx) => {
        if (unplacedPlayers[idx]) {
          defensePlayersMap[slot] = {
            ...unplacedPlayers[idx].player,
            rating: unplacedPlayers[idx].player?.rating || 75,
            position: unplacedPlayers[idx].player?.pos || 'SUB',
          };
          console.log('âœ… Eksik slot dolduruldu:', slot, 'â†’', unplacedPlayers[idx].player?.name);
        }
      });
    }
    
    // âœ… Atak iÃ§in de aynÄ± kontrol
    if (Object.keys(attackPlayersMap).length < 11) {
      const allAttackSlots = Array.from({ length: 11 }, (_, i) => i);
      const emptyAttackSlots = allAttackSlots.filter(s => !usedAttackSlots.has(s));
      const unplacedAttackPlayers = startingXIPlayers.filter((p: any) => 
        !Object.values(attackPlayersMap).some((ap: any) => ap?.id === p.player?.id)
      );
      
      emptyAttackSlots.forEach((slot, idx) => {
        if (unplacedAttackPlayers[idx]) {
          attackPlayersMap[slot] = {
            ...unplacedAttackPlayers[idx].player,
            rating: unplacedAttackPlayers[idx].player?.rating || 75,
            position: unplacedAttackPlayers[idx].player?.pos || 'SUB',
          };
        }
      });
    }
    
    console.log('ğŸ“‹ Final atak slotlarÄ±:', Object.keys(attackPlayersMap).length, '/ 11');
    console.log('ğŸ“‹ Final defans slotlarÄ±:', Object.keys(defensePlayersMap).length, '/ 11');
    
    setAttackPlayers(attackPlayersMap);
    setDefensePlayers(defensePlayersMap);
    setEditingMode('attack');
    setViewSource('community');
    setDefenseConfirmShown(true);
    setAutoSquadApplied(true);
    
    console.log('âœ… AutoGeneratedSquad otomatik uygulandÄ±');
  }, [isMatchLive, hasPrediction, autoGeneratedSquad, startingXIPlayers, autoSquadApplied]);

  // âœ… BÄ°TEN MAÃ‡: Ä°lk 11'i en Ã§ok tercih edilen atak/defans formasyonuna gÃ¶re yerleÅŸtir (lineups startXI)
  // âœ… autoGeneratedSquad varsa onun formasyonlarÄ±nÄ± kullan, yoksa API'den Ã§ek
  React.useEffect(() => {
    if (!isMatchFinished || !stateRestored || attackTeamPlayers.length < 11 || finishedFormationApplied) return;
    // âœ… autoGeneratedSquad zaten varsa bu useEffect'i atla - autoGeneratedSquad useEffect'i Ã§alÄ±ÅŸacak
    if (autoGeneratedSquad) return;
    
    const applyFinishedMatchFormation = async () => {
      try {
        let popularAttackFormationId = '4-3-3';
        let popularDefenseFormationId = '4-3-3';
        try {
          const popularRes = await squadPredictionsApi.getPopularFormations('attack');
          if (popularRes.success && popularRes.data && popularRes.data.length > 0) {
            popularAttackFormationId = popularRes.data[0].formation;
          }
          const defRes = await squadPredictionsApi.getPopularFormations('defense');
          if (defRes?.success && defRes.data?.length > 0) {
            popularDefenseFormationId = defRes.data[0].formation;
          }
        } catch (_) {
          // VarsayÄ±lan 4-3-3
        }
        const attackForm = formations.find(f => f.id === popularAttackFormationId) || formations.find(f => f.id === '4-3-3');
        const defenseForm = formations.find(f => f.id === popularDefenseFormationId) || formations.find(f => f.id === '4-3-3');
        if (!attackForm) return;
        
        setAttackFormation(attackForm.id);
        setDefenseFormation(defenseForm?.id || attackForm.id);
        
        const autoAttackPlayers: Record<number, any | null> = {};
        const autoDefensePlayers: Record<number, any | null> = {};
        const usedPlayerIds = new Set<number>();
        
        // Atak formasyonu iÃ§in oyuncularÄ± yerleÅŸtir
        attackForm.positions.forEach((positionType: string, slotIndex: number) => {
          const slotPos = (positionType || '').toUpperCase();
          let candidates = attackTeamPlayers.filter((p: any) => {
            if (usedPlayerIds.has(p.id)) return false;
            const playerPos = (p.position || p.pos || '').toUpperCase();
            if (slotPos === 'GK' || slotPos === 'G') return isGoalkeeperPlayer(p);
            if (isGoalkeeperPlayer(p)) return false;
            if (['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(slotPos)) {
              return playerPos.includes('D') || playerPos.includes('DEF') || playerPos === 'CB' || playerPos === 'LB' || playerPos === 'RB';
            }
            if (['CM', 'CDM', 'CAM', 'LM', 'RM', 'DM', 'AM'].includes(slotPos)) {
              return playerPos.includes('M') || playerPos === 'CM' || playerPos === 'CDM' || playerPos === 'CAM';
            }
            if (['ST', 'LW', 'RW', 'CF'].includes(slotPos)) {
              return playerPos.includes('F') || playerPos.includes('ST') || playerPos.includes('W') || playerPos === 'LW' || playerPos === 'RW';
            }
            return true;
          });
          candidates.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
          if (candidates.length > 0) {
            autoAttackPlayers[slotIndex] = candidates[0];
            usedPlayerIds.add(candidates[0].id);
          } else {
            const remaining = attackTeamPlayers.filter((p: any) => !usedPlayerIds.has(p.id) && !isGoalkeeperPlayer(p));
            if (remaining.length > 0) {
              remaining.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
              autoAttackPlayers[slotIndex] = remaining[0];
              usedPlayerIds.add(remaining[0].id);
            }
          }
        });
        
        // Defans formasyonu iÃ§in oyuncularÄ± yerleÅŸtir
        if (defenseForm) {
          const usedDefensePlayerIds = new Set<number>();
          defenseForm.positions.forEach((positionType: string, slotIndex: number) => {
            const slotPos = (positionType || '').toUpperCase();
            let candidates = attackTeamPlayers.filter((p: any) => {
              if (usedDefensePlayerIds.has(p.id)) return false;
              const playerPos = (p.position || p.pos || '').toUpperCase();
              if (slotPos === 'GK' || slotPos === 'G') return isGoalkeeperPlayer(p);
              if (isGoalkeeperPlayer(p)) return false;
              if (['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(slotPos)) {
                return playerPos.includes('D') || playerPos.includes('DEF') || playerPos === 'CB' || playerPos === 'LB' || playerPos === 'RB';
              }
              if (['CM', 'CDM', 'CAM', 'LM', 'RM', 'DM', 'AM'].includes(slotPos)) {
                return playerPos.includes('M') || playerPos === 'CM' || playerPos === 'CDM' || playerPos === 'CAM';
              }
              if (['ST', 'LW', 'RW', 'CF'].includes(slotPos)) {
                return playerPos.includes('F') || playerPos.includes('ST') || playerPos.includes('W') || playerPos === 'LW' || playerPos === 'RW';
              }
              return true;
            });
            candidates.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
            if (candidates.length > 0) {
              autoDefensePlayers[slotIndex] = candidates[0];
              usedDefensePlayerIds.add(candidates[0].id);
            } else {
              const remaining = attackTeamPlayers.filter((p: any) => !usedDefensePlayerIds.has(p.id) && !isGoalkeeperPlayer(p));
              if (remaining.length > 0) {
                remaining.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
                autoDefensePlayers[slotIndex] = remaining[0];
                usedDefensePlayerIds.add(remaining[0].id);
              }
            }
          });
        }
        
        setAttackPlayers(autoAttackPlayers);
        setDefensePlayers(defenseForm ? autoDefensePlayers : autoAttackPlayers);
        setFinishedFormationApplied(true);
      } catch (err) {
        console.warn('Finished match formation apply failed', err);
        setFinishedFormationApplied(true);
      }
    };
    
    const t = setTimeout(applyFinishedMatchFormation, 400);
    return () => clearTimeout(t);
  }, [isMatchFinished, stateRestored, attackTeamPlayers, finishedFormationApplied, autoGeneratedSquad]);

  // âœ… GERÃ‡EK Ä°LK 11: Lineup API'den gelen formation ve startXI'yÄ± state'e yaz
  // KÄ°LÄ°TLÄ° KURAL: MaÃ§ baÅŸlamadan (NS) gerÃ§ek ilk 11 state'e yazÄ±lmaz
  // Sadece maÃ§ canlÄ± veya bitmiÅŸ ise gerÃ§ek ilk 11 gÃ¶sterilir
  React.useEffect(() => {
    if (!lineups || lineups.length === 0) return;
    if (!isMatchLive && !isMatchFinished) return;
    
    // Favori takÄ±mÄ±n lineup'Ä±nÄ± bul
    const targetLineup = lineups.find((l: any) => l.team?.id === attackTeamId) || lineups[0];
    if (!targetLineup?.startXI || targetLineup.startXI.length < 11) return;
    
    // API formation string'ini (e.g. "3-5-2") al veya varsayÄ±lan
    const apiFormation = targetLineup.formation || '4-3-3';
    const formObj = formations.find(f => f.id === apiFormation) || formations.find(f => f.id === '4-3-3');
    if (!formObj) return;
    
    // Ä°lk 11 oyuncularÄ± formasyon pozisyonlarÄ±na yerleÅŸtir
    const actualPlayers: Record<number, any> = {};
    const usedIds = new Set<number>();
    
    formObj.positions.forEach((posType: string, slotIdx: number) => {
      const slotPos = (posType || '').toUpperCase();
      const startXI = targetLineup.startXI.map((item: any) => {
        const p = item.player || item;
        return { ...p, position: normalizePosition(p.pos || p.position), rating: p.rating || 75, number: p.number ?? p.shirt_number ?? p.jersey_number };
      });
      
      let candidates = startXI.filter((p: any) => {
        if (usedIds.has(p.id)) return false;
        const pPos = (p.position || '').toUpperCase();
        if (slotPos === 'GK' || slotPos === 'G') return isGoalkeeperPlayer(p);
        if (isGoalkeeperPlayer(p)) return false;
        if (['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(slotPos)) return pPos.includes('D') || pPos === 'CB' || pPos === 'LB' || pPos === 'RB';
        if (['CM', 'CDM', 'CAM', 'LM', 'RM', 'DM', 'AM'].includes(slotPos)) return pPos.includes('M') || pPos === 'CM' || pPos === 'CDM' || pPos === 'CAM';
        if (['ST', 'LW', 'RW', 'CF'].includes(slotPos)) return pPos.includes('F') || pPos.includes('ST') || pPos.includes('W');
        return true;
      });
      candidates.sort((a: any, b: any) => (b.rating || 75) - (a.rating || 75));
      if (candidates.length > 0) {
        actualPlayers[slotIdx] = candidates[0];
        usedIds.add(candidates[0].id);
      } else {
        const remaining = startXI.filter((p: any) => !usedIds.has(p.id) && !isGoalkeeperPlayer(p));
        if (remaining.length > 0) {
          actualPlayers[slotIdx] = remaining[0];
          usedIds.add(remaining[0].id);
        }
      }
    });
    
    setActualAttackFormation(formObj.id);
    setActualAttackPlayers(actualPlayers);
    // GerÃ§ek maÃ§ta defans formasyonu ayrÄ± gelmez, aynÄ± lineup'Ä± kullan
    setActualDefenseFormation(formObj.id);
    setActualDefensePlayers(actualPlayers);
    
    console.log('âœ… GerÃ§ek Ä°lk 11 yÃ¼klendi:', formObj.id, Object.keys(actualPlayers).length, 'oyuncu');
  }, [lineups, attackTeamId, isMatchLive, isMatchFinished]);

  React.useEffect(() => {
    runRestore();
  }, [squadStorageKey]);

  const prevIsVisibleRef = React.useRef<boolean>(false);
  // âœ… Kadro sekmesine geÃ§ildiÄŸinde tekrar yÃ¼kle; sayfa/tab deÄŸiÅŸip geri dÃ¶nÃ¼lÃ¼nce sadece o an Atak'ta baÅŸla (Defans'ta kalmayÄ± bozma)
  React.useEffect(() => {
    if (isVisible) {
      runRestore();
      const becameVisible = !prevIsVisibleRef.current;
      prevIsVisibleRef.current = true;
      if (becameVisible) setEditingMode('attack'); // Sadece sekme gÃ¶rÃ¼nÃ¼r olduÄŸu anda Atak'a dÃ¶n
    } else {
      prevIsVisibleRef.current = false;
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps -- runRestore deÄŸiÅŸince tekrar Atak'a dÃ¶nmesin; sadece isVisible deÄŸiÅŸince
  }, [isVisible]);
  
  // âœ… Her state deÄŸiÅŸikliÄŸinde AsyncStorage'a kaydet (sekme deÄŸiÅŸimlerinde korunsun)
  // Kadro tamamlandÄ±ysa (isCompleted) attackPlayersArray/defensePlayersArray asla silinmez.
  // âœ… Oynanan/canlÄ± maÃ§ta atak diziliÅŸi asla kaybolmasÄ±n: existing'de geÃ§erli atak varsa boÅŸ/eksik state ile ezme.
  React.useEffect(() => {
    if (!stateRestored) return; // Ä°lk yÃ¼klemede kaydetme
    if (savingRef.current) return;
    
    const savePartialState = async () => {
      try {
        const key = squadStorageKey;
        const raw = await AsyncStorage.getItem(key);
        const existing = raw ? JSON.parse(raw) : {};
        // âœ… Tamamla sonrasÄ± (isCompleted) storage'Ä± EZME â€“ sadece handleComplete yazsÄ±n, sÄ±ra bozulmasÄ±n
        if (existing.isCompleted === true) return;
        const wasCompleted = existing.isCompleted === true;
        const existingAttackCount = existing.attackPlayers && typeof existing.attackPlayers === 'object'
          ? Object.keys(existing.attackPlayers).filter((k: string) => existing.attackPlayers[k]).length
          : 0;
        const existingHasAttackArray = existing.attackPlayersArray && Array.isArray(existing.attackPlayersArray) && existing.attackPlayersArray.length >= 11;
        const currentAttackCount = Object.keys(attackPlayers).filter(k => attackPlayers[parseInt(k)]).length;
        // Restore sonrasÄ± ilk save: state henÃ¼z gÃ¼ncellenmemiÅŸse (current boÅŸ, existing dolu) mevcut kadroyu koru
        // âœ… KullanÄ±cÄ± deÄŸiÅŸiklik yaptÄ±ysa (hasModifiedSinceUnlock) preserve yapma - kullanÄ±cÄ±nÄ±n deÄŸiÅŸikliklerini koru
        const preserveRestored = wasCompleted && existingAttackCount >= 11 && currentAttackCount < 11 && !hasModifiedSinceUnlock;
        // âœ… CanlÄ±/oynanan maÃ§: Storage'da geÃ§erli atak varsa (11 oyuncu veya isAutoApplied) asla boÅŸ/eksik ile ezme
        // âœ… Ama kullanÄ±cÄ± deÄŸiÅŸiklik yaptÄ±ysa preserve yapma
        const existingHasValidAttack = existing.attackFormation && (existingAttackCount >= 11 || existingHasAttackArray || existing.isAutoApplied === true);
        const preserveAttackForLive = isMatchLive && existingHasValidAttack && currentAttackCount < 11 && !hasModifiedSinceUnlock;
        const preserve = preserveRestored || preserveAttackForLive;
        // âš ï¸ State gÃ¼ncellemeleri burada yapÄ±lMAMALI - infinite loop'a neden olur
        // runRestore fonksiyonu zaten state'i yÃ¼kler, burada sadece storage gÃ¼ncellenir
        // âœ… matchId'yi number olarak kaydet (karÅŸÄ±laÅŸtÄ±rma tip uyuÅŸmazlÄ±ÄŸÄ±nÄ± Ã¶nle)
        const numericMatchId = typeof matchId === 'string' ? parseInt(matchId, 10) : matchId;
        
        const updated: Record<string, any> = {
          ...existing,
          matchId: numericMatchId,
          attackFormation: preserve ? existing.attackFormation : attackFormation,
          defenseFormation: preserve ? existing.defenseFormation : defenseFormation,
          editingMode: preserve ? (existing.editingMode || 'attack') : editingMode,
          defenseConfirmShown: preserve ? (existing.defenseConfirmShown ?? false) : defenseConfirmShown,
          isCompleted: wasCompleted || false,
        };
        
        // âœ… Slot sÄ±rasÄ± kesin: 0..10 dÃ¶ngÃ¼ ile yaz (attackPlayers/defensePlayers aÅŸaÄŸÄ±da slot sÄ±ralÄ± yazÄ±lacak)
        const attackArr: (any)[] = [];
        for (let i = 0; i < 11; i++) attackArr[i] = attackPlayers[i] ?? attackPlayers[String(i)] ?? null;
        const defArr: (any)[] = [];
        for (let i = 0; i < 11; i++) defArr[i] = defensePlayers[i] ?? defensePlayers[String(i)] ?? null;
        const hasValidCurrentAttack = attackArr.filter(Boolean).length >= 11;
        const hasValidCurrentDefense = defArr.filter(Boolean).length >= 11;
        
        // âœ… attackPlayers/defensePlayers'Ä± state yerine slot sÄ±ralÄ± diziyle yaz (karÄ±ÅŸmasÄ±n)
        const attackOrdered: Record<number, any> = {};
        for (let i = 0; i < 11; i++) if (attackArr[i]) attackOrdered[i] = attackArr[i];
        const defenseOrdered: Record<number, any> = {};
        for (let i = 0; i < 11; i++) if (defArr[i]) defenseOrdered[i] = defArr[i];
        if (!preserve) {
          updated.attackPlayers = attackOrdered;
          updated.defensePlayers = defenseOrdered;
        }
        
        if (wasCompleted || (isMatchLive && existingHasValidAttack) || hasValidCurrentAttack) {
          if (existing.attackPlayersBySlot && Array.isArray(existing.attackPlayersBySlot) && existing.attackPlayersBySlot.length >= 11) {
            updated.attackPlayersBySlot = existing.attackPlayersBySlot;
            updated.attackPlayersArray = Array.from({ length: 11 }, (_, i) => {
              const e = existing.attackPlayersBySlot.find((x: { slot: number }) => x.slot === i);
              return e?.player ?? null;
            });
          } else if (existing.attackPlayersArray && Array.isArray(existing.attackPlayersArray) && existing.attackPlayersArray.length >= 11) {
            updated.attackPlayersArray = existing.attackPlayersArray;
            updated.attackPlayersBySlot = Array.from({ length: 11 }, (_, i) => ({ slot: i, player: existing.attackPlayersArray[i] ?? null }));
          } else if (hasValidCurrentAttack) {
            updated.attackPlayersArray = attackArr;
            updated.attackPlayersBySlot = Array.from({ length: 11 }, (_, i) => ({ slot: i, player: attackArr[i] ?? null }));
          }
          if (existing.defensePlayersArray && Array.isArray(existing.defensePlayersArray) && existing.defensePlayersArray.length >= 11) {
            updated.defensePlayersArray = existing.defensePlayersArray;
          } else if (hasValidCurrentDefense) {
            updated.defensePlayersArray = defArr;
          }
          if (existing.attackFormationName) updated.attackFormationName = existing.attackFormationName;
        }
        
        await AsyncStorage.setItem(key, JSON.stringify(updated));
      } catch (e) {
        console.warn('Partial state save failed', e);
      }
    };
    savePartialState();
  }, [attackFormation, defenseFormation, attackPlayers, defensePlayers, editingMode, defenseConfirmShown, stateRestored, matchId, squadStorageKey, isMatchLive, hasModifiedSinceUnlock]);
  
  // âœ… KullanÄ±cÄ± tahmin yapmÄ±ÅŸ mÄ± kontrol et (storage'dan yÃ¼kle) â€“ biten maÃ§ta "Kadro oluÅŸturulmadÄ±" yanÄ±p sÃ¶nmesin
  React.useEffect(() => {
    setHasCheckedSquadStorage(false);
    (async () => {
      try {
        const fixtureId = Number(matchId);
        const isMockMatch = fixtureId === MOCK_MATCH_IDS.REAL_BARCA || fixtureId === MOCK_MATCH_IDS.GS_FB || fixtureId === MOCK_MATCH_IDS.TEST_6H;
        
        // Mock maÃ§lar iÃ§in: Storage'da kayÄ±t olsa bile, gerÃ§ekten tamamlanmÄ±ÅŸ mÄ± kontrol et
        const raw = await AsyncStorage.getItem(squadStorageKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          // âœ… Mock maÃ§lar iÃ§in: matchId eÅŸleÅŸmeli ve isCompleted true olmalÄ±
          // âœ… Tip uyuÅŸmazlÄ±ÄŸÄ±nÄ± Ã¶nlemek iÃ§in Number() ile normalize et
          const parsedMatchId = parsed.matchId != null ? Number(parsed.matchId) : null;
          if (isMockMatch) {
            const hasValidPrediction = parsed.isCompleted === true && 
                                     parsedMatchId === fixtureId &&
                                     parsed.attackPlayersArray &&
                                     parsed.attackPlayersArray.length >= 11;
            setHasPrediction(hasValidPrediction);
          } else {
            setHasPrediction(parsed.isCompleted === true);
          }
        } else {
          setHasPrediction(false);
        }
      } catch (_) {
        setHasPrediction(false);
      } finally {
        setHasCheckedSquadStorage(true);
      }
    })();
  }, [squadStorageKey, matchId]);
  
  // âœ… Oynanan maÃ§ta viewSource varsayÄ±lanÄ±:
  // - Tahmin yapÄ±lmÄ±ÅŸsa â†’ 'user' (kullanÄ±cÄ±nÄ±n tahmini)
  // - CanlÄ± maÃ§ + tahmin yapÄ±lmamÄ±ÅŸsa â†’ 'community' (topluluk formasyonu + gerÃ§ek oyuncular)
  // - Biten maÃ§ + tahmin yapÄ±lmamÄ±ÅŸsa â†’ 'community' (topluluk formasyonu + gerÃ§ek oyuncular)
  // NOT: ArtÄ±k tahmin yapÄ±lmamÄ±ÅŸsa her durumda 'community' - gerÃ§ek oyuncular topluluk formasyonuna yerleÅŸir
  React.useEffect(() => {
    if (isKadroLocked) {
      if (hasPrediction) {
        setViewSource('user');
      } else {
        // Tahmin yapÄ±lmamÄ±ÅŸsa (canlÄ± veya biten maÃ§) â†’ topluluk formasyonu ile gÃ¶ster
        setViewSource('community');
      }
    }
  }, [isKadroLocked, hasPrediction, isMatchLive, isMatchFinished]);
  
  // âœ… 120 saniyelik timeout mantÄ±ÄŸÄ± kaldÄ±rÄ±ldÄ± - artÄ±k maÃ§ baÅŸlayana kadar serbestÃ§e dÃ¼zenleme yapÄ±labilir
  
  // âœ… viewSource + editingMode'a gÃ¶re gÃ¶sterilecek formasyon ve oyuncular
  const selectedFormation = React.useMemo(() => {
    if (isKadroLocked) {
      if (viewSource === 'actual') {
        return editingMode === 'attack' ? actualAttackFormation : (actualDefenseFormation ?? actualAttackFormation);
      }
      if (viewSource === 'community') {
        const userForm = editingMode === 'attack' ? attackFormation : (defenseFormation ?? attackFormation);
        return userForm || null;
      }
      return editingMode === 'attack' ? attackFormation : (defenseFormation ?? attackFormation);
    }
    return editingMode === 'attack'
      ? attackFormation
      : (defenseFormation ?? attackFormation ?? null);
  }, [isKadroLocked, viewSource, editingMode, attackFormation, defenseFormation, actualAttackFormation, actualDefenseFormation]);
  
  const defensePlayerCount = Object.keys(defensePlayers).filter(k => defensePlayers[parseInt(k)]).length;
  
  const selectedPlayers = React.useMemo(() => {
    if (isKadroLocked) {
      if (viewSource === 'actual') {
        return editingMode === 'attack' ? actualAttackPlayers : (Object.keys(actualDefensePlayers).length > 0 ? actualDefensePlayers : actualAttackPlayers);
      }
      if (viewSource === 'community') {
        const userPlayers = editingMode === 'attack' ? attackPlayers : defensePlayers;
        const hasUserPlayers = Object.values(userPlayers).some(p => p != null);
        if (hasUserPlayers) return userPlayers;
        return {};
      }
      return editingMode === 'attack' ? attackPlayers : defensePlayers;
    }
    return editingMode === 'attack' ? attackPlayers : defensePlayers;
  }, [isKadroLocked, viewSource, editingMode, attackPlayers, defensePlayers, actualAttackPlayers, actualDefensePlayers]);
  
  const setSelectedPlayers = editingMode === 'attack' ? setAttackPlayers : setDefensePlayers;
  
  const [selectedSlot, setSelectedSlot] = useState<number | null>(null);
  const [showFormationModal, setShowFormationModal] = useState(false);
  const [showPlayerModal, setShowPlayerModal] = useState(false);
  const [showNoSquadInfoModal, setShowNoSquadInfoModal] = useState(false);
  const [formationType, setFormationType] = useState<'attack' | 'defense' | 'balanced'>('attack');
  const [selectedPlayerForDetail, setSelectedPlayerForDetail] = useState<any | null>(null);
  const [isSaving, setIsSaving] = useState(false); // âœ… Kaydediliyor... gÃ¶stergesi iÃ§in
  const savingRef = React.useRef(false); // âœ… handleComplete sÄ±rasÄ±nda savePartialState'i engelle
  const [isSquadLocked, setIsSquadLocked] = useState(false); // âœ… Kadro kilitli mi? (Tamamla sonrasÄ±)
  
  // âœ… Ã–nceki kilit durumu - kilit aÃ§Ä±ldÄ±ÄŸÄ±nda reset flag
  const prevSquadLockedRef = React.useRef(isSquadLocked);
  
  // âœ… Kilit aÃ§Ä±ldÄ±ÄŸÄ±nda modified flag'i sÄ±fÄ±rla
  React.useEffect(() => {
    if (prevSquadLockedRef.current === true && isSquadLocked === false) {
      setHasModifiedSinceUnlock(false);
    }
    prevSquadLockedRef.current = isSquadLocked;
  }, [isSquadLocked]);
  
  // âœ… KaydedilmemiÅŸ deÄŸiÅŸiklikleri parent'a bildir
  React.useEffect(() => {
    // âœ… Biten maÃ§larda kaydedilmemiÅŸ deÄŸiÅŸiklik uyarÄ±sÄ± gÃ¶sterilmez
    if (isMatchFinished) {
      setHasUnsavedChanges(false);
      onHasUnsavedChanges?.(false);
      return;
    }
    
    // CanlÄ±/biten maÃ§larda deÄŸiÅŸiklik yapÄ±lamaz
    if (isKadroLocked) {
      setHasUnsavedChanges(false);
      onHasUnsavedChanges?.(false);
      return;
    }
    
    // âœ… Kadro kilitli ise (Tamamla basÄ±ldÄ±, kÄ±rmÄ±zÄ± kilit) = kaydedilmiÅŸ, deÄŸiÅŸiklik yok
    if (isSquadLocked) {
      setHasUnsavedChanges(false);
      onHasUnsavedChanges?.(false);
      return;
    }
    
    // âœ… Otomatik kadro uygulandÄ±ysa VE kullanÄ±cÄ± henÃ¼z manuel deÄŸiÅŸiklik yapmadÄ±ysa â†’ uyarÄ± gÃ¶sterme
    // Sadece kullanÄ±cÄ± manuel olarak deÄŸiÅŸiklik yaptÄ±ÄŸÄ±nda uyarÄ± gÃ¶sterilmeli
    if (autoSquadApplied && !hasModifiedSinceUnlock) {
      setHasUnsavedChanges(false);
      onHasUnsavedChanges?.(false);
      return;
    }
    
    // âœ… Kilit aÃ§Ä±k (yeÅŸil) VE formasyon/oyuncu seÃ§ilmiÅŸse â†’ her zaman uyarÄ± gÃ¶ster
    // Kilit aÃ§Ä±ldÄ±ÄŸÄ±nda sekme deÄŸiÅŸirken mutlaka "kaydet" uyarÄ±sÄ± gÃ¶sterilmeli
    const attackPlayerCount = Object.keys(attackPlayers).filter(k => attackPlayers[parseInt(k)]).length;
    const hasFormationAndPlayers = attackFormation !== null && attackPlayerCount > 0;
    
    // Kilit yeÅŸil (aÃ§Ä±k) ise â†’ kaydedilmemiÅŸ sayÄ±lÄ±r (tamamla basÄ±lmamÄ±ÅŸ)
    // Ama otomatik kadro uygulandÄ±ysa ve kullanÄ±cÄ± deÄŸiÅŸiklik yapmadÄ±ysa â†’ false
    const hasChanges = hasFormationAndPlayers && (hasModifiedSinceUnlock || !autoSquadApplied);
    
    setHasUnsavedChanges(hasChanges);
    onHasUnsavedChanges?.(hasChanges);
  }, [attackFormation, attackPlayers, isKadroLocked, isSquadLocked, isMatchFinished, autoSquadApplied, hasModifiedSinceUnlock, onHasUnsavedChanges]);
  
  // âœ… Community Signal Popup State
  const [showCommunitySignal, setShowCommunitySignal] = useState(false);
  const [communitySignalPlayer, setCommunitySignalPlayer] = useState<{ id: number; name: string; position: string } | null>(null);
  // Session-based spam prevention: track which players have been shown signal in this session
  const communitySignalShownRef = React.useRef<Set<number>>(new Set());
  
  // âœ… editingMode deÄŸiÅŸtiÄŸinde formationType'Ä± senkronize et
  React.useEffect(() => {
    if (editingMode === 'defense') {
      setFormationType('defense');
    } else if (editingMode === 'attack') {
      setFormationType('attack');
    }
  }, [editingMode]);
  
  // Player Predictions State
  const [playerPredictions, setPlayerPredictions] = useState<Record<number, any>>({});
  
  // âœ… Get attack squad players for defense selection
  const attackSquadPlayers = React.useMemo(() => {
    return Object.values(attackPlayers).filter(Boolean) as any[];
  }, [attackPlayers]);
  
  // âœ… Show defense confirmation when attack squad is complete (11 players)
  React.useEffect(() => {
    if (!stateRestored) return; // State restore edilene kadar bekle
    
    // âœ… Tahmin yapÄ±lmayan canlÄ±/biten maÃ§ta defans popup gÃ¶sterme (VIEW-ONLY mod)
    if ((isMatchLive || isMatchFinished) && !hasPrediction) {
      return;
    }
    
    const attackCount = Object.keys(attackPlayers).filter(k => attackPlayers[parseInt(k)]).length;
    
    // Show confirmation only when:
    // 1. Attack squad has 11 players
    // 2. Defense formation not yet selected
    // 3. Confirmation not already shown
    // 4. We're in attack mode
    // 5. Match not live (canlÄ± maÃ§ta kadro kilitli, defans modalÄ± gÃ¶sterme)
    if (attackCount === 11 && !defenseFormation && !defenseConfirmShown && editingMode === 'attack' && !isKadroLocked) {
      setDefenseConfirmShown(true);
      setTimeout(() => {
        setShowDefenseConfirmModal(true);
      }, 500);
    }
  }, [attackPlayers, defenseFormation, defenseConfirmShown, editingMode, stateRestored, isKadroLocked, isMatchLive, isMatchFinished, hasPrediction]);

  // âœ… Atak formasyonundaki oyuncu deÄŸiÅŸikliklerini takip et ve defans formasyonunu yÃ¶net
  React.useEffect(() => {
    if (!stateRestored || !attackPlayersInitializedRef.current) {
      // Ä°lk yÃ¼klemede previousAttackPlayersRef'i gÃ¼ncelle
      if (stateRestored && Object.keys(attackPlayers).length > 0) {
        previousAttackPlayersRef.current = { ...attackPlayers };
        attackPlayersInitializedRef.current = true;
      }
      return;
    }

    // Defans formasyonu yoksa veya kilitliyse kontrol etme
    if (!defenseFormation || isKadroLocked || isSquadLocked) {
      previousAttackPlayersRef.current = { ...attackPlayers };
      return;
    }

    const prev = previousAttackPlayersRef.current;
    const current = attackPlayers;

    // Hangi oyuncular deÄŸiÅŸti?
    const changedSlots: number[] = [];
    let goalkeeperChanged = false;
    let nonGoalkeeperChanged = false;

    // TÃ¼m slotlarÄ± kontrol et
    const allSlots = new Set([...Object.keys(prev).map(Number), ...Object.keys(current).map(Number)]);
    
    allSlots.forEach(slot => {
      const prevPlayer = prev[slot];
      const currentPlayer = current[slot];
      
      // Oyuncu deÄŸiÅŸti mi?
      if (prevPlayer?.id !== currentPlayer?.id) {
        changedSlots.push(slot);
        
        // Kaleci pozisyonu mu?
        const formation = formations.find(f => f.id === attackFormation);
        const slotPosition = formation?.positions[slot];
        const isGKSlot = slotPosition === 'GK';
        
        if (isGKSlot) {
          goalkeeperChanged = true;
        } else {
          nonGoalkeeperChanged = true;
        }
      }
    });

    // EÄŸer deÄŸiÅŸiklik yoksa Ã§Ä±k
    if (changedSlots.length === 0) {
      return;
    }

    // âœ… Sadece kaleci deÄŸiÅŸtiyse: Defans formasyonuna otomatik ekle
    if (goalkeeperChanged && !nonGoalkeeperChanged) {
      const currentGoalkeeper = Object.values(current).find(p => p && isGoalkeeperPlayer(p));
      
      if (currentGoalkeeper && defenseFormation) {
        const defFormation = formations.find(f => f.id === defenseFormation);
        if (defFormation) {
          const gkSlot = defFormation.positions.findIndex((pos: string) => pos === 'GK');
          if (gkSlot !== -1) {
            setDefensePlayers(prev => {
              const updated = { ...prev };
              updated[gkSlot] = currentGoalkeeper;
              return updated;
            });
            
            console.log('âœ… Kaleci defans formasyonuna otomatik eklendi');
          }
        }
      }
    } 
    // âœ… Kaleci dÄ±ÅŸÄ±nda oyuncu deÄŸiÅŸikliÄŸi: ArtÄ±k defans formasyon sÄ±fÄ±rlanmÄ±yor!
    // Oyuncu deÄŸiÅŸikliÄŸi handlePlayerSelect ve handleRemovePlayer iÃ§inde otomatik yapÄ±lÄ±yor.
    // Bu useEffect sadece kaleci gÃ¼ncellemesi iÃ§in kullanÄ±lÄ±yor.

    // Previous state'i gÃ¼ncelle
    previousAttackPlayersRef.current = { ...attackPlayers };
  }, [attackPlayers, defenseFormation, stateRestored, isKadroLocked, isSquadLocked, attackFormation]);

  // Pulsing ball animation
  const scale = useSharedValue(1);
  
  React.useEffect(() => {
    if (!isWeb) {
      scale.value = withRepeat(
        withTiming(1.1, { duration: 1000 }),
        -1,
        true
      );
    }
  }, []);

  const animatedBallStyle = useAnimatedStyle(() => ({
    transform: [{ scale: isWeb ? 1 : scale.value }],
  }));

  const applyFormationChange = (formationId: string, mode?: 'attack' | 'defense') => {
    const formation = formations.find(f => f.id === formationId);
    // âœ… formationType state'ini kullan (modal'dan seÃ§im yapÄ±lÄ±rken gÃ¼ncel)
    const effectiveMode = mode || formationType;
    
    if (effectiveMode === 'attack') {
      // âœ… Atak formasyonu deÄŸiÅŸtiÄŸinde: TÃ¼m tahminleri ve pozisyonlarÄ± sÄ±fÄ±rla
      const clearAllPredictions = async () => {
        try {
          if (effectivePredictionTeamId != null) {
            await AsyncStorage.removeItem(`${STORAGE_KEYS.PREDICTIONS}${matchId}-${effectivePredictionTeamId}`);
          } else {
            await AsyncStorage.removeItem(STORAGE_KEYS.PREDICTIONS + matchId);
          }
          const userDataStr = await AsyncStorage.getItem(STORAGE_KEYS.USER);
          const userData = userDataStr ? JSON.parse(userDataStr) : null;
          const userId = userData?.id;
          if (userId) {
            await predictionsDb.deletePredictionsByMatch(userId, String(matchId));
          }
        } catch (e) { 
          console.warn('Clear predictions failed during formation change', e); 
        }
      };
      
      clearAllPredictions();
      
      setAttackFormation(formationId);
      setAttackPlayers({});
      setDefenseFormation(null);
      setDefensePlayers({});
      setDefenseConfirmShown(false);
      setHasModifiedSinceUnlock(true); // âœ… Formasyon deÄŸiÅŸti
      // âœ… Previous state'i de sÄ±fÄ±rla
      previousAttackPlayersRef.current = {};
      attackPlayersInitializedRef.current = false;
      setShowFormationModal(false);
      
      // âœ… Analiz odaÄŸÄ±ndan baÅŸlatmak iÃ§in callback Ã§aÄŸÄ±r
      // Not: Bu callback sadece gerÃ§ekten atak formasyonu deÄŸiÅŸtiÄŸinde Ã§aÄŸrÄ±lÄ±r
      // Analiz odaÄŸÄ± zaten seÃ§ilmiÅŸse tekrar aÃ§Ä±lmamalÄ±
      // âœ… CanlÄ±/biten maÃ§larda analiz odaÄŸÄ± seÃ§imine gerek yok
      if (!isMatchFinished && !isMatchLive) {
        setTimeout(() => {
          onAttackFormationChangeConfirmed?.();
        }, 500);
      }
    } else {
      // âœ… Defans formasyonu seÃ§ildiÄŸinde: SADECE kaleci otomatik atanÄ±r, diÄŸer 10 pozisyon boÅŸ kalÄ±r
      setDefenseFormation(formationId);
      
      const defFormation = formations.find((f: any) => f.id === formationId);
      const defPlayers: Record<number, any | null> = {};
      
      // âœ… Ã–nce atak kadrosundaki kaleci'yi bul
      let goalkeeper: any | null = null;
      Object.entries(attackPlayers).forEach(([slot, p]) => {
        if (p && isGoalkeeperPlayer(p)) {
          goalkeeper = p;
        }
      });
      
      // âœ… SADECE kaleci defans formasyonunun GK slotuna otomatik atanÄ±r
      // DiÄŸer 10 pozisyon BOÅ kalÄ±r - kullanÄ±cÄ± atak kadrosundan seÃ§erek doldurur
      if (goalkeeper && defFormation) {
        const gkSlot = defFormation.positions.findIndex((pos: string) => pos === 'GK');
        if (gkSlot !== -1) {
          defPlayers[gkSlot] = goalkeeper;
        }
      }
      
      setDefensePlayers(defPlayers); // SADECE kaleci atanmÄ±ÅŸ, diÄŸer 10 pozisyon boÅŸ
      setEditingMode('defense');
      setHasModifiedSinceUnlock(true); // âœ… Formasyon deÄŸiÅŸti
      
      setShowFormationModal(false);
    }
    // isCompleted sadece ATAK formasyonu deÄŸiÅŸtiÄŸinde sÄ±fÄ±rlanÄ±r (defans deÄŸiÅŸikliÄŸi tahminleri silmez)
    if (effectiveMode === 'attack') {
      (async () => {
        try {
          const key = squadStorageKey;
          const raw = await AsyncStorage.getItem(key);
          if (raw) {
            const parsed = JSON.parse(raw);
            parsed.isCompleted = false;
            await AsyncStorage.setItem(key, JSON.stringify(parsed));
          }
        } catch (e) { console.warn('isCompleted reset failed', e); }
      })();
    } else {
      // Defans formasyonu: isCompleted sÄ±fÄ±rla (defans yerleÅŸtirmesi gerekiyor) ama tahminler silinmez
      (async () => {
        try {
          const key = squadStorageKey;
          const raw = await AsyncStorage.getItem(key);
          if (raw) {
            const parsed = JSON.parse(raw);
            parsed.isCompleted = false;
            parsed.attackPlayersArray = Array.from({ length: 11 }, (_, i) => attackPlayers[i] ?? null);
            parsed.attackFormation = attackFormation;
            await AsyncStorage.setItem(key, JSON.stringify(parsed));
          }
        } catch (e) { console.warn('Defense formation state save failed', e); }
      })();
    }
  };

  const handleFormationSelect = async (formationId: string) => {
    // âœ… AYNI FORMASYON SEÃ‡Ä°LDÄ°YSE: HiÃ§bir ÅŸey yapma, sadece modal'Ä± kapat
    const currentFormation = formationType === 'attack' ? attackFormation : defenseFormation;
    if (formationId === currentFormation) {
      console.log('âœ… AynÄ± formasyon seÃ§ildi, deÄŸiÅŸiklik yok:', formationId);
      setShowFormationModal(false);
      return;
    }
    
    // âœ… UyarÄ± SADECE atak formasyonu deÄŸiÅŸtiÄŸinde: modal'da "Atak" sekmesindeyken farklÄ± formasyon seÃ§ilirse.
    // Defans formasyonu seÃ§ildiÄŸinde bu uyarÄ± hiÃ§ gelmez (defans aynÄ± 11'i kullanÄ±r, tahminler silinmez).
    const isAttackFormationChange =
      formationType === 'attack' &&
      attackFormation != null &&
      formationId !== attackFormation;

    if (isAttackFormationChange) {
      // âœ… UyarÄ± SADECE kadro "Tamamla" ile tamamlanmÄ±ÅŸsa gÃ¶sterilir (oyuncu atanmÄ±ÅŸ + Tamamla basÄ±lmÄ±ÅŸ)
      let squadIsCompleted = false;
      try {
        const squadRaw = await AsyncStorage.getItem(squadStorageKey);
        if (squadRaw) {
          const squad = JSON.parse(squadRaw);
          squadIsCompleted = squad?.isCompleted === true;
        }
      } catch (_) {}

      if (squadIsCompleted) {
        const clearAndApply = async () => {
          try {
            if (effectivePredictionTeamId != null) {
              await AsyncStorage.removeItem(`${STORAGE_KEYS.PREDICTIONS}${matchId}-${effectivePredictionTeamId}`);
            } else {
              await AsyncStorage.removeItem(STORAGE_KEYS.PREDICTIONS + matchId);
            }
            const userDataStr = await AsyncStorage.getItem(STORAGE_KEYS.USER);
            const userData = userDataStr ? JSON.parse(userDataStr) : null;
            const userId = userData?.id;
            if (userId) {
              await predictionsDb.deletePredictionsByMatch(userId, String(matchId));
            }
            const key = squadStorageKey;
            const raw = await AsyncStorage.getItem(key);
            if (raw) {
              const parsed = JSON.parse(raw);
              parsed.isCompleted = false;
              await AsyncStorage.setItem(key, JSON.stringify(parsed));
            }
          } catch (e) { console.warn('Clear predictions failed', e); }
          applyFormationChange(formationId);
        };

        setFormationConfirmModal({ formationId });
        return;
      }
    }

    applyFormationChange(formationId);
  };

  const runFormationChangeConfirm = async () => {
    const id = formationConfirmModal?.formationId;
    if (!id) return;
    try {
      if (effectivePredictionTeamId != null) {
        await AsyncStorage.removeItem(`${STORAGE_KEYS.PREDICTIONS}${matchId}-${effectivePredictionTeamId}`);
      } else {
        await AsyncStorage.removeItem(STORAGE_KEYS.PREDICTIONS + matchId);
      }
      const userDataStr = await AsyncStorage.getItem(STORAGE_KEYS.USER);
      const userData = userDataStr ? JSON.parse(userDataStr) : null;
      const userId = userData?.id;
      if (userId) await predictionsDb.deletePredictionsByMatch(userId, String(matchId));
      const raw = await AsyncStorage.getItem(squadStorageKey);
      if (raw) {
        const parsed = JSON.parse(raw);
        parsed.isCompleted = false;
        await AsyncStorage.setItem(squadStorageKey, JSON.stringify(parsed));
      }
    } catch (e) { console.warn('Clear predictions failed', e); }
    applyFormationChange(id);
    setFormationConfirmModal(null);
    setShowFormationModal(false);
    // âœ… Analiz odaÄŸÄ± seÃ§imi tekrar gÃ¶sterilsin: Dashboard'a dÃ¶n; kullanÄ±cÄ± maÃ§a tÄ±klayÄ±nca analiz odaÄŸÄ± modal aÃ§Ä±lÄ±r
    // âœ… CanlÄ±/biten maÃ§larda analiz odaÄŸÄ± seÃ§imine gerek yok
    if (!isMatchFinished && !isMatchLive) {
      onAttackFormationChangeConfirmed?.();
    }
  };
  
  // âœ… Handle defense confirmation
  const handleDefenseConfirmYes = () => {
    setShowDefenseConfirmModal(false);
    setEditingMode('defense');
    setFormationType('defense');
    // âœ… CanlÄ±/biten maÃ§ veya kadro kilitli ise formasyon deÄŸiÅŸikliÄŸine izin verme
    if (isKadroLocked || isSquadLocked) return;
    setTimeout(() => {
      setShowFormationModal(true);
    }, 300);
  };
  
  const handleDefenseConfirmNo = () => {
    setShowDefenseConfirmModal(false);
    
    // âœ… Copy attack formation and players to defense (same system for both)
    if (attackFormation) {
      setDefenseFormation(attackFormation);
      setDefensePlayers({ ...attackPlayers }); // âœ… AynÄ± oyuncular defans iÃ§in de kopyalanÄ±yor
      
      const formation = formations.find(f => f.id === attackFormation);
      showInfo(
        'Kadro TamamlandÄ±! âš½',
        `Atak ve defans iÃ§in aynÄ± formasyon kullanÄ±lacak:\n\n${formation?.name}\n\nâš ï¸ Ã–NEMLÄ°: Bu sayfadan ayrÄ±lmadan Ã¶nce deÄŸiÅŸiklikleri kaydetmek iÃ§in "Tamamla" butonuna basmanÄ±z gerekiyor.\n\nTamamla'ya basmadan Ã§Ä±karsanÄ±z deÄŸiÅŸiklikler kaydedilmez!`
      );
    }
  };

  const handlePlayerSelect = (player: any) => {
    // âœ… Sakat veya cezalÄ± oyuncu kadroya eklenemez (kÄ±sÄ±t kalkÄ±nca tekrar eklenebilir)
    if (player.eligible_for_selection === false || player.injured || player.suspended) {
      showInfo(
        'Kadroya Eklenemez',
        'Bu oyuncu sakat veya cezalÄ±. Kadroya ekleyemezsiniz. SakatlÄ±k/ceza kalkÄ±nca tekrar ekleyebilirsiniz.'
      );
      return;
    }
    if (selectedSlot !== null) {
      const currentFormation = editingMode === 'attack' ? attackFormation : defenseFormation;
      const formationData = formations.find(f => f.id === currentFormation);
      const slotPosition = formationData?.positions[selectedSlot];
      
      const isGK = isGoalkeeperPlayer(player);
      // âœ… Kaleci yalnÄ±zca kale pozisyonuna, saha oyuncusu yalnÄ±zca saha pozisyonlarÄ±na
      if (isGK && slotPosition !== 'GK') {
        showInfo(t('matchSquad.goalkeeperConstraint'), t('matchSquad.goalkeeperConstraintDesc'));
        return;
      }
      if (slotPosition === 'GK' && !isGK) {
        showInfo(t('matchSquad.goalPositionConstraint'), t('matchSquad.goalPositionConstraintDesc'));
        return;
      }
      
      if (editingMode === 'attack') {
        // âœ… Eski oyuncuyu al
        const oldPlayer = attackPlayers[selectedSlot];
        
        // âœ… Oyuncu gerÃ§ekten deÄŸiÅŸti mi kontrol et
        const isPlayerChanged = !oldPlayer || oldPlayer.id !== player.id;
        
        const newAttack = { ...attackPlayers, [selectedSlot]: player };
        setAttackPlayers(newAttack);
        
        // âœ… ATAK OYUNCUSU DEÄÄ°ÅTÄ°ÄÄ°NDE DEFANS KADROSUNU SIFIRLA
        // Yeni mantÄ±k: Atak kadrosunda tek bir oyuncu bile deÄŸiÅŸirse, defans formasyonu yeniden kurulmalÄ±
        if (defenseFormation && isPlayerChanged) {
          console.log('âš ï¸ Atak oyuncusu deÄŸiÅŸti, defans formasyonu sÄ±fÄ±rlanacak');
          setDefenseFormation(null);
          setDefensePlayers({});
          setDefenseConfirmShown(false);
          
          // KullanÄ±cÄ±ya bilgi ver
          setTimeout(() => {
            showInfo(
              'Defans Formasyonu SÄ±fÄ±rlandÄ±',
              'Atak kadrosunda deÄŸiÅŸiklik yaptÄ±nÄ±z. LÃ¼tfen defans formasyonunu yeniden seÃ§in.'
            );
          }, 500);
        }
      } else {
        // âœ… Defans modunda sadece o oyuncu deÄŸiÅŸir
        setDefensePlayers({ ...defensePlayers, [selectedSlot]: player });
      }
      
      // âœ… DeÄŸiÅŸiklik yapÄ±ldÄ± - kilit aÃ§Ä±ldÄ±ysa uyarÄ± gÃ¶sterilecek
      setHasModifiedSinceUnlock(true);
      
      setSelectedSlot(null);
      setShowPlayerModal(false);
    }
  };

  const handleRemovePlayer = async (slotIndex: number) => {
    // âœ… Kilit kontrolÃ¼ - Ã§ift kontrol
    if (isKadroLocked) {
      showKadroLockedToast();
      return;
    }
    
    if (isSquadLocked) {
      showInfo(t('matchSquad.squadLocked'), t('matchSquad.squadLockedRemovePlayer'));
      return;
    }
    
    const player = selectedPlayers[slotIndex];
    if (!player) {
      console.warn('handleRemovePlayer: No player at slot', slotIndex);
      return;
    }
    
    console.log('âœ… handleRemovePlayer: Removing player', player.name, 'from slot', slotIndex, 'editingMode:', editingMode);
    console.log('âœ… Current attackPlayers before update:', {
      keys: Object.keys(attackPlayers),
      slot0: attackPlayers[0],
      slotIndex: attackPlayers[slotIndex],
      count: Object.keys(attackPlayers).filter(k => attackPlayers[parseInt(k)]).length
    });
    
    // âœ… editingMode'a gÃ¶re doÄŸru state'i gÃ¼ncelle - functional update kullan
    if (editingMode === 'attack') {
      // âœ… ATAK OYUNCUSU SÄ°LÄ°NDÄ°ÄÄ°NDE DEFANS KADROSUNU SIFIRLA
      // Yeni mantÄ±k: Atak kadrosunda tek bir oyuncu bile deÄŸiÅŸirse, defans formasyonu yeniden kurulmalÄ±
      if (defenseFormation && player) {
        console.log('âš ï¸ Atak oyuncusu silindi, defans formasyonu sÄ±fÄ±rlanacak');
        setDefenseFormation(null);
        setDefensePlayers({});
        setDefenseConfirmShown(false);
        
        // KullanÄ±cÄ±ya bilgi ver
          setTimeout(() => {
            showInfo(
              'Defans Formasyonu SÄ±fÄ±rlandÄ±',
              'Atak kadrosunda deÄŸiÅŸiklik yaptÄ±nÄ±z. LÃ¼tfen defans formasyonunu yeniden seÃ§in.'
            );
          }, 500);
      }
      
      setAttackPlayers(prev => {
        console.log('âœ… setAttackPlayers prev:', {
          keys: Object.keys(prev),
          slot0: prev[0],
          slotIndex: prev[slotIndex],
          count: Object.keys(prev).filter(k => prev[parseInt(k)]).length
        });
        
        // Ã–nce mevcut state'i kopyala
        const updated = { ...prev };
        // Slot'u null yap
        updated[slotIndex] = null;
        
        // Debug: GÃ¼ncellenmiÅŸ state'i kontrol et
        console.log('âœ… setAttackPlayers updated:', {
          keys: Object.keys(updated),
          slot0: updated[0],
          slotIndex: updated[slotIndex],
          slotIndexValue: updated[slotIndex],
          count: Object.keys(updated).filter(k => updated[parseInt(k)]).length
        });
        
        return updated;
      });
    } else {
      setDefensePlayers(prev => {
        console.log('âœ… setDefensePlayers prev:', {
          keys: Object.keys(prev),
          slot0: prev[0],
          slotIndex: prev[slotIndex],
          count: Object.keys(prev).filter(k => prev[parseInt(k)]).length
        });
        
        // Ã–nce mevcut state'i kopyala
        const updated = { ...prev };
        // Slot'u null yap
        updated[slotIndex] = null;
        
        console.log('âœ… setDefensePlayers updated:', {
          keys: Object.keys(updated),
          slot0: updated[0],
          slotIndex: updated[slotIndex],
          count: Object.keys(updated).filter(k => updated[parseInt(k)]).length
        });
        
        return updated;
      });
    }
    
    // âœ… DeÄŸiÅŸiklik yapÄ±ldÄ± - kilit aÃ§Ä±ldÄ±ysa uyarÄ± gÃ¶sterilecek
    setHasModifiedSinceUnlock(true);
    
    // âœ… Atak modunda oyuncu Ã§Ä±karÄ±lÄ±rsa: defans kadrosu ETKÄ°LENMEZ
    // KullanÄ±cÄ± her kadroyu ayrÄ± yÃ¶netir
    
    // Kadro artÄ±k 10 kiÅŸi (eksik) â†’ isCompleted sÄ±fÄ±rla
    try {
      const key = squadStorageKey;
      const raw = await AsyncStorage.getItem(key);
      if (raw) {
        const parsed = JSON.parse(raw);
        parsed.isCompleted = false;
        await AsyncStorage.setItem(key, JSON.stringify(parsed));
      }
    } catch (e) { console.warn('isCompleted reset failed', e); }
  };

  const handleComplete = async () => {
    const attackCount = Object.keys(attackPlayers).filter(k => attackPlayers[parseInt(k)]).length;
    const defenseCount = Object.keys(defensePlayers).filter(k => defensePlayers[parseInt(k)]).length;
    
    console.log('ğŸ” handleComplete called', { attackCount, defenseCount, defenseFormation, editingMode });
    
    // Check if attack squad is complete
    if (attackCount < 11) {
      showInfo(t('matchSquad.attackSquadIncompleteTitle'), t('matchSquad.attackSquadIncomplete', { count: 11 - attackCount }));
      setEditingMode('attack');
      return;
    }
    
    // If defense formation was selected, check if defense squad is complete
    if (defenseFormation && defenseCount < 11) {
      showInfo(t('matchSquad.defenseSquadIncompleteTitle'), t('matchSquad.defenseSquadIncomplete', { count: 11 - defenseCount }));
      setEditingMode('defense');
      return;
    }
    
    // âœ… Kaydediliyor... gÃ¶ster
    setIsSaving(true);
    savingRef.current = true; // âœ… savePartialState'in isCompleted'Ä± ezmesini engelle
    
    try {
      // âœ… KayÄ±tta sÄ±ra bozulmasÄ±n: sadece slot 0..10 ile explicit oku (objenin key sÄ±rasÄ±na gÃ¼venme)
      const attackPlayersArray: (any)[] = [];
      const attackPlayersBySlot: { slot: number; player: any }[] = [];
      const attackPlayersOrdered: Record<number, any> = {};
      for (let i = 0; i < 11; i++) {
        const p = attackPlayers[i] ?? attackPlayers[String(i)] ?? null;
        attackPlayersArray[i] = p;
        attackPlayersBySlot.push({ slot: i, player: p });
        attackPlayersOrdered[i] = p;
      }
      const defensePlayersArray = defenseFormation
        ? (() => {
            const arr: (any)[] = [];
            for (let i = 0; i < 11; i++) arr[i] = defensePlayers[i] ?? defensePlayers[String(i)] ?? null;
            return arr;
          })()
        : attackPlayersArray;
      
      const formationName = formations.find(f => f.id === attackFormation)?.name || attackFormation;
      const numericMatchId = typeof matchId === 'string' ? parseInt(matchId, 10) : matchId;
      const squadData = {
        matchId: numericMatchId,
        attackFormation: attackFormation,
        attackFormationName: formationName,
        defenseFormation: defenseFormation || attackFormation,
        attackPlayers: attackPlayersOrdered,
        attackPlayersArray: attackPlayersArray,
        attackPlayersBySlot: attackPlayersBySlot,
        defensePlayers: defenseFormation ? defensePlayers : attackPlayersOrdered,
        defensePlayersArray: defensePlayersArray,
        playerPredictions: playerPredictions,
        timestamp: new Date().toISOString(),
        isCompleted: true, // âœ… Tamamla basÄ±ldÄ± â€“ Tahmin sekmesinde oyuncular gÃ¶rÃ¼necek
        // âœ… TÃ¼m takÄ±m kadrosu (yedekler dahil) - MatchPrediction'da oyuncu deÄŸiÅŸikliÄŸi iÃ§in
        allTeamPlayers: attackTeamPlayers,
      };
      
      await AsyncStorage.setItem(
        squadStorageKey,
        JSON.stringify(squadData)
      );
      
      console.log('âœ… Squad saved to local storage!', squadData);
      
      // âœ… Backend'e arka planda kaydet (baÅŸarÄ±sÄ±z olsa da sekme geÃ§iÅŸi yapÄ±lacak)
      (async () => {
        try {
          const { data: sessionData } = await supabase.auth.getSession();
          const authToken = sessionData?.session?.access_token;
          if (authToken) {
            const result = await squadPredictionsApi.saveSquadPrediction({
              matchId: matchId,
              attackFormation: attackFormation!,
              attackPlayers: attackPlayers,
              defenseFormation: defenseFormation || attackFormation!,
              defensePlayers: defenseFormation ? defensePlayers : attackPlayers,
              analysisFocus: matchData.analysisFocus || 'balanced',
            }, authToken);
            if (result.success) console.log('âœ… Squad saved to backend!');
            else console.warn('âš ï¸ Backend save failed:', result.message);
          }
        } catch (e) {
          console.warn('âš ï¸ Backend save failed (local OK):', e);
        }
      })();
      
      // âœ… Kadroyu kilitle ve tahmin durumunu gÃ¼ncelle
      setIsSquadLocked(true);
      setHasPrediction(true); // âœ… Hemen tahmin yapÄ±ldÄ± olarak iÅŸaretle
      
      // âœ… 1 saniye bekle ve Tahmin sekmesine geÃ§
      setTimeout(() => {
        setIsSaving(false);
        savingRef.current = false; // âœ… savePartialState'i tekrar aktif et
        if (__DEV__) console.log('ğŸ”„ Switching to Prediction tab...');
        InteractionManager.runAfterInteractions(() => {
          if (__DEV__) console.log('ğŸ”„ onComplete() called');
          onComplete();
        });
      }, 1000);
    } catch (error) {
      console.error('Error saving squad:', error);
      setIsSaving(false);
      savingRef.current = false; // âœ… Hata durumunda da resetle
      showInfo(t('common.error'), t('matchSquad.squadSaveFailed'));
    }
  };

  const positions = selectedFormation ? formationPositions[selectedFormation] || formationPositions['4-3-3'] : null;
  const formation = formations.find(f => f.id === selectedFormation);
  const selectedCount = Object.keys(selectedPlayers).filter(k => selectedPlayers[parseInt(k)]).length;
  
  // Calculate attack and defense counts for button activation
  const attackCount = Object.keys(attackPlayers).filter(k => attackPlayers[parseInt(k)]).length;
  const defenseCount = Object.keys(defensePlayers).filter(k => defensePlayers[parseInt(k)]).length;
  
  // âœ… Tamamla: atak 11 VE (defans yok VEYA defans 11) olduÄŸunda aktif
  // âœ… Kilit aÃ§Ä±ldÄ±ktan sonra (isSquadLocked === false) oyuncu deÄŸiÅŸikliÄŸi yapÄ±ldÄ±ÄŸÄ±nda otomatik olarak aktif olur
  // âœ… Formasyon deÄŸiÅŸikliÄŸi yapÄ±lmadan sadece oyuncu deÄŸiÅŸtirildiÄŸinde de aktif olmalÄ±
  const isCompleteButtonActive = attackCount === 11 && (!defenseFormation || defenseCount === 11);

  // Empty State (No Formation Selected) - saha aynÄ± minHeight ile kÃ¼Ã§Ã¼lmesin
  // âœ… MaÃ§ baÅŸlamamÄ±ÅŸ ve tahmin yapÄ±lmamÄ±ÅŸsa: Formasyon seÃ§ butonu gÃ¶ster
  // âœ… CanlÄ± veya biten maÃ§ta tahmin yapmayan kullanÄ±cÄ±lar iÃ§in boÅŸ saha gÃ¶sterilmez - otomatik kadro gÃ¶sterilir
  // âœ… Popup aÃ§Ä±kken empty state gÃ¶sterilmez
  // âœ… isKadroLocked && !hasPrediction â†’ empty state ASLA gÃ¶sterilmez (canlÄ± + biten maÃ§ dahil)
  if (!selectedFormation && 
      !(isKadroLocked && !hasPrediction) && 
      !((isMatchLive || isMatchFinished) && !hasPrediction && autoGeneratedSquad) && 
      !showStartingXIPopup) {
    return (
      <View style={styles.container}>
        <View style={styles.emptyStateContainer}>
          <FootballField style={[styles.mainField, fieldDynamicStyle]}>
            <View style={styles.emptyStateContent}>
              <Animated.View style={[styles.emptyStateBall, animatedBallStyle]}>
                <Text style={styles.emptyStateBallEmoji}>âš½</Text>
              </Animated.View>
              <Text style={styles.emptyStateTitle}>Kadro OluÅŸtur</Text>
              <Text style={styles.emptyStateSubtitle}>
                Tahminlerinize baÅŸlamak iÃ§in atak ve defans formasyonlarÄ±nÄ± seÃ§ip oyuncularÄ± pozisyonlarÄ±na atayÄ±n
              </Text>
            </View>
          </FootballField>

          <TouchableOpacity
            style={styles.selectFormationButton}
            onPress={() => {
              if (isKadroLocked) { showKadroLockedToast(); return; }
              // âœ… Kadro kilitliyken formasyon deÄŸiÅŸikliÄŸine izin verme
              if (isSquadLocked) {
                showInfo(t('matchSquad.squadLocked'), t('matchSquad.squadLockedFormationChange'));
                return;
              }
              setShowFormationModal(true);
            }}
            activeOpacity={0.8}
          >
            <LinearGradient
              colors={['#1FA2A6', '#047857']}
              start={{ x: 0, y: 0 }}
              end={{ x: 1, y: 0 }}
              style={styles.buttonGradient}
            >
              <Ionicons name="chevron-down" size={20} color="#FFFFFF" />
              <Text style={styles.buttonText}>Formasyon SeÃ§</Text>
            </LinearGradient>
          </TouchableOpacity>
        </View>

        {/* Formation Modal - BoÅŸ state'te de defans seÃ§ilebilir (atak 11 tamamlandÄ±ysa) */}
        <FormationModal
          visible={showFormationModal}
          formations={formations}
          formationType={formationType}
          onSelect={handleFormationSelect}
          onClose={() => {
            setShowFormationModal(false);
            setEditingMode(formationType === 'defense' ? 'defense' : 'attack');
          }}
          onTabChange={(type: string) => {
            setFormationType(type);
            if (type === 'defense') {
              setEditingMode('defense');
            } else {
              setEditingMode('attack');
            }
          }}
          canSelectDefense={attackFormation != null && attackCount === 11}
          currentAttackFormation={attackFormation}
          currentDefenseFormation={defenseFormation}
          communityDataVisible={communityDataVisible}
        />
      </View>
    );
  }

  // Main Squad Screen (Formation Selected)
  const showNoPredictionOverlay = hasCheckedSquadStorage && isKadroLocked && !hasPrediction && Object.values(selectedPlayers).every(p => p == null);
  return (
    <View style={styles.container}>
      <View style={styles.mainContainer}>
        {/* Football Field with Players */}
        <FootballField style={[styles.mainField, fieldDynamicStyle]}>
          {showNoPredictionOverlay && (
            <View style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, alignItems: 'center', justifyContent: 'center', zIndex: 20, paddingHorizontal: 24 }}>
              <View style={{ width: 48, height: 48, borderRadius: 24, backgroundColor: 'rgba(255,255,255,0.12)', alignItems: 'center', justifyContent: 'center', marginBottom: 8 }}>
                <Ionicons name="help-circle" size={32} color="#FFFFFF" />
              </View>
              <Text style={{ color: '#FFFFFF', fontSize: 13, fontWeight: '700', textAlign: 'center', textShadowColor: 'rgba(0,0,0,0.5)', textShadowOffset: { width: 0, height: 1 }, textShadowRadius: 2 }}>
                Kadro OluÅŸturulmadÄ±
              </Text>
              <Text style={{ color: 'rgba(255,255,255,0.9)', fontSize: 11, textAlign: 'center', marginTop: 4, textShadowColor: 'rgba(0,0,0,0.5)', textShadowOffset: { width: 0, height: 1 }, textShadowRadius: 1 }}>
                Bu maÃ§ iÃ§in kadro tahmini yapÄ±lmadÄ±
              </Text>
            </View>
          )}
          <View style={styles.playersContainer}>
            {positions?.map((pos, index) => {
              const player = selectedPlayers[index];
              const positionLabel = formation?.positions[index] || '';

              return (
                <View
                  key={player ? `player-${player.id}-${index}` : `slot-${index}`} // âœ… Stable key - sÄ±Ã§ramayÄ± Ã¶nler
                  style={[
                    styles.playerSlot,
                    { left: `${pos.x}%`, top: `${pos.y}%` }, // âœ… Sabit pozisyon - animasyon yok
                  ]}
                >
                  {player ? (() => {
                    const subOut = subOutData?.players[player.id] ?? subOutData?.players[String(player.id)];
                    const total = subOutData?.totalPredictors ?? 1;
                    const subOutRate = subOut ? subOut.subOutVotes / total : 0;
                    const replacementName = subOut?.replacementName ?? null;
                    const showSubOut = subOutRate >= 0.10;
                    const subOutTier = subOutRate >= 0.30 ? 'high' : subOutRate >= 0.20 ? 'mid' : 'low';
                    const showSubOutAlert = () => {
                      const pct = Math.round(subOutRate * 100);
                      let msg = t('matchSquad.substitutionCommunityTooltip', { pct });
                      if (replacementName) msg += `\n\nBu gÃ¶rÃ¼ÅŸte olanlarÄ±n bir kÄ±smÄ± yerine ${replacementName} girmeli diyor.`;
                      showInfo(t('matchSquad.communityOpinion'), msg);
                    };
                    return (
                    <View style={[
                      styles.playerCardWrapper,
                      showSubOut && styles.subOutOuter,
                      showSubOut && subOutTier === 'low' && styles.subOutBorderThin,
                      showSubOut && subOutTier === 'mid' && styles.subOutBorderThick,
                      showSubOut && subOutTier === 'high' && styles.subOutBorderPulse,
                    ]}>
                        {showSubOut && (
                          <TouchableOpacity
                            style={styles.subOutInfoIcon}
                            onPress={showSubOutAlert}
                            hitSlop={{ top: 6, bottom: 6, left: 6, right: 6 }}
                          >
                            <Ionicons name="information-circle" size={20} color="#EF4444" />
                          </TouchableOpacity>
                        )}
                        {/* Remove button - Top Right */}
                        {/* âœ… X butonu: Kadro dÃ¼zenlenebilir durumda gÃ¶sterilir (maÃ§ baÅŸlamamÄ±ÅŸ VE kadro kilitli deÄŸil) */}
                        {!isKadroLocked && !isSquadLocked && (
                          <TouchableOpacity
                            style={[styles.removeButton, { pointerEvents: 'auto' }]}
                            onPress={(e) => {
                              e?.stopPropagation?.();
                              handleRemovePlayer(index);
                            }}
                            activeOpacity={0.7}
                            hitSlop={{ top: 12, bottom: 12, left: 12, right: 12 }}
                          >
                            <Ionicons name="close" size={16} color="#FFFFFF" />
                          </TouchableOpacity>
                        )}

                        {/* Player Card - Main */}
                        <TouchableOpacity
                          style={[
                            styles.playerCard,
                            // Gold border for elite players (85+)
                            normalizeRatingTo100(player.rating) >= 85 && styles.playerCardElite,
                            // Blue border for goalkeepers
                            isGoalkeeperPlayer(player) && styles.playerCardGK,
                            // âœ… Tercih Ã§erÃ§evesi (tahmin yapmayan kullanÄ±cÄ±lar iÃ§in)
                            (() => {
                              if (!autoGeneratedSquad || hasPrediction) return null;
                              const posData = autoGeneratedSquad.positions.find(p => p.player.id === player.id);
                              if (!posData) return null;
                              const borderStyle = getPreferenceBorderStyle(posData.preferencePercentage);
                              return {
                                borderColor: borderStyle.color,
                                borderWidth: borderStyle.width,
                              };
                            })(),
                          ]}
                          onPress={() => {
                            // âœ… Tercih popup'Ä± gÃ¶ster (tahmin yapmayan kullanÄ±cÄ±lar iÃ§in)
                            if (autoGeneratedSquad && !hasPrediction) {
                              const posData = autoGeneratedSquad.positions.find(p => p.player.id === player.id);
                              if (posData) {
                                setShowPreferencePopup({
                                  position: posData.position,
                                  positionLabel: posData.positionLabel,
                                  player: posData.player,
                                  preferencePercentage: posData.preferencePercentage,
                                  totalPreferences: posData.totalPreferences,
                                  allPreferences: posData.allPreferences,
                                });
                                return;
                              }
                            }
                            setSelectedPlayerForDetail(player);
                          }}
                          onLongPress={isKadroLocked ? undefined : () => handleRemovePlayer(index)}
                          activeOpacity={0.8}
                        >
                          <LinearGradient
                            colors={['#1E3A3A', '#0F2A24']} // âœ… Design System
                            style={styles.playerCardGradient}
                          >
                            {/* Injury/Alert Badge - Top Right */}
                            {player.injury && (
                              <View style={styles.alertBadge}>
                                <View style={styles.alertDot} />
                              </View>
                            )}

                            {/* Jersey Number Badge - Top Center */}
                            <View style={styles.jerseyNumberBadge}>
                              <Text style={styles.jerseyNumberText}>
                                {(player.number ?? player.shirt_number ?? player.jersey_number) != null && (player.number ?? player.shirt_number ?? player.jersey_number) > 0 ? (player.number ?? player.shirt_number ?? player.jersey_number) : '-'}
                              </Text>
                            </View>

                            {/* Player Name - Center: tam isim varsa gÃ¶ster, yoksa soyad */}
                            <Text style={styles.playerName} numberOfLines={1}>
                              {(player.firstname && player.lastname) ? `${String(player.firstname).trim()} ${String(player.lastname).trim()}` : (player.name || '')}
                            </Text>

                            {/* Rating and Position - Same row, bottom */}
                            <View style={styles.playerBottomRow}>
                              <Text style={styles.playerRatingBottom}>{formatRatingDisplay(player.rating)}</Text>
                              <Text style={styles.playerPositionBottom}>{positionLabel}</Text>
                            </View>

                            {/* Form indicator - Subtle glow */}
                            {player.form >= 8 && (
                              <View style={styles.formGlow} />
                            )}
                          </LinearGradient>
                        </TouchableOpacity>
                      </View>
                    );
                  })() : (
                    <TouchableOpacity
                      style={styles.emptySlot}
                      onPress={() => {
                        if (isKadroLocked) { showKadroLockedToast(); return; }
                        // âœ… KullanÄ±cÄ± kilidi kontrolÃ¼
                        if (isSquadLocked) {
                          // âœ… Topluluk verileri gÃ¶rÃ¼ldÃ¼yse kilit aÃ§Ä±lamaz
                          if (hasViewedCommunityData) {
                            showInfo(
                              'ğŸ”’ KalÄ±cÄ± Kilit',
                              'Topluluk verilerini gÃ¶rdÃ¼ÄŸÃ¼nÃ¼z iÃ§in kadro kilidi aÃ§Ä±lamaz. Tahminleriniz kalÄ±cÄ± olarak kilitlidir.'
                            );
                            return;
                          }
                          showAlert(
                            'ğŸ”’ Kadro Kilitli',
                            'Kadro tamamlandÄ± ve kilitli. DeÄŸiÅŸiklik yapmak iÃ§in kilidi aÃ§Ä±n.',
                            [
                              { text: 'Ä°ptal', style: 'cancel' },
                              { text: 'Kilidi AÃ§', style: 'destructive', onPress: () => setIsSquadLocked(false) },
                            ]
                          );
                          return;
                        }
                        setSelectedSlot(index);
                        setShowPlayerModal(true);
                      }}
                      activeOpacity={0.7}
                    >
                      <View style={styles.emptySlotContent}>
                        <Ionicons name="add" size={20} color="rgba(255, 255, 255, 0.7)" />
                        <Text style={styles.emptySlotText}>{positionLabel}</Text>
                      </View>
                    </TouchableOpacity>
                  )}
                </View>
              );
            })}
          </View>
        </FootballField>

        {/* âœ… KullanÄ±cÄ± tercih istatistikleri kartÄ± - Sol: KullanÄ±cÄ± sayÄ±sÄ±, SaÄŸ: Formasyonlar (2 satÄ±r, tÄ±klanabilir) */}
        {/* Saha altÄ±nda her zaman gÃ¶sterilir - tahmin yapÄ±lsÄ±n ya da yapÄ±lmasÄ±n */}
        {isVisible && (isMatchLive || isMatchFinished) && !showStartingXIPopup && userPreferenceStats && autoGeneratedSquad && (
          <View style={styles.preferenceStatsCardNew}>
            {/* Sol: KullanÄ±cÄ± sayÄ±sÄ± */}
            <TouchableOpacity 
              style={styles.preferenceStatsLeftSection}
              onPress={() => setShowFullPreferenceSummary(true)}
              activeOpacity={0.7}
            >
              <Ionicons name="people" size={16} color="#1FA2A6" />
              <Text style={styles.preferenceStatsUserCount}>
                {userPreferenceStats.totalUsers.toLocaleString()}
              </Text>
              <Text style={styles.preferenceStatsUserLabel}>kullanÄ±cÄ±</Text>
            </TouchableOpacity>
            
            {/* SaÄŸ: Formasyonlar (2 satÄ±r) */}
            <View style={styles.preferenceStatsRightSection}>
              {/* Atak Formasyonu - TÄ±klanabilir */}
              <TouchableOpacity 
                style={styles.preferenceFormationRowClickable}
                onPress={() => {
                  setShowFormationDetailPopup('attack');
                  setEditingMode('attack'); // âœ… Sahada atak formasyonunu gÃ¶ster
                  setViewSource('community'); // âœ… Topluluk verilerine gÃ¶re gÃ¶ster
                }}
                activeOpacity={0.7}
              >
                <Ionicons name="flash" size={12} color="#F59E0B" />
                <Text style={styles.preferenceFormationLabel}>Atak</Text>
                <Text style={styles.preferenceFormationValue}>{autoGeneratedSquad.attackFormation.formation}</Text>
                <Text style={styles.preferenceFormationPercent}>%{autoGeneratedSquad.attackFormation.percentage}</Text>
                <Ionicons name="chevron-forward" size={12} color="#6B7280" />
              </TouchableOpacity>
              
              {/* Defans Formasyonu - TÄ±klanabilir */}
              <TouchableOpacity 
                style={styles.preferenceFormationRowClickable}
                onPress={() => {
                  setShowFormationDetailPopup('defense');
                  setEditingMode('defense'); // âœ… Sahada defans formasyonunu gÃ¶ster
                  setViewSource('community'); // âœ… Topluluk verilerine gÃ¶re gÃ¶ster
                }}
                activeOpacity={0.7}
              >
                <Ionicons name="shield" size={12} color="#3B82F6" />
                <Text style={styles.preferenceFormationLabel}>Defans</Text>
                <Text style={styles.preferenceFormationValue}>{autoGeneratedSquad.defenseFormation.formation}</Text>
                <Text style={styles.preferenceFormationPercent}>%{autoGeneratedSquad.defenseFormation.percentage}</Text>
                <Ionicons name="chevron-forward" size={12} color="#6B7280" />
              </TouchableOpacity>
            </View>
          </View>
        )}

        {/* Kadro oluÅŸturulmadÄ±ÄŸÄ±nda: kompakt bildirim, tÄ±klanÄ±nca popup */}
        {showNoPredictionOverlay && (
          <>
            <TouchableOpacity
              activeOpacity={0.8}
              onPress={() => setShowNoSquadInfoModal(true)}
              style={{
                marginHorizontal: 12, marginTop: 8, marginBottom: 12,
                paddingVertical: 10, paddingHorizontal: 12,
                backgroundColor: 'rgba(31, 162, 166, 0.12)', borderRadius: 10,
                borderWidth: 1, borderColor: 'rgba(31, 162, 166, 0.25)',
                flexDirection: 'row', alignItems: 'center', gap: 8,
              }}
            >
              <Ionicons name="information-circle-outline" size={18} color="#1FA2A6" style={{ flexShrink: 0 }} />
              <Text style={{ color: '#5EEAD4', fontSize: 12, flex: 1 }} numberOfLines={2}>
                Kadro tahmini yapmadÄ±ÄŸÄ±nÄ±z iÃ§in tahmin yapamazsÄ±nÄ±z. Ä°zlemek iÃ§in ilgili sekmelere geÃ§in.
              </Text>
              <Ionicons name="chevron-forward" size={16} color="rgba(94, 234, 212, 0.7)" />
            </TouchableOpacity>
            <Modal visible={showNoSquadInfoModal} transparent animationType="fade">
              <TouchableOpacity activeOpacity={1} style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center', padding: 24 }} onPress={() => setShowNoSquadInfoModal(false)}>
                <TouchableOpacity activeOpacity={1} onPress={(e) => e.stopPropagation()} style={{ backgroundColor: '#1E3A3A', borderRadius: 16, padding: 20, borderWidth: 1, borderColor: 'rgba(31, 162, 166, 0.3)' }}>
                  <View style={{ flexDirection: 'row', alignItems: 'flex-start', gap: 10, marginBottom: 16 }}>
                    <Ionicons name="eye-outline" size={22} color="#1FA2A6" style={{ flexShrink: 0 }} />
                    <Text style={{ color: '#E2E8F0', fontSize: 14, lineHeight: 22, flex: 1 }}>
                      Kadro tahmini yapmadÄ±ÄŸÄ±nÄ±z iÃ§in tahmin yapamazsÄ±nÄ±z. Ä°zlemek iÃ§in aÅŸaÄŸÄ±daki sekmelere geÃ§in:
                    </Text>
                  </View>
                  {onNavigateToTab ? (
                    <View style={{ gap: 10 }}>
                      <TouchableOpacity onPress={() => { onNavigateToTab('prediction'); setShowNoSquadInfoModal(false); }} style={{ flexDirection: 'row', alignItems: 'center', gap: 8, paddingVertical: 10, paddingHorizontal: 12, backgroundColor: 'rgba(31, 162, 166, 0.2)', borderRadius: 10 }}>
                        <Ionicons name="analytics-outline" size={18} color="#5EEAD4" />
                        <View><Text style={{ color: '#5EEAD4', fontWeight: '600' }}>Tahmin</Text><Text style={{ color: 'rgba(94, 234, 212, 0.8)', fontSize: 12 }}>Topluluk / GerÃ§ek kadro</Text></View>
                      </TouchableOpacity>
                      <TouchableOpacity onPress={() => { onNavigateToTab('live'); setShowNoSquadInfoModal(false); }} style={{ flexDirection: 'row', alignItems: 'center', gap: 8, paddingVertical: 10, paddingHorizontal: 12, backgroundColor: 'rgba(31, 162, 166, 0.2)', borderRadius: 10 }}>
                        <Ionicons name="pulse-outline" size={18} color="#5EEAD4" />
                        <View><Text style={{ color: '#5EEAD4', fontWeight: '600' }}>CanlÄ±</Text><Text style={{ color: 'rgba(94, 234, 212, 0.8)', fontSize: 12 }}>Olaylar</Text></View>
                      </TouchableOpacity>
                      <TouchableOpacity onPress={() => { onNavigateToTab('stats'); setShowNoSquadInfoModal(false); }} style={{ flexDirection: 'row', alignItems: 'center', gap: 8, paddingVertical: 10, paddingHorizontal: 12, backgroundColor: 'rgba(31, 162, 166, 0.2)', borderRadius: 10 }}>
                        <Ionicons name="bar-chart-outline" size={18} color="#5EEAD4" />
                        <View><Text style={{ color: '#5EEAD4', fontWeight: '600' }}>Ä°statistik</Text><Text style={{ color: 'rgba(94, 234, 212, 0.8)', fontSize: 12 }}>CanlÄ± istatistikler</Text></View>
                      </TouchableOpacity>
                    </View>
                  ) : null}
                  <TouchableOpacity onPress={() => setShowNoSquadInfoModal(false)} style={{ marginTop: 16, paddingVertical: 10, alignItems: 'center', borderRadius: 10, backgroundColor: 'rgba(100, 116, 139, 0.2)' }}>
                    <Text style={{ color: '#94A3B8', fontWeight: '600' }}>Kapat</Text>
                  </TouchableOpacity>
                </TouchableOpacity>
              </TouchableOpacity>
            </Modal>
          </>
        )}

        {/* âœ… Saha altÄ±: Simetrik toolbar [Formasyon] | ğŸ”“ | [Tamamla] â€“ 5px yukarÄ± (Kadro sekmesi konteyner) */}
        {(hasPrediction || !isKadroLocked) && (
          <View style={[styles.bottomBar, { marginTop: 11 }, isLight && { backgroundColor: themeColors.muted, borderColor: themeColors.border }]}>
            <View style={styles.bottomBarLeft}>
              {/* SÄ°METRÄ°K TOOLBAR: [2 SatÄ±rlÄ± Formasyon] | ğŸ”“ | [Tamamla] */}
              <View style={styles.symmetricToolbar}>
                {/* Sol: 2 SatÄ±rlÄ± Formasyon Butonu */}
                <View style={[
                    styles.dualLineFormationButton,
                    isLight && { backgroundColor: themeColors.card, borderColor: themeColors.border },
                    isSquadLocked && { opacity: 0.5 } // âœ… Kilitliyken soluk gÃ¶ster
                  ]}>
                  {/* SatÄ±r 1: Atak - TÄ±klanÄ±nca sahada gÃ¶ster, kilit aÃ§Ä±ksa dÃ¼zenlenebilir */}
                  <TouchableOpacity
                    style={[
                      styles.formationLine,
                      editingMode === 'attack' && styles.formationLineActive
                    ]}
                    onPress={() => {
                      // âœ… Atak formasyonu varsa sahada gÃ¶ster
                      if (attackFormation) {
                        setEditingMode('attack');
                        setFormationType('attack');
                        // Kilit aÃ§Ä±ksa formasyon deÄŸiÅŸtirme popup'Ä± da aÃ§
                        if (!isSquadLocked) {
                          setShowFormationModal(true);
                        }
                      } else if (!isSquadLocked) {
                        // Formasyon yoksa ve kilit aÃ§Ä±ksa popup aÃ§
                        setFormationType('attack');
                        setShowFormationModal(true);
                      } else {
                        showInfo(t('matchSquad.squadLocked'), t('matchSquad.squadLockedSelectFormation'));
                      }
                    }}
                    activeOpacity={0.7}
                  >
                    <Ionicons name="flash" size={14} color={editingMode === 'attack' ? '#F59E0B' : (isLight ? themeColors.ring : '#1FA2A6')} />
                    <Text style={[
                      styles.formationLineText,
                      isLight && { color: themeColors.mutedForeground },
                      editingMode === 'attack' && (isLight ? styles.formationLineTextActive : styles.formationLineTextActive),
                      editingMode === 'attack' && isLight && { color: themeColors.foreground }
                    ]} numberOfLines={1}>
                      {attackFormation 
                        ? formations.find(f => f.id === attackFormation)?.name || attackFormation
                        : 'Formasyon SeÃ§'}
                    </Text>
                  </TouchableOpacity>
                  {/* SatÄ±r 2: Defans - TÄ±klanÄ±nca sahada gÃ¶ster, kilit aÃ§Ä±ksa dÃ¼zenlenebilir */}
                  <TouchableOpacity
                    style={[
                      styles.formationLine,
                      editingMode === 'defense' && styles.formationLineActive
                    ]}
                    onPress={() => {
                      // âœ… Ã–nce atak formasyonu olmalÄ±
                      if (!attackFormation) {
                        showInfo(t('matchSquad.firstAttack'), t('matchSquad.selectDefenseFirst'));
                        return;
                      }
                      
                      // âœ… Defans formasyonu varsa sahada gÃ¶ster
                      if (defenseFormation) {
                        setEditingMode('defense');
                        setFormationType('defense');
                        // Kilit aÃ§Ä±ksa formasyon deÄŸiÅŸtirme popup'Ä± da aÃ§
                        if (!isSquadLocked) {
                          setShowFormationModal(true);
                        }
                      } else if (!isSquadLocked) {
                        // Defans formasyonu yoksa ve kilit aÃ§Ä±ksa popup aÃ§
                        setFormationType('defense');
                        setShowFormationModal(true);
                      } else {
                        showInfo(t('matchSquad.squadLocked'), t('matchSquad.squadLockedSelectFormation'));
                      }
                    }}
                    activeOpacity={0.7}
                  >
                    <Ionicons name="shield" size={14} color={editingMode === 'defense' ? '#3B82F6' : (isLight ? themeColors.ring : '#1FA2A6')} />
                    <Text style={[
                      styles.formationLineText,
                      isLight && { color: themeColors.mutedForeground },
                      editingMode === 'defense' && styles.formationLineTextActive,
                      editingMode === 'defense' && isLight && { color: themeColors.foreground }
                    ]} numberOfLines={1}>
                      {defenseFormation 
                        ? formations.find(f => f.id === defenseFormation)?.name || defenseFormation
                        : ''}
                    </Text>
                  </TouchableOpacity>
                </View>

                {/* Orta: Kilit - Her zaman gÃ¶rÃ¼nÃ¼r. MaÃ§ baÅŸladÄ±/bitince aÃ§Ä±lamaz (kalÄ±cÄ± kilit). */}
                <TouchableOpacity
                  style={[
                    styles.lockButtonCenter,
                    (isSquadLocked || isKadroLocked) ? styles.lockButtonCenterLocked : styles.lockButtonCenterOpen,
                    hasViewedCommunityData && isSquadLocked && { opacity: 0.5 },
                    isKadroLocked && { opacity: 0.9 }
                  ]}
                  onPress={() => {
                    // MaÃ§ baÅŸladÄ± veya bittiyse kilit asla aÃ§Ä±lmaz
                    if (isKadroLocked) {
                      showInfo('ğŸ”’ ' + t('matchSquad.squadLocked'), t('matchSquad.lockCannotOpen'));
                      return;
                    }
                    if (isSquadLocked) {
                      if (hasViewedCommunityData) {
                        showInfo(
                          'ğŸ”’ KalÄ±cÄ± Kilit',
                          'Topluluk verilerini gÃ¶rdÃ¼ÄŸÃ¼nÃ¼z iÃ§in kadro kilidi aÃ§Ä±lamaz. Tahminleriniz kalÄ±cÄ± olarak kilitlidir.'
                        );
                        return;
                      }
                      setIsSquadLocked(false);
                      setHasModifiedSinceUnlock(false);
                    } else {
                      if (isCompleteButtonActive) {
                        handleComplete();
                      } else {
                        showInfo(t('matchSquad.squadLocked'), t('matchSquad.incompleteSquad'));
                      }
                    }
                  }}
                  activeOpacity={(hasViewedCommunityData && isSquadLocked) || isKadroLocked ? 1 : 0.7}
                >
                  <Ionicons 
                    name={(isSquadLocked || isKadroLocked) ? "lock-closed" : "lock-open"} 
                    size={20} 
                    color={(isSquadLocked || isKadroLocked) ? '#EF4444' : '#10B981'} 
                  />
                </TouchableOpacity>

                {/* SaÄŸ: Tamamla - Her zaman gÃ¶rÃ¼nÃ¼r. MaÃ§ baÅŸladÄ±/bitince veya kilitliyken inaktif */}
                <TouchableOpacity
                  style={[
                    styles.completeButtonSymmetric,
                    isLight && (isSquadLocked || !isCompleteButtonActive || isKadroLocked) && { backgroundColor: themeColors.border, opacity: 0.8 },
                    isLight && !(isSquadLocked || !isCompleteButtonActive || isKadroLocked) && { backgroundColor: themeColors.ring || '#1FA2A6' },
                    !isLight && (isSquadLocked || !isCompleteButtonActive || isKadroLocked) && styles.completeButtonSymmetricDisabled,
                  ]}
                  onPress={handleComplete}
                  disabled={isSquadLocked || !isCompleteButtonActive || isKadroLocked}
                  activeOpacity={0.8}
                >
                  <Text style={[
                    styles.completeButtonSymmetricText,
                    isLight && { color: (isSquadLocked || !isCompleteButtonActive || isKadroLocked) ? themeColors.mutedForeground : themeColors.primaryForeground || '#FFFFFF' },
                    (isSquadLocked || !isCompleteButtonActive || isKadroLocked) && !isLight && { opacity: 0.5 }
                  ]}>Tamamla</Text>
                  <Ionicons 
                    name="checkmark-circle" 
                    size={18} 
                    color={(isSquadLocked || !isCompleteButtonActive || isKadroLocked) ? (isLight ? themeColors.mutedForeground : 'rgba(255,255,255,0.5)') : (isLight ? themeColors.primaryForeground || '#FFFFFF' : '#FFFFFF')} 
                  />
                </TouchableOpacity>
              </View>
          </View>
        </View>
        )}
      </View>

      {/* Player Selection Modal - Defans: sadece atak 11'i. CanlÄ± maÃ§ta atak: sadece mevcut 11 (formasyon/yerleÅŸim deÄŸiÅŸikliÄŸi aynÄ± 11 ile). */}
      <PlayerModal
        visible={showPlayerModal}
        players={editingMode === 'defense' && attackSquadPlayers.length === 11
          ? attackSquadPlayers.filter((p: any) =>
              !Object.entries(defensePlayers).some(([i, pl]) => Number(i) !== selectedSlot && pl?.id === p.id)
            )
          : editingMode === 'attack' && isMatchLive && attackSquadPlayers.length === 11
            ? attackSquadPlayers.filter((p: any) =>
                !Object.entries(attackPlayers).some(([i, pl]) => Number(i) !== selectedSlot && pl?.id === p.id)
              )
            : attackTeamPlayers}
        selectedPlayers={selectedPlayers}
        positionLabel={selectedSlot !== null ? formation?.positions[selectedSlot] : ''}
        onSelect={handlePlayerSelect}
        onClose={() => {
          setShowPlayerModal(false);
          setSelectedSlot(null);
        }}
        isDefenseMode={editingMode === 'defense'}
        isLoadingSquad={isLoadingSquad}
        loadingFromApi={squadLoadingFromApi}
        hasBackendError={!isLoadingSquad && squadPlayers.length === 0 && !lineups?.length && editingMode === 'attack'}
        onRetrySquad={retrySquadFetch}
        communityDataVisible={communityDataVisible}
      />

      {/* âœ… Ä°lk 11 Popup - MaÃ§ baÅŸladÄ±ÄŸÄ±nda gÃ¶sterilir */}
      <Modal
        visible={showStartingXIPopup}
        animationType="fade"
        transparent={true}
        onRequestClose={handleStartingXIPopupClose}
      >
        <View style={styles.startingXIPopupOverlay}>
          <View style={styles.startingXIPopupModal}>
            <LinearGradient
              colors={['#0F2A24', '#1E3A3A', '#0F2A24']}
              style={styles.startingXIPopupGradient}
            >
              {/* Header */}
              <View style={styles.startingXIPopupHeader}>
                <View style={styles.startingXIPopupTitleRow}>
                  <Ionicons name="football" size={20} color="#1FA2A6" />
                  <Text style={styles.startingXIPopupTitle}>Ä°lk 11 Kadrosu</Text>
                </View>
                <TouchableOpacity onPress={handleStartingXIPopupClose}>
                  <Ionicons name="close-circle" size={24} color="#9CA3AF" />
                </TouchableOpacity>
              </View>
              
              {/* TakÄ±m Bilgisi */}
              {userPreferenceStats && (
                <View style={styles.startingXIPopupTeamInfo}>
                  <Text style={styles.startingXIPopupTeamName}>{userPreferenceStats.teamName}</Text>
                  <Text style={styles.startingXIPopupTeamSubtext}>
                    Topluluk tercihleri ile oluÅŸturuldu
                  </Text>
                </View>
              )}
              
              {/* Oyuncu Listesi - Scroll yok, tek ekranda */}
              <View style={styles.startingXIPopupPlayerList}>
                {startingXIPlayers.map((playerItem: any, idx: number) => {
                  const player = playerItem.player;
                  const isGK = isGoalkeeperPlayer(player);
                  const posData = autoGeneratedSquad?.positions.find(p => p.player.id === player.id);
                  const borderStyle = posData ? getPreferenceBorderStyle(posData.preferencePercentage) : null;
                  
                  return (
                    <View 
                      key={player.id || idx} 
                      style={[
                        styles.startingXIPopupPlayerItem,
                        isGK && styles.startingXIPopupPlayerItemGK,
                        borderStyle && { borderLeftColor: borderStyle.color, borderLeftWidth: borderStyle.width }
                      ]}
                    >
                      <View style={styles.startingXIPopupPlayerNumber}>
                        <Text style={styles.startingXIPopupPlayerNumberText}>{player.number || '?'}</Text>
                      </View>
                      <View style={styles.startingXIPopupPlayerInfo}>
                        <Text style={styles.startingXIPopupPlayerName}>
                        {(player.firstname && player.lastname) ? `${String(player.firstname).trim()} ${String(player.lastname).trim()}` : (player.name || 'Bilinmiyor')}
                      </Text>
                        <Text style={styles.startingXIPopupPlayerPosition}>
                          {posData?.positionLabel || player.pos || player.position || 'Pozisyon'}
                        </Text>
                      </View>
                      {posData && (
                        <View style={[styles.startingXIPopupPlayerPercent, { backgroundColor: borderStyle?.color }]}>
                          <Text style={styles.startingXIPopupPlayerPercentText}>%{posData.preferencePercentage}</Text>
                        </View>
                      )}
                    </View>
                  );
                })}
              </View>
              
              {/* Footer */}
              <View style={styles.startingXIPopupFooter}>
                <Text style={styles.startingXIPopupFooterText}>
                  X tuÅŸuna basarak sahaya geÃ§ebilirsiniz
                </Text>
              </View>
            </LinearGradient>
          </View>
        </View>
      </Modal>

      {/* âœ… "Tahminlerinizi TamamlayÄ±n" popup'Ä± kaldÄ±rÄ±ldÄ± */}
      {/* MaÃ§ baÅŸladÄ±ktan sonra sayfayÄ± aÃ§anlar iÃ§in normal "Ä°lk 11" popup'Ä± gÃ¶sterilir */}
      {/* KullanÄ±cÄ± popup'Ä± kapatÄ±nca kadro sekmesinde Ã§alÄ±ÅŸmaya devam edebilir */}

      {/* âœ… Tercih Ä°statistikleri Popup - Oyuncu pozisyon tercihlerini gÃ¶sterir */}
      <Modal
        visible={showPreferencePopup !== null}
        animationType="fade"
        transparent={true}
        onRequestClose={() => { setShowPreferencePopup(null); setShowPlayerRatingDropdown(false); }}
      >
        <TouchableOpacity 
          style={styles.preferencePopupOverlay} 
          activeOpacity={1} 
          onPress={() => { setShowPreferencePopup(null); setShowPlayerRatingDropdown(false); }}
        >
          <View style={styles.preferencePopupModal}>
            <LinearGradient
              colors={['#1A2E2A', '#0F2420']}
              style={styles.preferencePopupGradient}
            >
              {/* Header */}
              <View style={styles.preferencePopupHeader}>
                <View style={styles.preferencePopupTitleRow}>
                  <Ionicons name="people" size={20} color="#1FA2A6" />
                  <Text style={styles.preferencePopupTitle}>Topluluk Tercihleri</Text>
                </View>
                <TouchableOpacity onPress={() => { setShowPreferencePopup(null); setShowPlayerRatingDropdown(false); }}>
                  <Ionicons name="close-circle" size={24} color="#9CA3AF" />
                </TouchableOpacity>
              </View>
              
              {/* Pozisyon Bilgisi */}
              <View style={styles.preferencePopupPositionInfo}>
                <Text style={styles.preferencePopupPositionLabel}>{showPreferencePopup?.positionLabel}</Text>
                <Text style={styles.preferencePopupPlayerName}>
                {showPreferencePopup?.player && (showPreferencePopup.player.firstname && showPreferencePopup.player.lastname)
                  ? `${String(showPreferencePopup.player.firstname).trim()} ${String(showPreferencePopup.player.lastname).trim()}`
                  : (showPreferencePopup?.player?.name || '')}
              </Text>
                <View style={styles.preferencePopupBadge}>
                  <Text style={styles.preferencePopupBadgeText}>%{showPreferencePopup?.preferencePercentage}</Text>
                </View>
              </View>
              
              {/* TÃ¼m Tercihler */}
              <View style={styles.preferencePopupList}>
                <Text style={styles.preferencePopupListTitle}>TÃ¼m Tercihler</Text>
                {showPreferencePopup?.allPreferences.map((pref, idx) => {
                  const isSelected = pref.playerId === showPreferencePopup?.player.id;
                  const borderStyle = getPreferenceBorderStyle(pref.percentage);
                  return (
                    <View 
                      key={pref.playerId} 
                      style={[
                        styles.preferencePopupItem,
                        isSelected && styles.preferencePopupItemSelected,
                        { borderLeftColor: borderStyle.color, borderLeftWidth: borderStyle.width }
                      ]}
                    >
                      <Text style={styles.preferencePopupItemRank}>#{idx + 1}</Text>
                      <Text style={[styles.preferencePopupItemName, isSelected && styles.preferencePopupItemNameSelected]}>
                        {pref.playerName}
                      </Text>
                      <View style={styles.preferencePopupItemStats}>
                        <Text style={styles.preferencePopupItemCount}>{pref.count.toLocaleString()} oy</Text>
                        <Text style={[styles.preferencePopupItemPercentage, { color: borderStyle.color }]}>
                          %{pref.percentage}
                        </Text>
                      </View>
                    </View>
                  );
                })}
              </View>
              
              {/* Toplam */}
              <View style={styles.preferencePopupTotal}>
                <Ionicons name="stats-chart" size={14} color="#9CA3AF" />
                <Text style={styles.preferencePopupTotalText}>
                  Toplam {showPreferencePopup?.totalPreferences.toLocaleString()} tercih
                </Text>
              </View>
              
              {/* âœ… Oyuncu DetaylÄ± Reyting Dropdown */}
              <TouchableOpacity 
                style={styles.playerRatingDropdownHeader}
                onPress={() => setShowPlayerRatingDropdown(!showPlayerRatingDropdown)}
                activeOpacity={0.7}
              >
                <View style={styles.playerRatingDropdownHeaderLeft}>
                  <Ionicons name="star" size={16} color="#C9A44C" />
                  <Text style={styles.playerRatingDropdownHeaderText}>Topluluk DeÄŸerlendirmesi</Text>
                </View>
                <View style={styles.playerRatingDropdownHeaderRight}>
                  <Text style={styles.playerRatingDropdownAvg}>
                    {(() => {
                      // Mock: Oyuncu iÃ§in ortalama reyting
                      const categories = [7.2, 6.8, 7.5, 6.3, 7.0, 6.9, 7.1, 6.7, 7.3];
                      const avg = categories.reduce((a, b) => a + b, 0) / categories.length;
                      return avg.toFixed(1);
                    })()}
                  </Text>
                  <Ionicons 
                    name={showPlayerRatingDropdown ? "chevron-up" : "chevron-down"} 
                    size={18} 
                    color="#C9A44C" 
                  />
                </View>
              </TouchableOpacity>
              
              {showPlayerRatingDropdown && (
                <View style={styles.playerRatingDropdownContent}>
                  {(() => {
                    // âœ… Kaleci mi kontrol et (pozisyon GK ise)
                    const isGoalkeeper = showPreferencePopup?.positionLabel?.toUpperCase() === 'GK' || 
                                         showPreferencePopup?.positionLabel?.toLowerCase().includes('kaleci');
                    
                    // âœ… Kaleci Ã¶zellikleri
                    const goalkeeperCategories = [
                      { id: 'diving', emoji: 'ğŸ§¤', title: 'DalÄ±ÅŸ', rating: 7.8, voters: 1842 },
                      { id: 'reflexes', emoji: 'âš¡', title: 'Refleks', rating: 8.2, voters: 1756 },
                      { id: 'handling', emoji: 'ğŸ¤²', title: 'Top Tutma', rating: 7.5, voters: 1821 },
                      { id: 'positioning', emoji: 'ğŸ“', title: 'Konumlanma', rating: 7.6, voters: 1689 },
                      { id: 'kicking', emoji: 'ğŸ¦µ', title: 'Uzun Top', rating: 6.8, voters: 1734 },
                      { id: 'communication', emoji: 'ğŸ“¢', title: 'Ä°letiÅŸim', rating: 7.2, voters: 1798 },
                      { id: 'aerialReach', emoji: 'ğŸ™Œ', title: 'Hava Topu', rating: 7.9, voters: 1667 },
                      { id: 'oneOnOne', emoji: 'ğŸ¯', title: 'Bire Bir', rating: 7.4, voters: 1712 },
                      { id: 'concentration', emoji: 'ğŸ§ ', title: 'Konsantrasyon', rating: 7.7, voters: 1745 },
                    ];
                    
                    // âœ… Saha oyuncusu Ã¶zellikleri
                    const outfieldCategories = [
                      { id: 'shooting', emoji: 'ğŸ¯', title: 'Åut', rating: 7.2, voters: 1842 },
                      { id: 'passing', emoji: 'ğŸŒ€', title: 'Pas', rating: 6.8, voters: 1756 },
                      { id: 'dribbling', emoji: 'ğŸŒ€', title: 'Dribling', rating: 7.5, voters: 1821 },
                      { id: 'defense', emoji: 'ğŸ›¡ï¸', title: 'Savunma', rating: 6.3, voters: 1689 },
                      { id: 'physical', emoji: 'ğŸ’ª', title: 'Fizik', rating: 7.0, voters: 1734 },
                      { id: 'speed', emoji: 'âš¡', title: 'HÄ±z', rating: 6.9, voters: 1798 },
                      { id: 'vision', emoji: 'ğŸ‘ï¸', title: 'Vizyon', rating: 7.1, voters: 1667 },
                      { id: 'positioning', emoji: 'ğŸ“', title: 'Konumlanma', rating: 6.7, voters: 1712 },
                      { id: 'stamina', emoji: 'ğŸ”‹', title: 'DayanÄ±klÄ±lÄ±k', rating: 7.3, voters: 1745 },
                    ];
                    
                    const categories = isGoalkeeper ? goalkeeperCategories : outfieldCategories;
                    
                    return categories.map((cat) => (
                      <View key={cat.id} style={styles.playerRatingDropdownRow}>
                        <View style={styles.playerRatingDropdownRowLeft}>
                          <Text style={styles.playerRatingDropdownEmoji}>{cat.emoji}</Text>
                          <Text style={styles.playerRatingDropdownTitle}>{cat.title}</Text>
                        </View>
                        <View style={styles.playerRatingDropdownRowRight}>
                          <View style={styles.playerRatingDropdownBar}>
                            <View 
                              style={[
                                styles.playerRatingDropdownBarFill, 
                                { 
                                  width: `${(cat.rating / 10) * 100}%`,
                                  backgroundColor: cat.rating >= 7 ? '#10B981' : cat.rating >= 5 ? '#F59E0B' : '#EF4444'
                                }
                              ]} 
                            />
                          </View>
                          <Text style={[
                            styles.playerRatingDropdownValue,
                            { color: cat.rating >= 7 ? '#10B981' : cat.rating >= 5 ? '#F59E0B' : '#EF4444' }
                          ]}>{cat.rating.toFixed(1)}</Text>
                          <Text style={styles.playerRatingDropdownVoters}>{cat.voters}</Text>
                        </View>
                      </View>
                    ));
                  })()}
                </View>
              )}
            </LinearGradient>
          </View>
        </TouchableOpacity>
      </Modal>

      {/* âœ… Tam Tercih Ã–zeti Popup - TÃ¼m pozisyonlar ve formasyonlar */}
      <Modal
        visible={showFullPreferenceSummary}
        animationType="slide"
        transparent={true}
        onRequestClose={() => setShowFullPreferenceSummary(false)}
      >
        <View style={styles.fullPreferenceSummaryOverlay}>
          <View style={styles.fullPreferenceSummaryModal}>
            <LinearGradient
              colors={['#1A2E2A', '#0F2420']}
              style={styles.fullPreferenceSummaryGradient}
            >
              {/* Header */}
              <View style={styles.fullPreferenceSummaryHeader}>
                <View style={styles.preferencePopupTitleRow}>
                  <Ionicons name="stats-chart" size={20} color="#1FA2A6" />
                  <Text style={styles.preferencePopupTitle}>Topluluk Tercih Ã–zeti</Text>
                </View>
                <TouchableOpacity onPress={() => setShowFullPreferenceSummary(false)}>
                  <Ionicons name="close-circle" size={24} color="#9CA3AF" />
                </TouchableOpacity>
              </View>
              
              {/* KullanÄ±cÄ± SayÄ±sÄ± */}
              <View style={styles.fullPreferenceSummaryUserCount}>
                <Ionicons name="people" size={16} color="#10B981" />
                <Text style={styles.fullPreferenceSummaryUserCountText}>
                  {userPreferenceStats?.totalUsers.toLocaleString()} kullanÄ±cÄ±nÄ±n tercihleri
                </Text>
              </View>
              
              <ScrollView style={styles.fullPreferenceSummaryScroll} showsVerticalScrollIndicator={false}>
                {/* Formasyon Tercihleri */}
                <View style={styles.fullPreferenceSummarySection}>
                  <Text style={styles.fullPreferenceSummarySectionTitle}>
                    <Ionicons name="grid" size={14} color="#F59E0B" /> Formasyon Tercihleri
                  </Text>
                  
                  {/* Atak FormasyonlarÄ± - Top 2 Ã–zet */}
                  <TouchableOpacity 
                    style={styles.fullPreferenceFormationGroup}
                    onPress={() => {
                      setShowFullPreferenceSummary(false);
                      setShowFormationDetailPopup('attack');
                      setEditingMode('attack');
                      setViewSource('community');
                    }}
                    activeOpacity={0.7}
                  >
                    <View style={styles.fullPreferenceFormationGroupHeader}>
                      <Text style={styles.fullPreferenceFormationGroupTitle}>
                        <Ionicons name="flash" size={12} color="#F59E0B" /> Atak
                      </Text>
                      <View style={styles.fullPreferenceFormationGroupArrow}>
                        <Text style={styles.fullPreferenceFormationGroupArrowText}>Detay</Text>
                        <Ionicons name="chevron-forward" size={14} color="#F59E0B" />
                      </View>
                    </View>
                    {userPreferenceStats?.attackFormation.stats.slice(0, 2).map((f, idx) => (
                      <View key={f.formation} style={[
                        styles.fullPreferenceFormationItem,
                        idx === 0 && styles.fullPreferenceFormationItemFirst
                      ]}>
                        <Text style={styles.fullPreferenceFormationItemRank}>#{idx + 1}</Text>
                        <Text style={[
                          styles.fullPreferenceFormationItemName,
                          idx === 0 && styles.fullPreferenceFormationItemNameFirst
                        ]}>{f.formation}</Text>
                        <Text style={styles.fullPreferenceFormationItemCount}>{f.count.toLocaleString()}</Text>
                        <Text style={[
                          styles.fullPreferenceFormationItemPercentage,
                          idx === 0 && { color: '#10B981' }
                        ]}>%{f.percentage}</Text>
                      </View>
                    ))}
                  </TouchableOpacity>
                  
                  {/* Defans FormasyonlarÄ± - Top 2 Ã–zet */}
                  <TouchableOpacity 
                    style={styles.fullPreferenceFormationGroup}
                    onPress={() => {
                      setShowFullPreferenceSummary(false);
                      setShowFormationDetailPopup('defense');
                      setEditingMode('defense');
                      setViewSource('community');
                    }}
                    activeOpacity={0.7}
                  >
                    <View style={styles.fullPreferenceFormationGroupHeader}>
                      <Text style={styles.fullPreferenceFormationGroupTitle}>
                        <Ionicons name="shield" size={12} color="#3B82F6" /> Defans
                      </Text>
                      <View style={styles.fullPreferenceFormationGroupArrow}>
                        <Text style={[styles.fullPreferenceFormationGroupArrowText, { color: '#3B82F6' }]}>Detay</Text>
                        <Ionicons name="chevron-forward" size={14} color="#3B82F6" />
                      </View>
                    </View>
                    {userPreferenceStats?.defenseFormation.stats.slice(0, 2).map((f, idx) => (
                      <View key={f.formation} style={[
                        styles.fullPreferenceFormationItem,
                        idx === 0 && styles.fullPreferenceFormationItemFirst
                      ]}>
                        <Text style={styles.fullPreferenceFormationItemRank}>#{idx + 1}</Text>
                        <Text style={[
                          styles.fullPreferenceFormationItemName,
                          idx === 0 && styles.fullPreferenceFormationItemNameFirst
                        ]}>{f.formation}</Text>
                        <Text style={styles.fullPreferenceFormationItemCount}>{f.count.toLocaleString()}</Text>
                        <Text style={[
                          styles.fullPreferenceFormationItemPercentage,
                          idx === 0 && { color: '#10B981' }
                        ]}>%{f.percentage}</Text>
                      </View>
                    ))}
                  </TouchableOpacity>
                </View>
                
                {/* âœ… Pozisyon tercihleri bu popup'tan KALDIRILDI - detay popup'ta gÃ¶sterilecek */}
                {/* Bilgi notu */}
                <View style={styles.fullPreferenceSummaryNote}>
                  <Ionicons name="information-circle" size={14} color="#9CA3AF" />
                  <Text style={styles.fullPreferenceSummaryNoteText}>
                    Pozisyon detaylarÄ± iÃ§in Atak veya Defans formasyonuna tÄ±klayÄ±n
                  </Text>
                </View>
              </ScrollView>
            </LinearGradient>
          </View>
        </View>
      </Modal>

      {/* âœ… Formasyon Detay Popup - Atak veya Defans formasyon detaylarÄ± */}
      <Modal
        visible={showFormationDetailPopup !== null}
        animationType="slide"
        transparent={true}
        onRequestClose={() => {
          setShowFormationDetailPopup(null);
          // Popup kapatÄ±ldÄ±ÄŸÄ±nda da topluluk verilerine gÃ¶re gÃ¶ster
          setViewSource('community');
        }}
      >
        <View style={styles.formationDetailOverlay}>
          <View style={styles.formationDetailModal}>
            <LinearGradient
              colors={['#0F2A24', '#1E3A3A', '#0F2A24']}
              style={styles.formationDetailGradient}
            >
              {/* Header with Tabs */}
              <View style={styles.formationDetailHeader}>
                <Text style={styles.formationDetailTitle}>
                  {showFormationDetailPopup === 'attack' ? 'âš¡ Atak Formasyonu' : 'ğŸ›¡ï¸ Defans Formasyonu'}
                </Text>
                <TouchableOpacity onPress={() => {
                  setShowFormationDetailPopup(null);
                  // Popup kapatÄ±ldÄ±ÄŸÄ±nda da topluluk verilerine gÃ¶re gÃ¶ster
                  setViewSource('community');
                }}>
                  <Ionicons name="close-circle" size={24} color="#9CA3AF" />
                </TouchableOpacity>
              </View>
              
              {/* Tab Buttons */}
              <View style={styles.formationDetailTabs}>
                <TouchableOpacity 
                  style={[
                    styles.formationDetailTab, 
                    showFormationDetailPopup === 'attack' && styles.formationDetailTabActive
                  ]}
                  onPress={() => {
                    setShowFormationDetailPopup('attack');
                    setEditingMode('attack'); // âœ… Sahada atak formasyonunu gÃ¶ster
                    setViewSource('community'); // âœ… Topluluk verilerine gÃ¶re gÃ¶ster
                  }}
                >
                  <Ionicons name="flash" size={14} color={showFormationDetailPopup === 'attack' ? '#F59E0B' : '#6B7280'} />
                  <Text style={[
                    styles.formationDetailTabText,
                    showFormationDetailPopup === 'attack' && styles.formationDetailTabTextActive
                  ]}>Atak</Text>
                </TouchableOpacity>
                <TouchableOpacity 
                  style={[
                    styles.formationDetailTab, 
                    showFormationDetailPopup === 'defense' && styles.formationDetailTabActive
                  ]}
                  onPress={() => {
                    setShowFormationDetailPopup('defense');
                    setEditingMode('defense'); // âœ… Sahada defans formasyonunu gÃ¶ster
                    setViewSource('community'); // âœ… Topluluk verilerine gÃ¶re gÃ¶ster
                  }}
                >
                  <Ionicons name="shield" size={14} color={showFormationDetailPopup === 'defense' ? '#3B82F6' : '#6B7280'} />
                  <Text style={[
                    styles.formationDetailTabText,
                    showFormationDetailPopup === 'defense' && styles.formationDetailTabTextActive
                  ]}>Defans</Text>
                </TouchableOpacity>
              </View>
              
              <ScrollView style={styles.formationDetailScroll} showsVerticalScrollIndicator={false}>
                {/* SeÃ§ilen Formasyon */}
                <View style={styles.formationDetailSelected}>
                  <Text style={styles.formationDetailSelectedLabel}>SeÃ§ilen Formasyon</Text>
                  <Text style={styles.formationDetailSelectedValue}>
                    {showFormationDetailPopup === 'attack' 
                      ? autoGeneratedSquad?.attackFormation.formation 
                      : autoGeneratedSquad?.defenseFormation.formation}
                  </Text>
                  <View style={styles.formationDetailSelectedBadge}>
                    <Text style={styles.formationDetailSelectedBadgeText}>
                      %{showFormationDetailPopup === 'attack' 
                          ? autoGeneratedSquad?.attackFormation.percentage 
                          : autoGeneratedSquad?.defenseFormation.percentage}
                    </Text>
                  </View>
                </View>
                
                {/* Top 3 Formasyonlar */}
                <View style={styles.formationDetailSection}>
                  <Text style={styles.formationDetailSectionTitle}>En Ã‡ok Tercih Edilen Formasyonlar</Text>
                  {(showFormationDetailPopup === 'attack' 
                    ? userPreferenceStats?.attackFormation.stats 
                    : userPreferenceStats?.defenseFormation.stats
                  )?.slice(0, 4).map((f, idx) => {
                    const isFirst = idx === 0;
                    return (
                      <View key={f.formation} style={[
                        styles.formationDetailItem,
                        isFirst && styles.formationDetailItemFirst
                      ]}>
                        <Text style={[styles.formationDetailItemRank, isFirst && { color: '#10B981' }]}>#{idx + 1}</Text>
                        <Text style={[styles.formationDetailItemName, isFirst && { color: '#10B981', fontWeight: '700' }]}>
                          {f.formation}
                        </Text>
                        <Text style={styles.formationDetailItemCount}>
                          {f.count.toLocaleString()} oy
                        </Text>
                        <View style={[
                          styles.formationDetailItemPercentBadge,
                          isFirst && { backgroundColor: 'rgba(16, 185, 129, 0.2)' }
                        ]}>
                          <Text style={[
                            styles.formationDetailItemPercent,
                            isFirst && { color: '#10B981' }
                          ]}>%{f.percentage}</Text>
                        </View>
                      </View>
                    );
                  })}
                </View>
                
                {/* Pozisyon Tercihleri - Pozisyon gruplarÄ±na gÃ¶re renklendirme */}
                <View style={styles.formationDetailSection}>
                  <Text style={styles.formationDetailSectionTitle}>Oyuncu Pozisyon Tercihleri (Top 3)</Text>
                  {autoGeneratedSquad?.positions.map((pos) => {
                    const positionColor = getPositionGroupColor(pos.position);
                    return (
                      <View 
                        key={pos.position} 
                        style={[
                          styles.formationDetailPositionGroup,
                          { backgroundColor: positionColor.background, borderColor: `${positionColor.primary}30` }
                        ]}
                      >
                        <View style={styles.formationDetailPositionHeader}>
                          <Text style={[styles.formationDetailPositionLabel, { color: positionColor.text }]}>
                            {pos.positionLabel}
                          </Text>
                          <View style={[styles.formationDetailPositionBadge, { backgroundColor: positionColor.primary }]}>
                            <Text style={styles.formationDetailPositionBadgeText}>%{pos.preferencePercentage}</Text>
                          </View>
                        </View>
                        {pos.allPreferences.slice(0, 3).map((pref, idx) => {
                          const isFirst = idx === 0;
                          return (
                            <View key={pref.playerId} style={[
                              styles.formationDetailPositionItem,
                              isFirst && styles.formationDetailPositionItemFirst,
                              { borderLeftColor: isFirst ? positionColor.primary : `${positionColor.primary}60`, borderLeftWidth: isFirst ? 3 : 2 }
                            ]}>
                              <Text style={[styles.formationDetailPositionItemRank, { color: positionColor.secondary }]}>#{idx + 1}</Text>
                              <Text style={[
                                styles.formationDetailPositionItemName,
                                isFirst && { color: positionColor.text, fontWeight: '700' }
                              ]}>{pref.playerName}</Text>
                              <Text style={styles.formationDetailPositionItemCount}>{pref.count.toLocaleString()}</Text>
                              <Text style={[styles.formationDetailPositionItemPercent, { color: positionColor.secondary }]}>
                                %{pref.percentage}
                              </Text>
                            </View>
                          );
                        })}
                      </View>
                    );
                  })}
                </View>
              </ScrollView>
            </LinearGradient>
          </View>
        </View>
      </Modal>
      {/* âœ… Community Signal Popup - Shows when user initiates player replacement */}
      <CommunitySignalPopup
        visible={showCommunitySignal}
        onClose={() => setShowCommunitySignal(false)}
        onSelectReplacement={(player) => {
          // When user selects a replacement from community suggestions
          if (selectedSlot !== null) {
            handlePlayerSelect(player);
          }
          setShowCommunitySignal(false);
        }}
        matchId={parseInt(matchId, 10) || 0}
        teamId={effectivePredictionTeamId ?? predictionTeamId ?? attackTeamId ?? 0}
        currentPlayer={communitySignalPlayer}
        userLineup={selectedPlayers}
        formationId={selectedFormation || '4-3-3'}
        availablePlayers={editingMode === 'defense' || (isMatchLive && attackSquadPlayers.length === 11) ? attackSquadPlayers : attackTeamPlayers}
      />

      {/* Formation Modal - Defans sekmesi sadece atak formasyonu seÃ§ilip 11 oyuncu yerleÅŸtirildiyse aktif */}
      <FormationModal
        visible={showFormationModal}
        formations={formations}
        formationType={formationType}
        onSelect={handleFormationSelect}
        onClose={() => {
          setShowFormationModal(false);
          // âœ… Popup kapatÄ±ldÄ±ÄŸÄ±nda formationType'a gÃ¶re editingMode ayarla
          setEditingMode(formationType === 'defense' ? 'defense' : 'attack');
        }}
        onTabChange={(type: string) => {
          setFormationType(type);
          // âœ… Popup'taki tab deÄŸiÅŸince sahada da doÄŸru formasyon gÃ¶sterilsin
          if (type === 'defense') {
            setEditingMode('defense');
          } else {
            setEditingMode('attack');
          }
        }}
        canSelectDefense={attackFormation != null && attackCount === 11}
        currentAttackFormation={attackFormation}
        currentDefenseFormation={defenseFormation}
        communityDataVisible={communityDataVisible}
      />

      {/* Player Detail Modal */}
      {selectedPlayerForDetail && (
        <PlayerDetailModal
          player={selectedPlayerForDetail}
          onClose={() => setSelectedPlayerForDetail(null)}
          matchId={matchId}
          positionLabel={selectedSlot !== null ? formation?.positions[selectedSlot] : selectedPlayerForDetail?.position}
          communityDataVisible={communityDataVisible}
        />
      )}

      {/* âœ… Defense Confirmation Modal */}
      <Modal
        visible={showDefenseConfirmModal}
        animationType="fade"
        transparent={true}
        onRequestClose={() => setShowDefenseConfirmModal(false)}
      >
        <View style={styles.defenseConfirmOverlay}>
          <View style={styles.defenseConfirmModal}>
            {/* Icon */}
            <View style={styles.defenseConfirmIcon}>
              <Ionicons name="shield-checkmark" size={48} color="#1FA2A6" />
            </View>
            
            {/* Title */}
            <Text style={styles.defenseConfirmTitle}>Defans Formasyonu</Text>
            
            {/* Description */}
            <Text style={styles.defenseConfirmDesc}>
              Atak kadronuz tamamlandÄ±! Defans iÃ§in farklÄ± bir formasyon kullanmak ister misiniz?
            </Text>
            
            {/* Info Box */}
            <View style={styles.defenseConfirmInfo}>
              <Ionicons name="information-circle" size={18} color="#F59E0B" />
              <Text style={styles.defenseConfirmInfoText}>
                <Text style={{ fontWeight: '700' }}>Evet:</Text> Defans formasyonu seÃ§ip sadece kaleci otomatik kalÄ±r, diÄŸer 10 oyuncuyu defans pozisyonlarÄ±na manuel yerleÅŸtirirsiniz.{'\n'}
                <Text style={{ fontWeight: '700' }}>HayÄ±r:</Text> Atak formasyonu ve oyuncularÄ± defans iÃ§in de aynen kullanÄ±lÄ±r.
              </Text>
            </View>
            
            {/* Buttons */}
            <View style={styles.defenseConfirmButtons}>
              <TouchableOpacity
                style={styles.defenseConfirmNoBtn}
                onPress={handleDefenseConfirmNo}
                activeOpacity={0.7}
              >
                <Ionicons name="close-circle-outline" size={20} color="#94A3B8" />
                <Text style={styles.defenseConfirmNoText}>HayÄ±r, Devam Et</Text>
              </TouchableOpacity>
              
              <TouchableOpacity
                style={styles.defenseConfirmYesBtn}
                onPress={handleDefenseConfirmYes}
                activeOpacity={0.7}
              >
                <LinearGradient
                  colors={['#3B82F6', '#1D4ED8']}
                  start={{ x: 0, y: 0 }}
                  end={{ x: 1, y: 0 }}
                  style={styles.defenseConfirmYesGradient}
                >
                  <Ionicons name="shield" size={20} color="#FFFFFF" />
                  <Text style={styles.defenseConfirmYesText}>Evet, SeÃ§</Text>
                </LinearGradient>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* Atak formasyonu deÄŸiÅŸikliÄŸi â€“ uygulama iÃ§i onay popup */}
      {formationConfirmModal && (
        <ConfirmModal
          visible={true}
          title="Atak formasyonu deÄŸiÅŸikliÄŸi"
          message="Sadece ATAK formasyonu deÄŸiÅŸiyor â€“ tÃ¼m tahmin verileriniz silinecek. Defans formasyonu veya oyuncu deÄŸiÅŸikliÄŸi bu uyarÄ±yÄ± gÃ¶stermez. Devam?"
          buttons={[
            {
              text: 'Ä°ptal',
              style: 'cancel',
              onPress: () => {
                setShowFormationModal(false);
                setFormationConfirmModal(null);
              },
            },
            {
              text: 'Onayla',
              style: 'destructive',
              onPress: () => runFormationChangeConfirm(),
            },
          ]}
          onRequestClose={() => {
            setShowFormationModal(false);
            setFormationConfirmModal(null);
          }}
        />
      )}
      
      {/* âœ… Kaydediliyor... Overlay */}
      {isSaving && (
        <Modal
          visible={true}
          transparent={true}
          animationType="fade"
        >
          <View style={styles.savingOverlay}>
            <View style={styles.savingContainer}>
              <ActivityIndicator size="large" color="#1FA2A6" />
              <Text style={styles.savingText}>Kaydediliyor...</Text>
              <Text style={styles.savingSubtext}>Kadronuz kaydediliyor, lÃ¼tfen bekleyin</Text>
            </View>
          </View>
        </Modal>
      )}
    </View>
  );
}

// Formation Modal Component - 3 COLUMN GRID
const FormationModal = ({ visible, formations, formationType, onSelect, onClose, onTabChange, canSelectDefense = true, currentAttackFormation, currentDefenseFormation, communityDataVisible = false }: any) => {
  // âœ… Mevcut sekmede seÃ§ili formasyon
  const currentSelectedFormation = formationType === 'defense' ? currentDefenseFormation : currentAttackFormation;
  const [selectedFormationForDetail, setSelectedFormationForDetail] = useState<any>(null);
  const [hoveredFormation, setHoveredFormation] = useState<any>(null); // âœ… Ã–nizleme iÃ§in
  
  // âœ… Formasyon popÃ¼lerlik verileri (API'den gelecek, ÅŸimdilik mock)
  const [formationPopularity, setFormationPopularity] = React.useState<Record<string, number>>({});
  const [popularityLoading, setPopularityLoading] = React.useState(true);
  
  // âœ… Formasyon popÃ¼lerlik verilerini yÃ¼kle
  React.useEffect(() => {
    if (!visible) return;
    
    const loadPopularity = async () => {
      setPopularityLoading(true);
      try {
        // TODO: GerÃ§ek API entegrasyonu
        // const result = await squadPredictionsApi.getFormationPopularity(formationType);
        
        // âœ… Mock data - Toplam %100 olacak ÅŸekilde daÄŸÄ±tÄ±lmÄ±ÅŸ (formationType'a gÃ¶re)
        // Atak iÃ§in popÃ¼ler formasyonlar
        const attackPopularity: Record<string, number> = {
          '4-3-3': 18,
          '4-2-3-1': 14,
          '4-4-2': 11,
          '3-4-3': 9,
          '4-1-2-3': 8,
          '3-5-2': 7,
          '4-3-3-holding': 6,
          '4-3-3-false9': 5,
          '4-1-4-1': 4,
          '4-3-1-2': 4,
          '3-4-1-2': 3,
          '4-2-2-2': 3,
          '4-4-2-diamond': 2,
          '4-2-4': 2,
          '2-3-5': 1,
          '3-3-3-1': 1,
          '3-3-4': 1,
          '3-4-2-1': 1,
        };
        
        // Defans iÃ§in popÃ¼ler formasyonlar
        const defensePopularity: Record<string, number> = {
          '5-4-1': 16,
          '5-3-2': 14,
          '4-5-1': 12,
          '4-4-2': 10,
          '4-1-4-1': 9,
          '3-5-2': 8,
          '4-2-3-1': 6,
          '4-3-3-holding': 5,
          '5-2-3': 4,
          '4-4-1-1': 4,
          '4-3-2-1': 3,
          '4-1-3-2': 3,
          '3-6-1': 2,
          '4-3-3': 2,
          '3-4-3': 1,
          '4-3-1-2': 1,
        };
        
        // SeÃ§ilen tipe gÃ¶re popÃ¼lerlik daÄŸÄ±lÄ±mÄ±
        const baseData = formationType === 'defense' ? defensePopularity : attackPopularity;
        const mockData: Record<string, number> = { ...baseData };
        
        // Eksik formasyonlara dÃ¼ÅŸÃ¼k deÄŸer ver (toplam %100 olsun)
        let totalAssigned = Object.values(mockData).reduce((a, b) => a + b, 0);
        const remaining = 100 - totalAssigned;
        const unassignedFormations = formations.filter((f: any) => !mockData[f.id]);
        
        if (unassignedFormations.length > 0 && remaining > 0) {
          const perFormation = Math.floor(remaining / unassignedFormations.length);
          unassignedFormations.forEach((f: any, i: number) => {
            mockData[f.id] = i === unassignedFormations.length - 1 
              ? remaining - (perFormation * (unassignedFormations.length - 1)) // Son formasyona kalanÄ± ver
              : perFormation;
          });
        }
        
        setFormationPopularity(mockData);
      } catch (error) {
        console.warn('Formation popularity load failed', error);
      }
      setPopularityLoading(false);
    };
    
    loadPopularity();
  }, [visible, formationType, formations]);
  
  // âœ… Defans sekmesi sadece atak formasyonu seÃ§ilip 11 oyuncu yerleÅŸtirildiyse seÃ§ilebilir
  React.useEffect(() => {
    if (visible && formationType === 'defense' && !canSelectDefense) {
      onTabChange('attack');
    }
  }, [visible, formationType, canSelectDefense, onTabChange]);
  
  // âœ… TÃ¼m formasyonlarÄ± gÃ¶ster (filtreleme yok - kullanÄ±cÄ± istediÄŸi formasyonu seÃ§ebilir)
  const filteredFormations = formations;

  return (
    <>
      <Modal
        visible={visible}
        animationType="slide"
        transparent={true}
        onRequestClose={onClose}
      >
        <View style={styles.modalOverlay}>
          <Animated.View 
            entering={Platform.OS === 'web' ? undefined : SlideInDown.duration(300)}
            exiting={Platform.OS === 'web' ? undefined : SlideOutDown.duration(300)}
            style={styles.modalContent}
          >
            {/* Header */}
            <View style={styles.modalHeader}>
              <View style={styles.modalHeaderContent}>
                <Text style={styles.modalTitle}>
                  {formationType === 'defense' ? 'Defans Formasyonu SeÃ§in' : 'Atak Formasyonu SeÃ§in'}
                </Text>
                <Text style={styles.modalSubtitle}>
                  {formationType === 'defense' ? 'Defans iÃ§in formasyon seÃ§iniz' : 'Atak iÃ§in formasyon seÃ§in'}
                </Text>
              </View>
            </View>

            {/* âœ… Atak / Defans sekme butonlarÄ± */}
            <View style={styles.formationModalTabs}>
              <TouchableOpacity
                style={[styles.formationModalTab, formationType === 'attack' && styles.formationModalTabActive]}
                onPress={() => onTabChange('attack')}
                activeOpacity={0.8}
              >
                <Ionicons name="flash" size={18} color={formationType === 'attack' ? '#FFFFFF' : '#1FA2A6'} />
                <Text style={[styles.formationModalTabText, formationType === 'attack' && styles.formationModalTabTextActive]}>
                  Atak
                </Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={[
                  styles.formationModalTab,
                  formationType === 'defense' && styles.formationModalTabActive,
                  !canSelectDefense && styles.formationModalTabDisabled,
                ]}
                onPress={() => {
                  if (!canSelectDefense) {
                    showInfo(
                      'Ã–nce Atak Kadrosu',
                      'Defans formasyonu seÃ§ebilmek iÃ§in Ã¶nce atak formasyonunu seÃ§in ve 11 oyuncuyu yerleÅŸtirin.'
                    );
                    return;
                  }
                  onTabChange('defense');
                }}
                activeOpacity={0.8}
              >
                <Ionicons name="shield-checkmark" size={18} color={formationType === 'defense' ? '#FFFFFF' : canSelectDefense ? '#3B82F6' : '#6B7280'} />
                <Text style={[styles.formationModalTabText, formationType === 'defense' && styles.formationModalTabTextActive, !canSelectDefense && formationType !== 'defense' && styles.formationModalTabTextDisabled]}>
                  Defans
                </Text>
              </TouchableOpacity>
            </View>

            {/* Close Button - Absolute Position */}
            <TouchableOpacity onPress={onClose} style={styles.modalCloseButtonAbsolute}>
              <Ionicons name="close" size={22} color="#1FA2A6" />
            </TouchableOpacity>

            {/* Formations Grid - 3 Columns */}
            <ScrollView 
              style={styles.modalScroll} 
              contentContainerStyle={styles.formationGridContainer}
              showsVerticalScrollIndicator={false}
            >
              {filteredFormations.map((formation: any) => {
                const isCurrentlySelected = formation.id === currentSelectedFormation;
                return (
                <View key={formation.id} style={styles.formationGridItem}>
                  <TouchableOpacity
                    style={[
                      styles.formationCard,
                      hoveredFormation?.id === formation.id && styles.formationCardSelected,
                      isCurrentlySelected && styles.formationCardCurrentlySelected,
                    ]}
                    onPress={() => setHoveredFormation(formation)}
                    activeOpacity={0.8}
                  >
                    {/* âœ… SeÃ§ili Formasyon Tik Ä°ÅŸareti */}
                    {isCurrentlySelected && (
                      <View style={styles.formationSelectedBadge}>
                        <Ionicons name="checkmark-circle" size={16} color="#10B981" />
                      </View>
                    )}
                    {/* Formation ID */}
                    <Text style={[
                      styles.formationCardId,
                      hoveredFormation?.id === formation.id && { color: '#1FA2A6' },
                      isCurrentlySelected && { color: '#10B981' },
                    ]}>
                      {formation.id.replace(/-holding|-false9|-diamond|-attack/g, '')}
                    </Text>

                    {/* Formation Subtitle - From parentheses */}
                    <Text style={[
                      styles.formationCardSubtitle,
                      isCurrentlySelected && { color: '#10B981' },
                    ]} numberOfLines={1}>
                      {(() => {
                        const parts = formation.name.split('(');
                        if (parts.length > 1) {
                          return parts[1].replace(')', '').trim();
                        }
                        // If no parentheses, show type or formation style
                        return formation.type === 'attack' ? 'Attack' : 
                               formation.type === 'defense' ? 'Defense' : 'Balanced';
                      })()}
                    </Text>
                  </TouchableOpacity>
                </View>
              );})}
            </ScrollView>
            
          </Animated.View>
        </View>
      </Modal>

      {/* âœ… Formation Preview Modal - AyrÄ± popup olarak aÃ§Ä±lÄ±yor */}
      {hoveredFormation && (
        <Modal
          visible={true}
          animationType="fade"
          transparent={true}
          onRequestClose={() => setHoveredFormation(null)}
        >
          <View style={styles.formationPreviewOverlay}>
            <View style={styles.formationPreviewModal}>
              {/* Header */}
              <View style={styles.formationPreviewHeader}>
                <View style={styles.formationPreviewTitleRow}>
                  <Text style={styles.formationPreviewName}>{hoveredFormation.name}</Text>
                  <TouchableOpacity 
                    onPress={() => setHoveredFormation(null)}
                    style={styles.formationPreviewCloseBtn}
                  >
                    <Ionicons name="close" size={20} color="#94A3B8" />
                  </TouchableOpacity>
                </View>
                <View style={[
                  styles.formationPreviewTypeBadge,
                  { backgroundColor: hoveredFormation.type === 'attack' ? 'rgba(239, 68, 68, 0.2)' : 
                    hoveredFormation.type === 'defense' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(245, 158, 11, 0.2)' }
                ]}>
                  <Text style={[
                    styles.formationPreviewTypeText,
                    { color: hoveredFormation.type === 'attack' ? '#EF4444' : 
                      hoveredFormation.type === 'defense' ? '#3B82F6' : '#F59E0B' }
                  ]}>
                    {hoveredFormation.type === 'attack' ? 'âš”ï¸ Atak' : 
                     hoveredFormation.type === 'defense' ? 'ğŸ›¡ï¸ Defans' : 'âš–ï¸ Dengeli'}
                  </Text>
                </View>
                {formationType === 'defense' && (
                  <Text style={styles.formationPreviewContextHint}>
                    ğŸ›¡ï¸ Bu formasyon defans diziliÅŸi iÃ§in seÃ§iliyor
                  </Text>
                )}
              </View>

              {/* Description */}
              <Text style={styles.formationPreviewDesc}>
                {hoveredFormation.description}
              </Text>

              {/* Pros */}
              <View style={styles.formationPreviewSection}>
                <Text style={styles.formationPreviewSectionTitle}>âœ… Avantajlar</Text>
                {hoveredFormation.pros?.map((pro: string, index: number) => (
                  <View key={index} style={styles.formationPreviewListItem}>
                    <View style={styles.formationPreviewBullet} />
                    <Text style={styles.formationPreviewListText}>{pro}</Text>
                  </View>
                ))}
              </View>

              {/* Cons */}
              <View style={styles.formationPreviewSection}>
                <Text style={styles.formationPreviewSectionTitle}>âŒ Dezavantajlar</Text>
                {hoveredFormation.cons?.map((con: string, index: number) => (
                  <View key={index} style={styles.formationPreviewListItem}>
                    <View style={[styles.formationPreviewBullet, { backgroundColor: '#EF4444' }]} />
                    <Text style={styles.formationPreviewListText}>{con}</Text>
                  </View>
                ))}
              </View>

              {/* Best For */}
              <View style={styles.formationPreviewBestFor}>
                <Ionicons name="trophy" size={16} color="#F59E0B" />
                <Text style={styles.formationPreviewBestForText}>
                  <Text style={styles.formationPreviewBestForLabel}>En Ä°yi: </Text>
                  {hoveredFormation.bestFor}
                </Text>
              </View>
              
              {/* âœ… Topluluk Tercihi - Formasyon PopÃ¼lerliÄŸi - DÄ°KKAT Ã‡EKÄ°CÄ° */}
              <View style={styles.formationPopularitySection}>
                <View style={styles.formationPopularityHeader}>
                  <Ionicons name="flame" size={18} color="#F97316" />
                  <Text style={styles.formationPopularitySectionTitle}>ğŸ”¥ Topluluk Tercihi</Text>
                </View>
                {popularityLoading ? (
                  <Text style={styles.formationPopularityLoading}>YÃ¼kleniyor...</Text>
                ) : (
                  <View style={styles.formationPopularityContent}>
                    {communityDataVisible ? (
                      <>
                        <Text style={styles.formationPopularityText}>
                          {t('matchSquad.formationCommunityTooltip', { pct: formationPopularity[hoveredFormation.id] || 0, type: formationType === 'defense' ? t('matchSquad.defense') : t('matchSquad.attack') })}
                        </Text>
                        <View style={styles.formationPopularityBarBg}>
                          <View 
                            style={[
                              styles.formationPopularityBarFill,
                              { 
                                width: `${formationPopularity[hoveredFormation.id] || 0}%`,
                                backgroundColor: (formationPopularity[hoveredFormation.id] || 0) >= 50 ? '#F97316' : 
                                  (formationPopularity[hoveredFormation.id] || 0) >= 25 ? '#FB923C' : '#FDBA74' // Turuncu tonlarÄ±
                              }
                            ]}
                          />
                        </View>
                      </>
                    ) : (
                      <View style={{ alignItems: 'center', padding: 8 }}>
                        <Text style={[styles.formationPopularityText, { textAlign: 'center' }]}>
                          <Ionicons name="lock-closed" size={14} color="#F97316" /> KullanÄ±cÄ±larÄ±n <Text style={styles.formationPopularityHighlight}>??%</Text>'i bu formasyonu tercih ediyor
                        </Text>
                        <Text style={{ color: '#9CA3AF', fontSize: 11, marginTop: 6, textAlign: 'center' }}>
                          Tahminlerinizi kaydedin ve topluluk verilerini gÃ¶rÃ¼n!
                        </Text>
                      </View>
                    )}
                  </View>
                )}
              </View>
              
              {/* Buttons */}
              <View style={styles.formationPreviewButtons}>
                <TouchableOpacity
                  style={styles.formationPreviewCancelBtn}
                  onPress={() => setHoveredFormation(null)}
                  activeOpacity={0.7}
                >
                  <Text style={styles.formationPreviewCancelText}>Ä°ptal</Text>
                </TouchableOpacity>
                
                <TouchableOpacity
                  style={styles.formationPreviewSelectBtn}
                  onPress={() => {
                    onSelect(hoveredFormation.id);
                    setHoveredFormation(null);
                  }}
                  activeOpacity={0.85}
                >
                  <LinearGradient
                    colors={['#1FA2A6', '#0D9488', '#047857']}
                    start={{ x: 0, y: 0 }}
                    end={{ x: 1, y: 0 }}
                    style={styles.formationPreviewSelectGradient}
                  >
                    <Ionicons name="checkmark-circle" size={18} color="#FFFFFF" />
                    <Text style={styles.formationPreviewSelectText}>
                      {formationType === 'defense' ? 'Bu Defans DiziliÅŸini SeÃ§' : 'Bu DiziliÅŸi SeÃ§'}
                    </Text>
                  </LinearGradient>
                </TouchableOpacity>
              </View>
            </View>
          </View>
        </Modal>
      )}
    </>
  );
};

// Player Modal Component - COMPLETE
// Kaleci pozisyonuna yalnÄ±zca kaleci, saha pozisyonlarÄ±na yalnÄ±zca saha oyuncusu atanabilir.
const PlayerModal = ({ visible, players, selectedPlayers, positionLabel, onSelect, onClose, isDefenseMode, isLoadingSquad = false, loadingFromApi = false, hasBackendError = false, onRetrySquad, communityDataVisible = false }: any) => {
  const [previewPlayer, setPreviewPlayer] = useState<any>(null);
  
  // âœ… Preview oyuncusu iÃ§in topluluk istatistikleri
  const [previewCommunityStats, setPreviewCommunityStats] = React.useState<{
    inStartingXI: number;
    mostAssignedPosition: string; // âœ… Oyuncunun en Ã§ok atandÄ±ÄŸÄ± pozisyon
    mostAssignedPositionPercentage: number; // âœ… Bu pozisyona atanma yÃ¼zdesi
    topPlayerForPosition: string; // âœ… Bu pozisyon iÃ§in en Ã§ok tercih edilen oyuncu
    topPlayerPercentage: number; // âœ… Bu oyuncunun yÃ¼zdesi
    loading: boolean;
  }>({ inStartingXI: 0, mostAssignedPosition: '', mostAssignedPositionPercentage: 0, topPlayerForPosition: '', topPlayerPercentage: 0, loading: true });
  
  // âœ… Preview oyuncusu deÄŸiÅŸtiÄŸinde topluluk istatistiklerini yÃ¼kle
  React.useEffect(() => {
    if (!previewPlayer) {
      setPreviewCommunityStats({ 
        inStartingXI: 0, 
        mostAssignedPosition: '', 
        mostAssignedPositionPercentage: 0, 
        topPlayerForPosition: '', 
        topPlayerPercentage: 0, 
        loading: true 
      });
      return;
    }
    
    const loadStats = async () => {
      setPreviewCommunityStats(prev => ({ ...prev, loading: true }));
      try {
        // TODO: GerÃ§ek API entegrasyonu
        // Mock data - oyuncunun en Ã§ok atandÄ±ÄŸÄ± pozisyonu ve bu pozisyon iÃ§in en Ã§ok tercih edilen oyuncuyu bul
        
        // Rating'e gÃ¶re ilk 11'e seÃ§ilme yÃ¼zdesi
        const normRating = normalizeRatingTo100(previewPlayer.rating);
        const baseXI = normRating >= 85 ? 78 : normRating >= 80 ? 62 : normRating >= 75 ? 48 : 32;
        const variance = Math.floor(Math.random() * 12);
        const inStartingXI = Math.min(95, baseXI + variance);
        
        // âœ… Oyuncunun en Ã§ok atandÄ±ÄŸÄ± pozisyonu bul (mock - gerÃ§ek API gelince deÄŸiÅŸecek)
        // Oyuncunun pozisyonuna gÃ¶re en Ã§ok atandÄ±ÄŸÄ± pozisyonu belirle
        const playerPos = previewPlayer.position?.toUpperCase() || previewPlayer.pos?.toUpperCase() || '';
        let mostAssignedPosition = playerPos;
        let mostAssignedPositionPercentage = 72; // Mock yÃ¼zde
        
        // Forvet/kanatlar iÃ§in alternatif pozisyonlar
        if (['ST', 'CF', 'SS'].includes(playerPos)) {
          mostAssignedPosition = 'ST';
          mostAssignedPositionPercentage = 75 + Math.floor(Math.random() * 15);
        } else if (['LW', 'LM', 'LF'].includes(playerPos)) {
          mostAssignedPosition = 'LW';
          mostAssignedPositionPercentage = 68 + Math.floor(Math.random() * 20);
        } else if (['RW', 'RM', 'RF'].includes(playerPos)) {
          mostAssignedPosition = 'RW';
          mostAssignedPositionPercentage = 68 + Math.floor(Math.random() * 20);
        } else if (['CAM', 'AM', 'ACM'].includes(playerPos)) {
          mostAssignedPosition = 'CAM';
          mostAssignedPositionPercentage = 65 + Math.floor(Math.random() * 20);
        } else if (['CM', 'CDM', 'DM'].includes(playerPos)) {
          mostAssignedPosition = 'CM';
          mostAssignedPositionPercentage = 60 + Math.floor(Math.random() * 25);
        } else if (['CB', 'DC'].includes(playerPos)) {
          mostAssignedPosition = 'CB';
          mostAssignedPositionPercentage = 70 + Math.floor(Math.random() * 20);
        } else if (['LB', 'LWB'].includes(playerPos)) {
          mostAssignedPosition = 'LB';
          mostAssignedPositionPercentage = 72 + Math.floor(Math.random() * 18);
        } else if (['RB', 'RWB'].includes(playerPos)) {
          mostAssignedPosition = 'RB';
          mostAssignedPositionPercentage = 72 + Math.floor(Math.random() * 18);
        } else if (['GK', 'G'].includes(playerPos)) {
          mostAssignedPosition = 'GK';
          mostAssignedPositionPercentage = 95 + Math.floor(Math.random() * 5);
        }
        
        // âœ… Bu pozisyon iÃ§in en Ã§ok tercih edilen oyuncu (mock)
        // AynÄ± pozisyondaki oyunculardan en yÃ¼ksek rating'li olanÄ± seÃ§
        const samePositionPlayers = players.filter((p: any) => {
          const pPos = p.position?.toUpperCase() || p.pos?.toUpperCase() || '';
          return pPos === playerPos || 
            (mostAssignedPosition === 'ST' && ['ST', 'CF', 'SS'].includes(pPos)) ||
            (mostAssignedPosition === 'CAM' && ['CAM', 'AM', 'ACM'].includes(pPos));
        });
        
        const topPlayer = samePositionPlayers.length > 0 
          ? samePositionPlayers.reduce((best: any, p: any) => (!best || (p.rating || 0) > (best.rating || 0)) ? p : best, null)
          : null;
        
        const topPlayerForPosition = topPlayer?.name || 'Bilinmiyor';
        const topRating = normalizeRatingTo100(topPlayer?.rating);
        const topPlayerPercentage = topPlayer 
          ? (topRating >= 85 ? 85 : topRating >= 80 ? 72 : topRating >= 75 ? 58 : 45) + Math.floor(Math.random() * 10)
          : 0;
        
        // âœ… Mock data iÃ§in beklemeden anÄ±nda gÃ¶ster - sÄ±Ã§ramayÄ± Ã¶nler
        setPreviewCommunityStats({
          inStartingXI,
          mostAssignedPosition,
          mostAssignedPositionPercentage,
          topPlayerForPosition,
          topPlayerPercentage: Math.min(95, topPlayerPercentage),
          loading: false,
        });
      } catch (error) {
        setPreviewCommunityStats({ 
          inStartingXI: 0, 
          mostAssignedPosition: '', 
          mostAssignedPositionPercentage: 0, 
          topPlayerForPosition: '', 
          topPlayerPercentage: 0, 
          loading: false 
        });
      }
    };
    
    loadStats();
  }, [previewPlayer, players]);

  const isGKPosition = positionLabel === 'GK';

  // Check if player can be assigned to current slot (GK slot â†’ only GK, field â†’ only field)
  const isPlayerEligible = (player: any) =>
    isGKPosition ? isGoalkeeperPlayer(player) : !isGoalkeeperPlayer(player);

  // Filter: not already selected AND eligible for this position (sakat/cezalÄ± listede gÃ¶rÃ¼nsÃ¼n ama pasif)
  // Dedup: aynÄ± ID'li oyuncularÄ± tek tut (API bazen duplicate dÃ¶ner)
  const seenIds = new Set<number>();
  const dedupedPlayers = players.filter((p: any) => {
    if (seenIds.has(p.id)) return false;
    seenIds.add(p.id);
    return true;
  });
  const eligiblePlayers = dedupedPlayers.filter(
    (p: any) =>
      !Object.values(selectedPlayers).some((sp: any) => sp?.id === p.id) && isPlayerEligible(p)
  );
  const canAddToSquad = (p: any) => p.eligible_for_selection !== false && !p.injured && !p.suspended;

  // Forma numarasÄ±na gÃ¶re kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe sÄ±rala (yoksa sonda)
  const sortedPlayers = [...eligiblePlayers].sort((a, b) => {
    const na = a.number != null ? Number(a.number) : 999;
    const nb = b.number != null ? Number(b.number) : 999;
    return na - nb;
  });

  const handlePlayerSelect = (player: any) => {
    setPreviewPlayer(null);
    if (player.eligible_for_selection === false || player.injured || player.suspended) {
      showInfo(
        'Kadroya Eklenemez',
        'Bu oyuncu sakat veya cezalÄ±. Kadroya ekleyemezsiniz. SakatlÄ±k/ceza kalkÄ±nca tekrar ekleyebilirsiniz.'
      );
      return;
    }
    onSelect(player);
  };

  return (
    <>
      <Modal
        visible={visible}
        animationType="slide"
        transparent={true}
        onRequestClose={onClose}
      >
        <View style={styles.modalOverlay}>
          <Animated.View 
            entering={isWeb ? undefined : SlideInDown.duration(300)}
            exiting={isWeb ? undefined : SlideOutDown.duration(300)}
            style={styles.modalContent}
          >
            {/* Header */}
            <View style={styles.playerModalHeader}>
              <View style={styles.playerModalHeaderText}>
                <Text style={styles.modalTitle}>
                  {isDefenseMode ? 'ğŸ›¡ï¸ Defans Oyuncusu SeÃ§' : 'âš¡ Atak Oyuncusu SeÃ§'}
                </Text>
                <Text style={styles.modalSubtitle}>Pozisyon: {positionLabel}</Text>
              </View>
              <TouchableOpacity onPress={onClose} style={styles.playerModalCloseBtnTopRight}>
                <Ionicons name="close" size={20} color="#94A3B8" />
              </TouchableOpacity>
            </View>
            
            {/* Mode Info - Atak ve Defans iÃ§in farklÄ± uyarÄ±lar */}
            {isDefenseMode ? (
              <View style={styles.defenseModeInfo}>
                <Ionicons name="information-circle" size={16} color="#3B82F6" />
                <Text style={styles.defenseModeInfoText}>
                  Sadece atak kadronuzdaki 11 oyuncudan seÃ§im yapabilirsiniz.
                </Text>
              </View>
            ) : (
              <View style={styles.attackModeInfo}>
                <Ionicons name="football" size={16} color="#1FA2A6" />
                <Text style={styles.attackModeInfoText}>
                  TakÄ±mÄ±nÄ±zÄ±n ilk 11'ini kadrodaki oyuncular arasÄ±ndan belirleyin.
                </Text>
              </View>
            )}

            {/* Players List â€“ sadece uygun oyuncular, forma no kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe */}
            <FlatList
              data={sortedPlayers}
              keyExtractor={(item) => item.id.toString()}
              renderItem={({ item }) => {
                const itemRating = normalizeRatingTo100(item.rating);
                const getBorderColor = () => {
                  if (itemRating >= 85) return '#C9A44C'; // Gold for elite
                  if (isGoalkeeperPlayer(item)) return '#3B82F6'; // Blue for GK
                  return '#4B5563'; // Gray for others
                };
                return (
                  <TouchableOpacity
                    style={[
                      styles.playerItem,
                      { borderLeftWidth: 3, borderLeftColor: getBorderColor() },
                    ]}
                    onPress={() => setPreviewPlayer(item)}
                    activeOpacity={0.7}
                  >
                    <View style={styles.playerItemLeft}>
                      <View style={[
                        styles.playerItemJerseyNumber,
                        { backgroundColor: itemRating >= 85 ? '#C9A44C' : '#1FA2A6' }
                      ]}>
                        <Text style={styles.playerItemJerseyNumberText}>
                          {(item.number ?? item.shirt_number ?? item.jersey_number) != null && (item.number ?? item.shirt_number ?? item.jersey_number) > 0 ? (item.number ?? item.shirt_number ?? item.jersey_number) : '-'}
                        </Text>
                      </View>
                      <View style={styles.playerItemInfo}>
                        <View style={styles.playerItemNameRow}>
                          <Text style={styles.playerItemName}>
                            {(item.firstname && item.lastname)
                              ? `${String(item.firstname).trim()} ${String(item.lastname).trim()}`
                              : (item.name || '')}
                          </Text>
                          {item.form >= 8 && (
                            <Ionicons name="flame" size={14} color="#F59E0B" style={{ marginLeft: 4 }} />
                          )}
                          {item.injury && (
                            <Ionicons name="warning" size={14} color="#EF4444" style={{ marginLeft: 4 }} />
                          )}
                        </View>
                        <View style={styles.playerItemBottomRow}>
                          <Text style={styles.playerItemRatingBottom}>
                            {formatRatingDisplay(item.rating)}
                          </Text>
                          <Text style={styles.playerItemPosition}>
                            {item.position} â€¢ {item.team}
                          </Text>
                        </View>
                      </View>
                    </View>
                    <TouchableOpacity
                      onPress={() => handlePlayerSelect(item)}
                      style={styles.playerItemAddBtn}
                      activeOpacity={0.7}
                    >
                      <Ionicons name="add-circle" size={28} color="#1FA2A6" />
                    </TouchableOpacity>
                  </TouchableOpacity>
                );
              }}
              showsVerticalScrollIndicator={false}
              contentContainerStyle={styles.playersList}
              ListFooterComponent={players && players.length > 0 && onRetrySquad && !isLoadingSquad ? (
                <TouchableOpacity
                  onPress={onRetrySquad}
                  style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: 6, marginTop: 16, marginBottom: 24, paddingVertical: 10 }}
                  activeOpacity={0.7}
                >
                  <Ionicons name="refresh" size={16} color="#94A3B8" />
                  <Text style={{ fontSize: 12, color: '#94A3B8', fontWeight: '500' }}>Kadro gÃ¼ncel deÄŸil mi? Yenile</Text>
                </TouchableOpacity>
              ) : null}
              ListEmptyComponent={() => {
                const noData = !players || players.length === 0;
                return (
                  <View style={{ alignItems: 'center', padding: 32, marginTop: 40 }}>
                    {isLoadingSquad ? (
                      <>
                        <Ionicons name="hourglass-outline" size={48} color="rgba(31, 162, 166, 0.5)" />
                        <Text style={{ fontSize: 18, fontWeight: '600', color: '#FFFFFF', marginTop: 16 }}>
                          Kadro YÃ¼kleniyor...
                        </Text>
                        <Text style={{ fontSize: 14, color: 'rgba(255,255,255,0.7)', textAlign: 'center', marginTop: 8, lineHeight: 20 }}>
                          {loadingFromApi
                            ? 'TakÄ±m kadrosu API\'den Ã§ekiliyor. LÃ¼tfen bekleyin...'
                            : 'Uygulama verisinden yÃ¼kleniyor...'}
                        </Text>
                      </>
                    ) : (
                      <>
                        <Ionicons name="football-outline" size={48} color="rgba(31, 162, 166, 0.5)" />
                        <Text style={{ fontSize: 18, fontWeight: '600', color: '#FFFFFF', marginTop: 16 }}>
                          {hasBackendError ? 'Backend BaÄŸlantÄ± HatasÄ±' : noData ? 'Kadro Bilgisi Yok' : 'Bu Pozisyon Ä°Ã§in Uygun Oyuncu Yok'}
                        </Text>
                        <Text style={{ fontSize: 14, color: 'rgba(255,255,255,0.7)', textAlign: 'center', marginTop: 8, lineHeight: 20 }}>
                          {hasBackendError
                            ? 'Backend servisi Ã§alÄ±ÅŸmÄ±yor olabilir. LÃ¼tfen backend\'in port 3001\'de Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.'
                            : noData
                            ? 'Kadro henÃ¼z yÃ¼klenmedi. Backend kadroyu Ã§ekiyor olabilir. Yeniden deneyin.'
                            : (isGKPosition ? 'Kadroda kaleci yok veya hepsi seÃ§ildi. Ã–nce kalecinizi kale pozisyonuna yerleÅŸtirin.' : 'Kadroda saha oyuncusu yok veya hepsi seÃ§ildi.')}
                        </Text>
                        {(noData || hasBackendError) && onRetrySquad && (
                          <TouchableOpacity
                            onPress={onRetrySquad}
                            style={{ marginTop: 16, paddingVertical: 10, paddingHorizontal: 20, backgroundColor: 'rgba(31, 162, 166, 0.3)', borderRadius: 8 }}
                          >
                            <Text style={{ color: '#1FA2A6', fontWeight: '600' }}>Yeniden Dene</Text>
                          </TouchableOpacity>
                        )}
                      </>
                    )}
                  </View>
                );
              }}
            />
          </Animated.View>
        </View>
      </Modal>

      {/* Player Preview Modal - FIFA Card Style */}
      {previewPlayer && (
        <Modal
          visible={true}
          animationType="none"
          transparent={true}
          onRequestClose={() => setPreviewPlayer(null)}
        >
          <View style={styles.playerCardOverlay}>
            <Animated.View 
              style={styles.playerCardContainer}
            >
              {/* Card Header with Gradient */}
              <LinearGradient
                colors={normalizeRatingTo100(previewPlayer.rating) >= 85 ? ['#C9A44C', '#A67C00'] : ['#1FA2A6', '#0D7377']}
                start={{ x: 0, y: 0 }}
                end={{ x: 1, y: 1 }}
                style={styles.playerCardHeader}
              >
                {/* Close Button */}
                <TouchableOpacity 
                  style={styles.playerCardCloseBtn}
                  onPress={() => setPreviewPlayer(null)}
                >
                  <Ionicons name="close" size={18} color="#FFFFFF" />
                </TouchableOpacity>

                {/* Jersey Number Circle */}
                <View style={styles.playerCardRatingCircle}>
                  <Text style={styles.playerCardRatingText}>
                    {(previewPlayer.number ?? previewPlayer.shirt_number ?? previewPlayer.jersey_number) != null && (previewPlayer.number ?? previewPlayer.shirt_number ?? previewPlayer.jersey_number) > 0 ? (previewPlayer.number ?? previewPlayer.shirt_number ?? previewPlayer.jersey_number) : '-'}
                  </Text>
                </View>

                {/* Player Name & Position */}
                <Text style={styles.playerCardName}>
                {(previewPlayer.firstname && previewPlayer.lastname) ? `${String(previewPlayer.firstname).trim()} ${String(previewPlayer.lastname).trim()}` : (previewPlayer.name || '')}
              </Text>
                <View style={styles.playerCardPositionRow}>
                  <View style={styles.playerCardPositionBadge}>
                    <Text style={styles.playerCardPositionText}>{previewPlayer.position}</Text>
                  </View>
                  <Text style={styles.playerCardTeam}>{previewPlayer.team}</Text>
                </View>

                {/* Nationality & Age with Rating */}
                <View style={styles.playerCardInfoRow}>
                  <Text style={styles.playerCardInfoText}>
                    {previewPlayer.nationality || 'Unknown'} â€¢ {previewPlayer.age || '?'} yaÅŸ
                  </Text>
                  <Text style={styles.playerCardRatingBottom}>
                    {formatRatingDisplay(previewPlayer.rating)}
                  </Text>
                </View>
              </LinearGradient>

              {/* Card Body */}
              <View style={styles.playerCardBody}>
                {/* Status Row */}
                <View style={styles.playerCardStatusRow}>
                  {/* Form */}
                  <View style={[
                    styles.playerCardStatusItem,
                    { borderColor: previewPlayer.form >= 8 ? '#10B981' : previewPlayer.form >= 5 ? '#F59E0B' : '#EF4444' }
                  ]}>
                    <Ionicons 
                      name={previewPlayer.form >= 8 ? "flame" : previewPlayer.form >= 5 ? "remove-circle" : "arrow-down-circle"} 
                      size={20} 
                      color={previewPlayer.form >= 8 ? "#10B981" : previewPlayer.form >= 5 ? "#F59E0B" : "#EF4444"} 
                    />
                    <Text style={styles.playerCardStatusLabel}>Form</Text>
                    <Text style={[
                      styles.playerCardStatusValue,
                      { color: previewPlayer.form >= 8 ? "#10B981" : previewPlayer.form >= 5 ? "#F59E0B" : "#EF4444" }
                    ]}>{previewPlayer.form}/10</Text>
                  </View>

                  {/* Health */}
                  <View style={[
                    styles.playerCardStatusItem,
                    { borderColor: previewPlayer.injury ? '#EF4444' : '#10B981' }
                  ]}>
                    <Ionicons 
                      name={previewPlayer.injury ? "medical" : "heart"} 
                      size={20} 
                      color={previewPlayer.injury ? "#EF4444" : "#10B981"} 
                    />
                    <Text style={styles.playerCardStatusLabel}>SaÄŸlÄ±k</Text>
                    <Text style={[
                      styles.playerCardStatusValue,
                      { color: previewPlayer.injury ? "#EF4444" : "#10B981" }
                    ]}>{previewPlayer.injury ? 'Sakat' : 'Fit'}</Text>
                  </View>
                </View>

                {/* Stats Grid - 2x3 */}
                {previewPlayer.stats && (
                  <View style={styles.playerCardStatsGrid}>
                    {(() => {
                      // âœ… Kaleci mi kontrol et
                      const playerPos = (previewPlayer.position || previewPlayer.pos || '').toUpperCase();
                      const isGK = playerPos === 'GK' || playerPos === 'G' || playerPos.toLowerCase().includes('goalkeeper') ||
                                   positionLabel?.toUpperCase() === 'GK';
                      
                      // âœ… Stats'leri al veya rating'den geriye doÄŸru hesapla
                      const stats = previewPlayer.stats || {};
                      const normalizedRating = normalizeRatingTo100(previewPlayer.rating);
                      
                      // âœ… EÄŸer tÃ¼m stats 70 ise (default), rating'den geriye doÄŸru hesapla
                      const allStatsDefault = (
                        (stats.pace ?? 70) === 70 &&
                        (stats.shooting ?? 70) === 70 &&
                        (stats.passing ?? 70) === 70 &&
                        (stats.dribbling ?? 70) === 70 &&
                        (stats.defending ?? 70) === 70 &&
                        (stats.physical ?? 70) === 70
                      );
                      
                      // âœ… Rating'den geriye doÄŸru stats hesapla (eÄŸer default ise)
                      const calculatedStats = allStatsDefault ? {
                        pace: normalizedRating,
                        shooting: normalizedRating,
                        passing: normalizedRating,
                        dribbling: normalizedRating,
                        defending: normalizedRating,
                        physical: normalizedRating,
                      } : {
                        pace: stats.pace ?? 70,
                        shooting: stats.shooting ?? 70,
                        passing: stats.passing ?? 70,
                        dribbling: stats.dribbling ?? 70,
                        defending: stats.defending ?? 70,
                        physical: stats.physical ?? 70,
                      };
                      
                      // âœ… Kaleci Ã¶zellikleri (paceâ†’DalÄ±ÅŸ, shootingâ†’Refleks, vb. mapping)
                      const goalkeeperStats = [
                        { label: 'DALIÅ', value: calculatedStats.pace, icon: 'hand-left' },
                        { label: 'REFLEKS', value: calculatedStats.shooting, icon: 'flash' },
                        { label: 'TOP TUT', value: calculatedStats.passing, icon: 'hand-right' },
                        { label: 'KONUM', value: calculatedStats.dribbling, icon: 'locate' },
                        { label: 'HAVA', value: calculatedStats.defending, icon: 'arrow-up' },
                        { label: '1V1', value: calculatedStats.physical, icon: 'body' },
                      ];
                      
                      // âœ… Saha oyuncusu Ã¶zellikleri
                      const outfieldStats = [
                        { label: 'HIZ', value: calculatedStats.pace, icon: 'flash' },
                        { label: 'ÅUT', value: calculatedStats.shooting, icon: 'football' },
                        { label: 'PAS', value: calculatedStats.passing, icon: 'swap-horizontal' },
                        { label: 'DRÄ°BLÄ°NG', value: calculatedStats.dribbling, icon: 'walk' },
                        { label: 'DEFANS', value: calculatedStats.defending, icon: 'shield' },
                        { label: 'FÄ°ZÄ°K', value: calculatedStats.physical, icon: 'fitness' },
                      ];
                      
                      const finalStats = isGK ? goalkeeperStats : outfieldStats;
                      
                      return finalStats.map((stat, index) => (
                        <View key={index} style={styles.playerCardStatItem}>
                          <View style={[
                            styles.playerCardStatCircle,
                            { borderColor: getStatColor(stat.value) }
                          ]}>
                            <Text style={[styles.playerCardStatValue, { color: getStatColor(stat.value) }]}>
                              {stat.value}
                            </Text>
                          </View>
                          <Text style={styles.playerCardStatLabel}>{stat.label}</Text>
                        </View>
                      ));
                    })()}
                  </View>
                )}

                {/* âœ… Topluluk Tercihleri - SADECE communityDataVisible ise gÃ¶ster */}
                <View style={styles.playerPreviewCommunitySection}>
                  <View style={styles.playerPreviewCommunityHeader}>
                    <Ionicons name="people" size={16} color="#F97316" />
                    <Text style={styles.playerPreviewCommunityTitle}>ğŸ”¥ Topluluk Tercihi</Text>
                  </View>
                  {communityDataVisible ? (
                    previewCommunityStats.loading ? (
                      <Text style={styles.playerPreviewCommunityLoading}>YÃ¼kleniyor...</Text>
                    ) : (
                      <View style={styles.playerPreviewCommunityContent}>
                        {/* Ä°lk 11'e seÃ§im */}
                        <View style={styles.playerPreviewCommunityRow}>
                          <Ionicons name="football" size={14} color="#1FA2A6" />
                          <Text style={styles.playerPreviewCommunityText}>
                            {t('matchSquad.playerCommunityTooltip', { pct: previewCommunityStats.inStartingXI })}
                          </Text>
                        </View>
                        {/* âœ… Oyuncunun en Ã§ok atandÄ±ÄŸÄ± pozisyon */}
                        <View style={styles.playerPreviewCommunityRow}>
                          <Ionicons name="star" size={14} color="#F59E0B" />
                          <Text style={styles.playerPreviewCommunityText}>
                            Bu oyuncu en Ã§ok <Text style={styles.playerPreviewCommunityHighlight}>{previewCommunityStats.mostAssignedPosition}</Text> pozisyonuna atandÄ± <Text style={styles.playerPreviewCommunityHighlight}>(%{previewCommunityStats.mostAssignedPositionPercentage})</Text>
                          </Text>
                        </View>
                        {/* âœ… Bu pozisyon iÃ§in en Ã§ok tercih edilen oyuncu */}
                        <View style={[styles.playerPreviewCommunityRow, { borderTopWidth: 1, borderTopColor: 'rgba(255,255,255,0.1)', paddingTop: 8, marginTop: 4 }]}>
                          <Ionicons name="trophy" size={14} color="#10B981" />
                          <Text style={styles.playerPreviewCommunityText}>
                            <Text style={styles.playerPreviewCommunityHighlight}>{positionLabel}</Text> iÃ§in en Ã§ok: <Text style={styles.playerPreviewCommunityHighlight}>{previewCommunityStats.topPlayerForPosition}</Text> <Text style={{ color: '#10B981' }}>(%{previewCommunityStats.topPlayerPercentage})</Text>
                          </Text>
                        </View>
                      </View>
                    )
                  ) : (
                    <View style={{ alignItems: 'center', padding: 12 }}>
                      <Ionicons name="lock-closed" size={20} color="#9CA3AF" />
                      <Text style={{ color: '#9CA3AF', fontSize: 12, marginTop: 6, textAlign: 'center' }}>
                        Tahminlerinizi kaydedin ve topluluk verilerini gÃ¶rÃ¼n!
                      </Text>
                    </View>
                  )}
                </View>

                {/* Position Assignment Info */}
                <View style={styles.playerCardAssignInfo}>
                  <Ionicons name="locate" size={16} color="#1FA2A6" />
                  <Text style={styles.playerCardAssignText}>
                    <Text style={{ color: '#1FA2A6', fontWeight: '700' }}>{positionLabel}</Text> pozisyonuna atanacak
                  </Text>
                </View>

                {/* Action Buttons */}
                <View style={styles.playerCardActions}>
                  <TouchableOpacity
                    style={styles.playerCardCancelBtn}
                    onPress={() => setPreviewPlayer(null)}
                    activeOpacity={0.7}
                  >
                    <Text style={styles.playerCardCancelText}>VazgeÃ§</Text>
                  </TouchableOpacity>
                  
                  <TouchableOpacity
                    style={styles.playerCardAddBtn}
                    onPress={() => handlePlayerSelect(previewPlayer)}
                    activeOpacity={0.7}
                  >
                    <LinearGradient
                      colors={previewPlayer.injury ? ['#64748B', '#475569'] : ['#10B981', '#059669']}
                      start={{ x: 0, y: 0 }}
                      end={{ x: 1, y: 0 }}
                      style={styles.playerCardAddGradient}
                    >
                      <Ionicons name="person-add" size={18} color="#FFFFFF" />
                      <Text style={styles.playerCardAddText}>Kadroya Al</Text>
                    </LinearGradient>
                  </TouchableOpacity>
                </View>

                {/* Injury Warning */}
                {previewPlayer.injury && (
                  <View style={styles.playerCardWarning}>
                    <Ionicons name="alert-circle" size={16} color="#F59E0B" />
                    <Text style={styles.playerCardWarningText}>
                      SakatlÄ±k nedeniyle performansÄ± dÃ¼ÅŸÃ¼k olabilir
                    </Text>
                  </View>
                )}
              </View>
            </Animated.View>
          </View>
        </Modal>
      )}
    </>
  );
};

// Player Detail Modal - FULL STATS + Community Stats (tema uyumlu)
const PlayerDetailModal = ({ player, onClose, matchId, positionLabel, communityDataVisible = false }: any) => {
  const { theme } = useTheme();
  const isLight = theme === 'light';
  const themeColors = isLight ? COLORS.light : COLORS.dark;

  // âœ… KullanÄ±cÄ± istatistikleri state
  const [communityStats, setCommunityStats] = React.useState<{
    inStartingXI: number; // % kaÃ§Ä± ilk 11'de gÃ¶rmek istiyor
    inThisPosition: number; // % kaÃ§Ä± bu pozisyonda gÃ¶rmek istiyor
    loading: boolean;
  }>({ inStartingXI: 0, inThisPosition: 0, loading: true });
  
  // âœ… Mock kullanÄ±cÄ± istatistiklerini yÃ¼kle (gerÃ§ek API gelince deÄŸiÅŸtirilecek)
  React.useEffect(() => {
    const loadCommunityStats = async () => {
      try {
        // TODO: GerÃ§ek API entegrasyonu yapÄ±lacak
        // const result = await squadPredictionsApi.getPlayerCommunityStats(matchId, player.id, positionLabel);
        // Mock data - rating'e gÃ¶re daha gerÃ§ekÃ§i deÄŸerler
        const pRating = normalizeRatingTo100(player.rating);
        const baseXI = pRating >= 85 ? 75 : pRating >= 80 ? 60 : pRating >= 75 ? 45 : 30;
        const basePosition = pRating >= 85 ? 65 : pRating >= 80 ? 50 : pRating >= 75 ? 35 : 20;
        const variance = Math.floor(Math.random() * 15);
        
        setCommunityStats({
          inStartingXI: Math.min(95, baseXI + variance),
          inThisPosition: Math.min(90, basePosition + variance),
          loading: false,
        });
      } catch (error) {
        console.warn('Community stats load failed', error);
        setCommunityStats({ inStartingXI: 0, inThisPosition: 0, loading: false });
      }
    };
    
    loadCommunityStats();
  }, [player.id, player.rating, matchId, positionLabel]);
  
  return (
    <Modal
      visible={true}
      animationType="slide"
      transparent={true}
      onRequestClose={onClose}
    >
      <View style={styles.modalOverlay}>
        <Animated.View 
          entering={Platform.OS === 'web' ? undefined : SlideInDown.duration(300)}
          exiting={Platform.OS === 'web' ? undefined : SlideOutDown.duration(300)}
          style={[styles.playerDetailModal, isLight && { backgroundColor: themeColors.popover, borderColor: themeColors.border }]}
        >
          {/* Header - aÃ§Ä±k temada aÃ§Ä±k gradient */}
          <LinearGradient
            colors={normalizeRatingTo100(player.rating) >= 85 ? ['#C9A44C', '#8B6914'] : isLight ? [themeColors.muted, themeColors.card] : ['#1E3A3A', '#0F2A24']}
            style={[
              styles.playerDetailHeader,
              normalizeRatingTo100(player.rating) >= 85 && styles.playerDetailHeaderElite,
            ]}
          >
            <TouchableOpacity onPress={onClose} style={styles.modalCloseButton}>
              <Ionicons name="close" size={24} color={isLight ? themeColors.foreground : '#FFFFFF'} />
            </TouchableOpacity>

            <View style={styles.playerDetailHeaderContent}>
              <View style={[
                styles.playerDetailRating,
                { backgroundColor: normalizeRatingTo100(player.rating) >= 85 ? '#C9A44C' : '#1FA2A6' }
              ]}>
                <Text style={styles.playerDetailRatingText}>
                  {formatRatingDisplay(player.rating)}
                </Text>
              </View>

              <View style={styles.playerDetailInfo}>
                <Text style={[styles.playerDetailName, isLight && { color: themeColors.foreground }]}>
                {(player.firstname && player.lastname) ? `${String(player.firstname).trim()} ${String(player.lastname).trim()}` : (player.name || '')}
              </Text>
                <Text style={[styles.playerDetailMeta, isLight && { color: themeColors.mutedForeground }]}>
                  {player.position} â€¢ {player.team} â€¢ {player.age} yaÅŸ
                </Text>
                <View style={styles.playerDetailBadges}>
                  <View style={[styles.nationalityBadge, isLight && { backgroundColor: 'rgba(15, 42, 36, 0.12)' }]}>
                    <Ionicons name="flag" size={12} color={isLight ? themeColors.foreground : '#FFFFFF'} />
                    <Text style={[styles.nationalityText, isLight && { color: themeColors.foreground }]}>{player.nationality}</Text>
                  </View>
                  {player.form >= 8 && (
                    <View style={styles.formBadgeLarge}>
                      <Ionicons name="flame" size={12} color="#F59E0B" />
                      <Text style={styles.formTextLarge}>Form YÃ¼ksek</Text>
                    </View>
                  )}
                  {player.injury && (
                    <View style={styles.injuryBadgeLarge}>
                      <Ionicons name="warning" size={12} color="#EF4444" />
                      <Text style={styles.injuryTextLarge}>SakatlÄ±k</Text>
                    </View>
                  )}
                  {/* Elite badge for 85+ */}
                  {normalizeRatingTo100(player.rating) >= 85 && (
                    <View style={styles.eliteBadgeLarge}>
                      <Ionicons name="star" size={12} color="#C9A44C" />
                      <Text style={styles.eliteTextLarge}>Elit</Text>
                    </View>
                  )}
                </View>
              </View>
            </View>
          </LinearGradient>

          {/* Stats & Info - SCROLL YOK, TEK SAYFADA SIÄMALI */}
          <View style={[styles.playerDetailContentNoScroll, isLight && { borderTopColor: themeColors.border }]}>
            {/* âœ… Oyuncu Ä°statistikleri - 1 sÃ¼tun 6 satÄ±r dikey layout */}
            <Text style={[styles.playerDetailSectionTitleCompact, isLight && { color: themeColors.foreground }]}>ğŸ“Š Oyuncu Ä°statistikleri</Text>
            
            <View style={styles.statsGridCompact}>
              {(() => {
                // âœ… Kaleci mi kontrol et
                const playerPos = (player.position || player.pos || '').toUpperCase();
                const isGK = playerPos === 'GK' || playerPos === 'G' || playerPos.toLowerCase().includes('goalkeeper') || 
                             positionLabel?.toUpperCase() === 'GK' || positionLabel?.toLowerCase().includes('kaleci');
                
                // âœ… Kaleci Ã¶zellikleri (paceâ†’DalÄ±ÅŸ, shootingâ†’Refleks, vb. mapping)
                const goalkeeperStatNames: Record<string, string> = {
                  pace: 'DalÄ±ÅŸ',
                  shooting: 'Refleks',
                  passing: 'Top Tutma',
                  dribbling: 'Konumlanma',
                  defending: 'Hava Topu',
                  physical: 'Bire Bir'
                };
                
                // âœ… Saha oyuncusu Ã¶zellikleri
                const outfieldStatNames: Record<string, string> = {
                  pace: 'HÄ±z',
                  shooting: 'Åut',
                  passing: 'Pas',
                  dribbling: 'Dribling',
                  defending: 'Savunma',
                  physical: 'Fizik'
                };
                
                const statNames = isGK ? goalkeeperStatNames : outfieldStatNames;
                
                return Object.entries(player.stats || {}).map(([key, value]: [string, any]) => {
                  const clampedValue = Math.max(50, Math.min(99, Number(value) || 70));
                  const statColor = clampedValue >= 80 ? '#1FA2A6' : clampedValue >= 70 ? '#F59E0B' : '#9CA3AF';
                  
                  return (
                    <View key={key} style={[styles.statItemCompact, isLight && { backgroundColor: themeColors.muted, borderColor: themeColors.border }]}>
                      {/* Label - Sol */}
                      <Text style={[styles.statLabelCompact, isLight && { color: themeColors.mutedForeground }]}>{statNames[key] || key}</Text>
                      {/* Progress Bar - Orta */}
                      <View style={styles.statBarBackgroundCompact}>
                        <View 
                          style={[
                            styles.statBarFillCompact, 
                            { width: `${clampedValue}%`, backgroundColor: statColor }
                          ]} 
                        />
                      </View>
                      {/* Value - SaÄŸ */}
                      <Text style={[styles.statValueCompact, { color: statColor }]}>{clampedValue}</Text>
                    </View>
                  );
                });
              })()}
            </View>

            {/* âœ… Form/Pozisyon/YaÅŸ - tek satÄ±r inline */}
            <View style={styles.additionalInfoCompact}>
              <View style={[styles.infoChip, isLight && { backgroundColor: 'rgba(31, 162, 166, 0.08)', borderColor: themeColors.border }]}>
                <Ionicons name="fitness" size={14} color="#1FA2A6" />
                <Text style={[styles.infoChipText, isLight && { color: themeColors.foreground }]}>Form: {player.form}/10</Text>
              </View>
              <View style={[styles.infoChip, isLight && { backgroundColor: 'rgba(31, 162, 166, 0.08)', borderColor: themeColors.border }]}>
                <Ionicons name="shirt" size={14} color="#1FA2A6" />
                <Text style={[styles.infoChipText, isLight && { color: themeColors.foreground }]}>{player.position}</Text>
              </View>
              <View style={[styles.infoChip, isLight && { backgroundColor: 'rgba(31, 162, 166, 0.08)', borderColor: themeColors.border }]}>
                <Ionicons name="person" size={14} color="#1FA2A6" />
                <Text style={[styles.infoChipText, isLight && { color: themeColors.foreground }]}>{player.age} yaÅŸ</Text>
              </View>
            </View>
            
            {/* Topluluk Tercihleri - Kompakt versiyon */}
            <View style={[styles.communityStatsSectionCompact, isLight && { borderTopColor: themeColors.border }]}>
              <Text style={[styles.playerDetailSectionTitleCompact, isLight && { color: themeColors.foreground }]}>ğŸ‘¥ Topluluk Tercihleri</Text>
              
              {communityDataVisible ? (
                communityStats.loading ? (
                  <View style={styles.communityStatsCompactLoading}>
                    <Text style={{ color: themeColors.mutedForeground, fontSize: 12 }}>YÃ¼kleniyor...</Text>
                  </View>
                ) : (
                  <View style={styles.communityStatsCompactRow}>
                    {/* Ä°lk 11'de gÃ¶rmek isteyenler */}
                    <View style={[styles.communityStatChip, isLight && { backgroundColor: themeColors.muted, borderColor: themeColors.border }]}>
                      <Ionicons name="football" size={14} color="#1FA2A6" />
                      <Text style={[styles.communityStatChipLabel, isLight && { color: themeColors.mutedForeground }]}>Ä°lk 11</Text>
                      <Text style={[
                        styles.communityStatChipValue,
                        { color: communityStats.inStartingXI >= 60 ? '#10B981' : communityStats.inStartingXI >= 40 ? '#F59E0B' : '#64748B' }
                      ]}>%{communityStats.inStartingXI}</Text>
                    </View>
                    
                    {/* Bu pozisyonda gÃ¶rmek isteyenler */}
                    {positionLabel && (
                      <View style={[styles.communityStatChip, isLight && { backgroundColor: themeColors.muted, borderColor: themeColors.border }]}>
                        <Ionicons name="locate" size={14} color="#3B82F6" />
                        <Text style={[styles.communityStatChipLabel, isLight && { color: themeColors.mutedForeground }]}>{positionLabel}</Text>
                        <Text style={[
                          styles.communityStatChipValue,
                          { color: communityStats.inThisPosition >= 50 ? '#3B82F6' : communityStats.inThisPosition >= 30 ? '#F59E0B' : '#64748B' }
                        ]}>%{communityStats.inThisPosition}</Text>
                      </View>
                    )}
                  </View>
                )
              ) : (
                <View style={[styles.communityStatsCompactLocked, isLight && { backgroundColor: themeColors.muted }]}>
                  <Ionicons name="lock-closed" size={16} color={themeColors.mutedForeground} />
                  <Text style={[styles.communityStatsCompactLockedText, isLight && { color: themeColors.mutedForeground }]}>
                    Tahminlerinizi kaydedin
                  </Text>
                </View>
              )}
            </View>
          </View>

          {/* Close Button */}
          <View style={[styles.playerDetailActions, isLight && { borderTopColor: themeColors.border }]}>
            <TouchableOpacity
              style={styles.playerDetailCloseButton}
              onPress={onClose}
              activeOpacity={0.8}
            >
              <LinearGradient
                colors={['#1FA2A6', '#047857']}
                style={styles.playerDetailCloseButtonGradient}
              >
                <Text style={styles.playerDetailCloseButtonText}>Kapat</Text>
              </LinearGradient>
            </TouchableOpacity>
          </View>
        </Animated.View>
      </View>
    </Modal>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: 'transparent', // âœ… Grid pattern gÃ¶rÃ¼nsÃ¼n - MatchDetail'den geliyor
  },
  
  // âœ… KullanÄ±cÄ± Tercih Ä°statistikleri KartÄ±
  // âœ… Kompakt tercih istatistikleri kartÄ±
  preferenceStatsCardCompact: {
    marginHorizontal: 12,
    marginTop: 4,
    marginBottom: 4,
    backgroundColor: 'rgba(31, 162, 166, 0.1)',
    borderRadius: 8,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)',
  },
  preferenceStatsRowCompact: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 10,
    paddingVertical: 6,
    gap: 6,
    flexWrap: 'wrap',
  },
  preferenceStatsTextCompact: {
    color: '#9CA3AF',
    fontSize: 11,
    flex: 1,
  },
  preferenceFormationBadges: {
    flexDirection: 'row',
    gap: 6,
  },
  preferenceFormationBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'rgba(255, 255, 255, 0.08)',
    paddingHorizontal: 6,
    paddingVertical: 2,
    borderRadius: 4,
    gap: 3,
  },
  preferenceFormationBadgeText: {
    color: '#FFFFFF',
    fontSize: 10,
    fontWeight: '600',
  },
  
  // âœ… Yeni Tercih KartÄ± Stilleri (Sol: kullanÄ±cÄ±, SaÄŸ: formasyonlar)
  preferenceStatsCardNew: {
    flexDirection: 'row',
    marginHorizontal: 12,
    marginTop: 4,
    marginBottom: 4,
    backgroundColor: 'rgba(31, 162, 166, 0.08)',
    borderRadius: 10,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.15)',
    overflow: 'hidden',
  },
  preferenceStatsLeftSection: {
    flexDirection: 'column',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 8,
    paddingHorizontal: 12,
    backgroundColor: 'rgba(31, 162, 166, 0.1)',
    borderRightWidth: 1,
    borderRightColor: 'rgba(255, 255, 255, 0.05)',
  },
  preferenceStatsUserCount: {
    color: '#1FA2A6',
    fontSize: 16,
    fontWeight: '700',
  },
  preferenceStatsUserLabel: {
    color: '#6B7280',
    fontSize: 9,
    marginTop: 1,
  },
  preferenceStatsRightSection: {
    flex: 1,
    paddingVertical: 4,
    paddingHorizontal: 8,
    gap: 2,
  },
  preferenceFormationRowClickable: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 5,
    paddingHorizontal: 6,
    borderRadius: 6,
    backgroundColor: 'rgba(255, 255, 255, 0.03)',
    gap: 4,
  },
  preferenceFormationLabel: {
    color: '#9CA3AF',
    fontSize: 10,
    width: 42,
  },
  preferenceFormationValue: {
    color: '#FFFFFF',
    fontSize: 12,
    fontWeight: '600',
    flex: 1,
  },
  preferenceFormationPercent: {
    color: '#10B981',
    fontSize: 10,
    fontWeight: '700',
  },
  
  // âœ… Ä°lk 11 Popup Stilleri - Design System Uyumlu
  startingXIPopupOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.92)',
    justifyContent: 'center',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 40, // âœ… Ãœst/alt boÅŸluk - ekran taÅŸmasÄ±nÄ± Ã¶nle
  },
  startingXIPopupModal: {
    width: '100%',
    maxWidth: 380, // âœ… STANDART: 380px geniÅŸlik
    maxHeight: '90%', // âœ… Ekran yÃ¼ksekliÄŸinin %90'Ä± - taÅŸma Ã¶nlenir
    borderRadius: 20,
    overflow: 'hidden',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)',
  },
  startingXIPopupGradient: {
    paddingVertical: 14,
    paddingHorizontal: 14,
  },
  startingXIPopupHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
    paddingBottom: 12,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(31, 162, 166, 0.2)',
  },
  startingXIPopupScrollOld: {
    // KullanÄ±lmÄ±yor - artÄ±k scroll yok
    maxHeight: 400,
  },
  startingXIPopupItem: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    borderRadius: 8,
    padding: 12,
    marginBottom: 6,
    gap: 12,
  },
  startingXIPopupItemGK: {
    backgroundColor: 'rgba(59, 130, 246, 0.15)',
    borderWidth: 1,
    borderColor: 'rgba(59, 130, 246, 0.3)',
  },
  startingXIPopupItemNumber: {
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: 'rgba(31, 162, 166, 0.2)',
    alignItems: 'center',
    justifyContent: 'center',
  },
  startingXIPopupItemNumberText: {
    color: '#1FA2A6',
    fontSize: 14,
    fontWeight: '700',
  },
  startingXIPopupItemName: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: '600',
    flex: 1,
  },
  startingXIPopupItemPosition: {
    color: '#9CA3AF',
    fontSize: 11,
    fontWeight: '500',
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  startingXIPopupFooterOld: {
    marginTop: 12,
    paddingTop: 12,
    borderTopWidth: 1,
    borderTopColor: 'rgba(31, 162, 166, 0.2)',
  },
  startingXIPopupFooterTextOld: {
    color: 'rgba(255, 255, 255, 0.4)',
    fontSize: 11,
    textAlign: 'center',
    fontStyle: 'italic',
  },
  
  // âœ… Formasyon Detay Popup Stilleri - STANDART POPUP KURALLARI
  formationDetailOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.8)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 16,
  },
  formationDetailModal: {
    width: '100%',
    maxWidth: 380, // âœ… STANDART: 380px geniÅŸlik
    maxHeight: '90%',
    borderRadius: 16,
    overflow: 'hidden',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)',
    backgroundColor: '#1A2E2A', // âœ… STANDART: Koyu yeÅŸil-mavi
  },
  formationDetailGradient: {
    padding: 20,
    paddingBottom: 30,
  },
  formationDetailHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  formationDetailTitle: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '700',
  },
  formationDetailTabs: {
    flexDirection: 'row',
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    borderRadius: 10,
    padding: 4,
    marginBottom: 16,
  },
  formationDetailTab: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 8,
    borderRadius: 8,
    gap: 6,
  },
  formationDetailTabActive: {
    backgroundColor: 'rgba(31, 162, 166, 0.2)',
  },
  formationDetailTabText: {
    color: '#6B7280',
    fontSize: 13,
    fontWeight: '600',
  },
  formationDetailTabTextActive: {
    color: '#FFFFFF',
  },
  formationDetailScroll: {
    maxHeight: 450,
  },
  formationDetailSelected: {
    alignItems: 'center',
    paddingVertical: 16,
    backgroundColor: 'rgba(31, 162, 166, 0.1)',
    borderRadius: 12,
    marginBottom: 16,
  },
  formationDetailSelectedLabel: {
    color: '#9CA3AF',
    fontSize: 11,
    marginBottom: 4,
  },
  formationDetailSelectedValue: {
    color: '#FFFFFF',
    fontSize: 28,
    fontWeight: '700',
  },
  formationDetailSelectedBadge: {
    backgroundColor: '#10B981',
    paddingHorizontal: 12,
    paddingVertical: 4,
    borderRadius: 12,
    marginTop: 8,
  },
  formationDetailSelectedBadgeText: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: '700',
  },
  formationDetailSection: {
    marginBottom: 20,
  },
  formationDetailSectionTitle: {
    color: '#FFFFFF',
    fontSize: 13,
    fontWeight: '700',
    marginBottom: 10,
  },
  formationDetailItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 8,
    paddingHorizontal: 10,
    backgroundColor: 'rgba(255, 255, 255, 0.03)',
    borderRadius: 8,
    marginBottom: 6,
  },
  formationDetailItemFirst: {
    backgroundColor: 'rgba(16, 185, 129, 0.1)',
    borderWidth: 1,
    borderColor: 'rgba(16, 185, 129, 0.3)',
  },
  formationDetailItemRank: {
    color: '#6B7280',
    fontSize: 12,
    fontWeight: '600',
    width: 28,
  },
  formationDetailItemName: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: '500',
    flex: 1,
  },
  formationDetailItemCount: {
    color: '#6B7280',
    fontSize: 10,
    marginRight: 8,
  },
  formationDetailItemPercentBadge: {
    backgroundColor: 'rgba(255, 255, 255, 0.1)',
    paddingHorizontal: 8,
    paddingVertical: 3,
    borderRadius: 6,
  },
  formationDetailItemPercent: {
    color: '#FFFFFF',
    fontSize: 12,
    fontWeight: '700',
  },
  formationDetailPositionGroup: {
    borderRadius: 12,
    padding: 12,
    marginBottom: 10,
    borderWidth: 1,
    // âœ… Arka plan ve border pozisyon grubuna gÃ¶re dinamik uygulanÄ±r
  },
  formationDetailPositionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  formationDetailPositionLabel: {
    fontSize: 13,
    fontWeight: '700',
    letterSpacing: 0.3,
    // âœ… Renk pozisyon grubuna gÃ¶re dinamik uygulanÄ±r
  },
  formationDetailPositionBadge: {
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 10,
  },
  formationDetailPositionBadgeText: {
    color: '#FFFFFF',
    fontSize: 11,
    fontWeight: '700',
  },
  formationDetailPositionItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 10,
    borderRadius: 8,
    marginBottom: 4,
    backgroundColor: 'rgba(255, 255, 255, 0.04)',
    borderLeftWidth: 2,
    borderLeftColor: '#6B7280',
  },
  formationDetailPositionItemFirst: {
    backgroundColor: 'rgba(255, 255, 255, 0.08)',
  },
  formationDetailPositionItemRank: {
    color: '#6B7280',
    fontSize: 10,
    fontWeight: '600',
    width: 20,
  },
  formationDetailPositionItemName: {
    color: '#FFFFFF',
    fontSize: 11,
    fontWeight: '500',
    flex: 1,
  },
  formationDetailPositionItemCount: {
    color: '#6B7280',
    fontSize: 9,
    marginRight: 6,
  },
  formationDetailPositionItemPercent: {
    fontSize: 11,
    fontWeight: '700',
    width: 32,
    textAlign: 'right',
  },
  
  // âœ… Ä°lk 11 Popup Stilleri
  startingXIPopupOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.85)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  startingXIPopupModal: {
    width: '100%',
    maxWidth: 340,
    // âœ… maxHeight kaldÄ±rÄ±ldÄ± - tÃ¼m iÃ§erik gÃ¶rÃ¼nsÃ¼n
    borderRadius: 14,
    overflow: 'hidden',
  },
  startingXIPopupGradient: {
    paddingVertical: 12,
    paddingHorizontal: 14,
  },
  startingXIPopupTitleRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  startingXIPopupTitle: {
    color: '#FFFFFF',
    fontSize: 18,
    fontWeight: '700',
    letterSpacing: 0.3,
  },
  startingXIPopupTeamInfo: {
    alignItems: 'center',
    marginBottom: 16,
    paddingBottom: 12,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(31, 162, 166, 0.2)',
  },
  startingXIPopupTeamName: {
    color: '#1FA2A6',
    fontSize: 16,
    fontWeight: '700',
    letterSpacing: 0.5,
  },
  startingXIPopupTeamSubtext: {
    color: 'rgba(255, 255, 255, 0.5)',
    fontSize: 11,
    marginTop: 4,
    fontStyle: 'italic',
  },
  startingXIPopupPlayerList: {
    // âœ… Scroll yok - tÃ¼m 11 oyuncu tek ekranda gÃ¶rÃ¼nsÃ¼n
  },
  startingXIPopupPlayerItem: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'rgba(31, 162, 166, 0.08)',
    borderRadius: 8,
    paddingVertical: 6,
    paddingHorizontal: 8,
    marginBottom: 3,
    borderLeftWidth: 3,
    borderLeftColor: 'rgba(31, 162, 166, 0.4)',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.1)',
  },
  startingXIPopupPlayerItemGK: {
    backgroundColor: 'rgba(245, 158, 11, 0.12)',
    borderLeftColor: '#F59E0B',
    borderLeftWidth: 4,
    borderColor: 'rgba(245, 158, 11, 0.2)',
  },
  startingXIPopupPlayerNumber: {
    width: 24,
    height: 24,
    borderRadius: 12,
    backgroundColor: 'rgba(31, 162, 166, 0.2)',
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 6,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)',
  },
  startingXIPopupPlayerNumberText: {
    color: '#1FA2A6',
    fontSize: 11,
    fontWeight: '700',
  },
  startingXIPopupPlayerInfo: {
    flex: 1,
  },
  startingXIPopupPlayerName: {
    color: '#FFFFFF',
    fontSize: 12,
    fontWeight: '600',
  },
  startingXIPopupPlayerPosition: {
    color: 'rgba(255, 255, 255, 0.5)',
    fontSize: 9,
    marginTop: 1,
  },
  startingXIPopupPlayerPercent: {
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 10,
    minWidth: 48,
    alignItems: 'center',
    justifyContent: 'center',
  },
  startingXIPopupPlayerPercentText: {
    color: '#FFFFFF',
    fontSize: 12,
    fontWeight: '700',
    letterSpacing: 0.3,
  },
  startingXIPopupFooter: {
    alignItems: 'center',
    paddingTop: 14,
    marginTop: 12,
    borderTopWidth: 1,
    borderTopColor: 'rgba(31, 162, 166, 0.2)',
  },
  startingXIPopupFooterText: {
    color: 'rgba(255, 255, 255, 0.4)',
    fontSize: 11,
    fontStyle: 'italic',
    letterSpacing: 0.3,
  },
  
  // âœ… MaÃ§ BaÅŸlarken Tahmin Tamamlama Popup Stilleri
  completePredictionPopupOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.85)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  completePredictionPopupModal: {
    width: '100%',
    maxWidth: 380, // âœ… STANDART: 380px geniÅŸlik
    borderRadius: 16,
    overflow: 'hidden',
  },
  completePredictionPopupGradient: {
    padding: 24,
  },
  completePredictionPopupHeader: {
    alignItems: 'center',
    marginBottom: 16,
  },
  completePredictionPopupTitle: {
    color: '#FFFFFF',
    fontSize: 20,
    fontWeight: '700',
    marginTop: 8,
    textAlign: 'center',
  },
  completePredictionPopupMessage: {
    color: '#E5E7EB',
    fontSize: 14,
    lineHeight: 22,
    textAlign: 'center',
    marginBottom: 12,
  },
  completePredictionPopupBold: {
    color: '#1FA2A6',
    fontWeight: '700',
  },
  completePredictionPopupWarning: {
    color: '#F59E0B',
    fontSize: 12,
    textAlign: 'center',
    fontStyle: 'italic',
    marginBottom: 24,
  },
  completePredictionPopupButtons: {
    flexDirection: 'row',
    gap: 12,
  },
  completePredictionPopupButtonSecondary: {
    flex: 1,
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderRadius: 10,
    backgroundColor: 'rgba(255, 255, 255, 0.1)',
    alignItems: 'center',
  },
  completePredictionPopupButtonSecondaryText: {
    color: '#9CA3AF',
    fontSize: 14,
    fontWeight: '600',
  },
  completePredictionPopupButtonPrimary: {
    flex: 2,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderRadius: 10,
    backgroundColor: '#1FA2A6',
  },
  completePredictionPopupButtonPrimaryText: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: '700',
  },
  
  // âœ… Tam Tercih Ã–zeti Popup Stilleri - STANDART POPUP KURALLARI
  fullPreferenceSummaryOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.8)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 16,
  },
  fullPreferenceSummaryModal: {
    width: '100%',
    maxWidth: 380, // âœ… STANDART: 380px geniÅŸlik
    maxHeight: '90%',
    borderRadius: 16,
    overflow: 'hidden',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)', // âœ… STANDART: Turkuaz border
    backgroundColor: '#1A2E2A', // âœ… STANDART: Koyu yeÅŸil-mavi
  },
  fullPreferenceSummaryGradient: {
    padding: 20,
  },
  fullPreferenceSummaryHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  fullPreferenceSummaryUserCount: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
    backgroundColor: 'rgba(16, 185, 129, 0.15)',
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 20,
    marginBottom: 16,
  },
  fullPreferenceSummaryUserCountText: {
    color: '#10B981',
    fontSize: 13,
    fontWeight: '600',
  },
  fullPreferenceSummaryScroll: {
    maxHeight: 400,
  },
  fullPreferenceSummarySection: {
    marginBottom: 16,
  },
  fullPreferenceSummaryNote: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
    paddingVertical: 12,
    paddingHorizontal: 16,
    backgroundColor: 'rgba(156, 163, 175, 0.1)',
    borderRadius: 8,
    marginTop: 8,
  },
  fullPreferenceSummaryNoteText: {
    color: '#9CA3AF',
    fontSize: 11,
    fontStyle: 'italic',
  },
  fullPreferenceSummarySectionTitle: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: '700',
    marginBottom: 12,
  },
  fullPreferenceFormationGroup: {
    backgroundColor: 'rgba(255, 255, 255, 0.03)',
    borderRadius: 10,
    padding: 10,
    marginBottom: 8,
  },
  fullPreferenceFormationGroupHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    marginBottom: 6,
  },
  fullPreferenceFormationGroupTitle: {
    color: '#9CA3AF',
    fontSize: 11,
    fontWeight: '600',
    textTransform: 'uppercase',
    letterSpacing: 0.5,
  },
  fullPreferenceFormationGroupArrow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
  },
  fullPreferenceFormationGroupArrowText: {
    color: '#F59E0B',
    fontSize: 10,
    fontWeight: '600',
  },
  fullPreferenceFormationItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 6,
    paddingHorizontal: 8,
    borderRadius: 6,
    marginBottom: 4,
    backgroundColor: 'rgba(255, 255, 255, 0.02)',
  },
  fullPreferenceFormationItemFirst: {
    backgroundColor: 'rgba(16, 185, 129, 0.1)',
  },
  fullPreferenceFormationItemRank: {
    color: '#6B7280',
    fontSize: 11,
    fontWeight: '600',
    width: 24,
  },
  fullPreferenceFormationItemName: {
    color: '#FFFFFF',
    fontSize: 13,
    fontWeight: '500',
    flex: 1,
  },
  fullPreferenceFormationItemNameFirst: {
    color: '#10B981',
    fontWeight: '700',
  },
  fullPreferenceFormationItemCount: {
    color: '#6B7280',
    fontSize: 10,
    marginRight: 8,
  },
  fullPreferenceFormationItemPercentage: {
    color: '#9CA3AF',
    fontSize: 12,
    fontWeight: '700',
    width: 36,
    textAlign: 'right',
  },
  fullPreferencePositionGroup: {
    backgroundColor: 'rgba(255, 255, 255, 0.03)',
    borderRadius: 10,
    padding: 10,
    marginBottom: 8,
  },
  fullPreferencePositionGroupTitle: {
    color: '#1FA2A6',
    fontSize: 11,
    fontWeight: '600',
    marginBottom: 6,
  },
  fullPreferencePositionItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 5,
    paddingHorizontal: 8,
    borderRadius: 6,
    marginBottom: 3,
    backgroundColor: 'rgba(255, 255, 255, 0.02)',
    borderLeftWidth: 2,
    borderLeftColor: '#6B7280',
  },
  fullPreferencePositionItemFirst: {
    backgroundColor: 'rgba(31, 162, 166, 0.1)',
  },
  fullPreferencePositionItemRank: {
    color: '#6B7280',
    fontSize: 10,
    fontWeight: '600',
    width: 20,
  },
  fullPreferencePositionItemName: {
    color: '#FFFFFF',
    fontSize: 12,
    fontWeight: '500',
    flex: 1,
  },
  fullPreferencePositionItemNameFirst: {
    color: '#1FA2A6',
    fontWeight: '700',
  },
  fullPreferencePositionItemCount: {
    color: '#6B7280',
    fontSize: 9,
    marginRight: 6,
  },
  fullPreferencePositionItemPercentage: {
    fontSize: 11,
    fontWeight: '700',
    width: 32,
    textAlign: 'right',
  },
  
  // Eski stiller (geriye uyumluluk iÃ§in)
  preferenceStatsCard: {
    marginHorizontal: 12,
    marginTop: 8,
    marginBottom: 4,
    borderRadius: 12,
    overflow: 'hidden',
  },
  preferenceStatsGradient: {
    padding: 12,
  },
  preferenceStatsHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    marginBottom: 8,
  },
  preferenceStatsTitle: {
    color: '#1FA2A6',
    fontSize: 13,
    fontWeight: '600',
  },
  preferenceStatsContent: {
    gap: 6,
  },
  preferenceStatRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  preferenceStatLabel: {
    color: '#9CA3AF',
    fontSize: 12,
  },
  preferenceStatValue: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  preferenceStatFormation: {
    color: '#FFFFFF',
    fontSize: 13,
    fontWeight: '600',
  },
  preferenceStatPercentage: {
    color: '#10B981',
    fontSize: 12,
    fontWeight: '700',
    backgroundColor: 'rgba(16, 185, 129, 0.2)',
    paddingHorizontal: 6,
    paddingVertical: 2,
    borderRadius: 4,
  },
  preferenceStatsHint: {
    color: '#6B7280',
    fontSize: 10,
    fontStyle: 'italic',
    marginTop: 8,
    textAlign: 'center',
  },
  
  // âœ… Tercih Popup Stilleri - STANDART POPUP KURALLARI
  preferencePopupOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.8)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 16,
  },
  preferencePopupModal: {
    width: '100%',
    maxWidth: 380, // âœ… STANDART: 380px geniÅŸlik
    borderRadius: 16,
    overflow: 'hidden',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)', // âœ… STANDART: Turkuaz border
    backgroundColor: '#1A2E2A', // âœ… STANDART: Koyu yeÅŸil-mavi
  },
  preferencePopupGradient: {
    padding: 20,
  },
  preferencePopupHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
  },
  preferencePopupTitleRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  preferencePopupTitle: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '700',
  },
  preferencePopupPositionInfo: {
    alignItems: 'center',
    marginBottom: 16,
    paddingBottom: 16,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(255, 255, 255, 0.1)',
  },
  preferencePopupPositionLabel: {
    color: '#9CA3AF',
    fontSize: 11,
    textTransform: 'uppercase',
    letterSpacing: 1,
  },
  preferencePopupPlayerName: {
    color: '#FFFFFF',
    fontSize: 18,
    fontWeight: '700',
    marginTop: 4,
  },
  preferencePopupBadge: {
    backgroundColor: '#10B981',
    paddingHorizontal: 12,
    paddingVertical: 4,
    borderRadius: 12,
    marginTop: 8,
  },
  preferencePopupBadgeText: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: '700',
  },
  preferencePopupList: {
    marginBottom: 12,
  },
  preferencePopupListTitle: {
    color: '#9CA3AF',
    fontSize: 12,
    marginBottom: 8,
  },
  preferencePopupItem: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    borderRadius: 8,
    padding: 10,
    marginBottom: 6,
    borderLeftWidth: 2,
    borderLeftColor: '#6B7280',
  },
  preferencePopupItemSelected: {
    backgroundColor: 'rgba(16, 185, 129, 0.15)',
  },
  preferencePopupItemRank: {
    color: '#6B7280',
    fontSize: 12,
    fontWeight: '600',
    width: 24,
  },
  preferencePopupItemName: {
    color: '#FFFFFF',
    fontSize: 13,
    fontWeight: '500',
    flex: 1,
  },
  preferencePopupItemNameSelected: {
    color: '#10B981',
  },
  preferencePopupItemStats: {
    alignItems: 'flex-end',
  },
  preferencePopupItemCount: {
    color: '#9CA3AF',
    fontSize: 10,
  },
  preferencePopupItemPercentage: {
    fontSize: 13,
    fontWeight: '700',
  },
  preferencePopupTotal: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
    paddingTop: 12,
    borderTopWidth: 1,
    borderTopColor: 'rgba(255, 255, 255, 0.1)',
  },
  preferencePopupTotalText: {
    color: '#9CA3AF',
    fontSize: 11,
  },
  
  // âœ… Oyuncu Reyting Dropdown Stilleri
  playerRatingDropdownHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: 'rgba(201, 164, 76, 0.1)',
    borderWidth: 1,
    borderColor: 'rgba(201, 164, 76, 0.3)',
    borderRadius: 12,
    padding: 12,
    marginTop: 16,
  },
  playerRatingDropdownHeaderLeft: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  playerRatingDropdownHeaderText: {
    color: '#C9A44C',
    fontSize: 13,
    fontWeight: '600',
  },
  playerRatingDropdownHeaderRight: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  playerRatingDropdownAvg: {
    color: '#C9A44C',
    fontSize: 16,
    fontWeight: '700',
  },
  playerRatingDropdownContent: {
    backgroundColor: 'rgba(0, 0, 0, 0.3)',
    borderRadius: 12,
    padding: 12,
    marginTop: 8,
    gap: 8,
  },
  playerRatingDropdownRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  playerRatingDropdownRowLeft: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
    width: 100,
  },
  playerRatingDropdownEmoji: {
    fontSize: 14,
  },
  playerRatingDropdownTitle: {
    color: '#9CA3AF',
    fontSize: 11,
    fontWeight: '500',
  },
  playerRatingDropdownRowRight: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    marginLeft: 8,
  },
  playerRatingDropdownBar: {
    flex: 1,
    height: 6,
    backgroundColor: 'rgba(255, 255, 255, 0.1)',
    borderRadius: 3,
    overflow: 'hidden',
  },
  playerRatingDropdownBarFill: {
    height: '100%',
    borderRadius: 3,
  },
  playerRatingDropdownValue: {
    fontSize: 12,
    fontWeight: '700',
    width: 28,
    textAlign: 'right',
  },
  playerRatingDropdownVoters: {
    color: '#6B7280',
    fontSize: 9,
    width: 32,
    textAlign: 'right',
  },
  
  // âœ… Oyuncu KartÄ± Tercih Badge
  playerPreferenceBadge: {
    position: 'absolute',
    bottom: -4,
    right: -4,
    backgroundColor: '#10B981',
    borderRadius: 8,
    paddingHorizontal: 4,
    paddingVertical: 1,
    zIndex: 10,
    borderWidth: 1,
    borderColor: '#FFFFFF',
  },
  playerPreferenceBadgeText: {
    color: '#FFFFFF',
    fontSize: 8,
    fontWeight: '700',
  },
  
  // Empty State
  emptyStateContainer: {
    flex: 1,
    padding: 16,
    justifyContent: 'center',
  },
  emptyStateContent: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: 'rgba(255, 255, 255, 0.1)',
    borderRadius: 16,
    padding: 24,
    margin: 40,
  },
  emptyStateBall: {
    marginBottom: 16,
  },
  emptyStateBallEmoji: {
    fontSize: 48,
  },
  emptyStateTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#FFFFFF',
    marginBottom: 8,
    textShadowColor: 'rgba(0,0,0,0.5)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 2,
  },
  emptyStateSubtitle: {
    fontSize: 14,
    color: '#FFFFFF',
    textAlign: 'center',
    textShadowColor: 'rgba(0,0,0,0.5)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 2,
  },
  selectFormationButton: {
    height: 50,
    borderRadius: 12,
    overflow: 'hidden',
    marginTop: 12, // 4px yukarÄ± (Ã¶nceki 16)
  },
  
  // Football Field â€“ boyutlar PITCH_LAYOUT (config/constants) tek kaynak
  fieldContainer: {
    width: isWeb ? '100%' : width - PITCH_LAYOUT.H_PADDING,
    maxWidth: isWeb ? PITCH_LAYOUT.WEB_MAX_WIDTH : undefined,
    height: isWeb ? PITCH_LAYOUT.WEB_HEIGHT : (width - PITCH_LAYOUT.H_PADDING) * PITCH_LAYOUT.ASPECT_RATIO,
    alignSelf: 'center',
    borderRadius: 12,
    overflow: 'hidden',
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.3,
        shadowRadius: 8,
      },
      android: {
        elevation: 8,
      },
      web: {
        boxShadow: '0px 4px 8px rgba(0, 0, 0, 0.3)',
      },
    }),
  },
  fieldGradient: {
    flex: 1,
  },
  fieldSvg: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
  },
  
  // Main Container â€“ y ekseni boÅŸluklarÄ± azaltÄ±ldÄ±, saha yÃ¼ksekliÄŸi arttÄ±
  mainContainer: {
    flex: 1,
    flexDirection: 'column',
    paddingHorizontal: 12,
    paddingTop: 8,
    paddingBottom: 8,
  },
  mainField: {
    width: isWeb ? '100%' : width - PITCH_LAYOUT.H_PADDING,
    maxWidth: isWeb ? PITCH_LAYOUT.WEB_MAX_WIDTH : undefined,
    height: isWeb ? PITCH_LAYOUT.WEB_HEIGHT : (width - PITCH_LAYOUT.H_PADDING) * PITCH_LAYOUT.ASPECT_RATIO,
    alignSelf: 'center',
    marginBottom: 0,
  },
  playersContainer: {
    flex: 1,
    position: 'relative',
    overflow: 'visible', // âœ… KartlarÄ±n kesilmemesi iÃ§in
  },
  
  // Player Slot - Centered on position
  playerSlot: {
    position: 'absolute',
    transform: [{ translateX: -32 }, { translateY: -38 }], // Half of card size
    zIndex: 5,
    elevation: 5,
  },
  playerCardWrapper: {
    position: 'relative',
    zIndex: 10,
    elevation: 10,
    overflow: 'visible',
  },
  subOutOuter: {
    borderRadius: 10,
  },
  subOutBorderThin: {
    borderWidth: 1,
    borderColor: '#EF4444',
  },
  subOutBorderThick: {
    borderWidth: 2,
    borderColor: '#EF4444',
  },
  subOutBorderPulse: {
    borderWidth: 2,
    borderColor: '#EF4444',
    shadowColor: '#EF4444',
    shadowOffset: { width: 0, height: 0 },
    shadowOpacity: 0.6,
    shadowRadius: 4,
    elevation: 6,
  },
  subOutInfoIcon: {
    position: 'absolute',
    top: 2,
    right: 2,
    zIndex: 12,
    padding: 2,
  },
  // X butonu her zaman oyuncu kartÄ±nÄ±n ÃœSTÃœNDE (kartÄ±n altÄ±nda kalmamalÄ±)
  
  // Player Card - Reduced size to prevent overflow (64x76)
  playerCard: {
    width: 64,
    height: 76,
    borderRadius: 8,
    overflow: 'hidden',
    borderWidth: 2,
    borderColor: 'rgba(100, 116, 139, 0.3)', // Default gray border
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.3,
        shadowRadius: 4,
      },
      android: {
        elevation: 4,
      },
      web: {
        boxShadow: '0px 2px 4px rgba(0, 0, 0, 0.3)',
      },
    }),
  },
  playerCardElite: {
    borderColor: '#C9A44C', // Gold border for elite players (85+)
    borderWidth: 2.5,
    ...Platform.select({
      ios: {
        shadowColor: '#C9A44C',
        shadowOffset: { width: 0, height: 0 },
        shadowOpacity: 0.6,
        shadowRadius: 8,
      },
      android: {
        elevation: 8,
      },
      web: {
        boxShadow: '0 0 12px rgba(201, 164, 76, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3)',
      },
    }),
  },
  playerCardGK: {
    borderColor: '#3B82F6', // Blue border for goalkeepers
    borderWidth: 2,
  },
  playerCardGradient: {
    flex: 1,
    padding: 4,
    paddingBottom: 18, // âœ… Alt kÄ±sÄ±m absolute playerBottomRow iÃ§in boÅŸluk
    alignItems: 'center',
    justifyContent: 'flex-start',
    gap: 1,
  },
  removeButton: {
    position: 'absolute',
    top: -8,
    right: -8,
    zIndex: 9999,
    elevation: 9999,
    backgroundColor: '#EF4444',
    borderRadius: 13,
    width: 26,
    height: 26,
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 2,
    borderColor: '#FFFFFF',
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.4,
        shadowRadius: 4,
      },
      android: {
        elevation: 999,
      },
      web: {
        boxShadow: '0 2px 8px rgba(239, 68, 68, 0.5)',
      },
    }),
  },
  replaceButton: {
    position: 'absolute',
    top: -8,
    left: -8,
    zIndex: 9999,
    elevation: 9999,
    backgroundColor: '#0F2A24',
    borderRadius: 13,
    width: 26,
    height: 26,
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 2,
    borderColor: '#1FA2A6',
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.3,
        shadowRadius: 4,
      },
      android: {
        elevation: 999,
      },
      web: {
        boxShadow: '0 2px 8px rgba(31, 162, 166, 0.4)',
      },
    }),
  },
  jerseyNumberBadge: {
    width: 22,
    height: 22,
    borderRadius: 6,
    backgroundColor: '#1FA2A6', // âœ… Design System
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: 1,
    borderWidth: 1,
    borderColor: 'rgba(255, 255, 255, 0.2)',
  },
  jerseyNumberText: {
    fontSize: 12,
    fontWeight: '900',
    color: '#FFFFFF',
  },
  ratingBadgeSmall: {
    width: 18,
    height: 14,
    borderRadius: 4,
    backgroundColor: 'rgba(201, 164, 76, 0.3)', // Gold tint for rating
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: 2,
    borderWidth: 1,
    borderColor: 'rgba(201, 164, 76, 0.5)',
  },
  ratingTextSmall: {
    fontSize: 9,
    fontWeight: '700',
    color: '#C9A44C',
  },
  alertBadge: {
    position: 'absolute',
    top: 4,
    right: 4,
    width: 8,
    height: 8,
    borderRadius: 4,
    backgroundColor: 'rgba(239, 68, 68, 0.2)',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 10,
  },
  alertDot: {
    width: 6,
    height: 6,
    borderRadius: 3,
    backgroundColor: '#EF4444',
    zIndex: 50,
  },
  playerName: {
    fontSize: 10,
    fontWeight: '600',
    color: '#FFFFFF',
    textAlign: 'center',
    marginTop: 2,
    paddingHorizontal: 2,
    letterSpacing: 0.3,
    flexShrink: 1,
    flexGrow: 0,
    maxHeight: 22,
  },
  playerPosition: {
    fontSize: 10,
    color: '#9CA3AF',
    textAlign: 'center',
    fontWeight: '600',
    marginTop: 1,
  },
  playerBottomRow: {
    position: 'absolute',
    bottom: 3,
    left: 4,
    right: 4,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  playerRatingBottom: {
    fontSize: 10,
    fontWeight: '700',
    color: '#C9A44C',
  },
  playerPositionBottom: {
    fontSize: 10,
    fontWeight: '600',
    color: '#9CA3AF',
  },
  formGlow: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: 'rgba(245, 158, 11, 0.1)',
    borderRadius: 12,
  },
  formBadge: {
    position: 'absolute',
    bottom: 2,
    left: 2,
  },
  injuryBadge: {
    position: 'absolute',
    bottom: 2,
    right: 2,
  },
  
  // Empty Slot
  emptySlot: {
    width: 64,
    height: 76,
    borderRadius: 8,
    borderWidth: 2,
    borderColor: 'rgba(255, 255, 255, 0.3)',
    borderStyle: 'dashed',
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    alignItems: 'center',
    justifyContent: 'center',
  },
  emptySlotContent: {
    alignItems: 'center',
  },
  emptySlotText: {
    fontSize: 8,
    color: 'rgba(255, 255, 255, 0.7)',
    marginTop: 4,
  },
  
  // âœ… Kompakt toolbar - Tahmin sekmesi infoNote ile AYNI boyut
  bottomBar: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'flex-start',
    backgroundColor: '#1E3A3A',
    borderRadius: 12,
    paddingVertical: 8,
    paddingHorizontal: 8,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)',
    marginTop: 16, // âœ… Tahmin infoNote ile aynÄ± marginTop
    marginBottom: 0, // âœ… Tahmin infoNote ile aynÄ±
    minHeight: 50, // âœ… Minimum yÃ¼kseklik, iÃ§erik daha fazla yer kaplayabilir
  },
  bottomBarLeft: {
    flex: 1,
    flexDirection: 'column',
    justifyContent: 'center',
  },
  // âœ… Tek satÄ±r: Tahminin/GerÃ§ek 11/Topluluk + Atak/Defans (saha boyutu iÃ§in kompakt)
  unifiedToolbarRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    flexWrap: 'wrap',
    gap: 8,
    paddingVertical: 4,
    marginBottom: 4,
  },
  // âœ… KarÅŸÄ±laÅŸtÄ±rma sekmeleri (unifiedToolbarRow iÃ§inde kullanÄ±ldÄ±ÄŸÄ±nda kompakt)
  viewSourceRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
    paddingVertical: 4,
    paddingHorizontal: 8,
    backgroundColor: 'rgba(15, 42, 36, 0.6)',
    borderRadius: 10,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.15)',
  },
  comparisonHint: {
    fontSize: 11,
    color: '#94A3B8',
    textAlign: 'center',
    paddingHorizontal: 12,
    paddingBottom: 6,
  },
  comparisonHint: {
    fontSize: 11,
    color: '#94A3B8',
    textAlign: 'center',
    paddingHorizontal: 12,
    paddingBottom: 6,
  },
  viewSourcePill: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 10,
    backgroundColor: 'rgba(100, 116, 139, 0.15)',
  },
  viewSourcePillActive: {
    backgroundColor: '#1FA2A6',
  },
  viewSourceText: {
    fontSize: 11,
    color: '#9CA3AF',
    fontWeight: '600',
  },
  viewSourceTextActive: {
    color: '#FFFFFF',
  },
  viewToggleRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
    marginBottom: 4,
  },
  viewTogglePill: {
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 12,
    backgroundColor: 'rgba(31, 162, 166, 0.15)',
  },
  viewTogglePillActive: {
    backgroundColor: '#1FA2A6',
  },
  viewToggleText: {
    fontSize: 12,
    color: '#1FA2A6',
    fontWeight: '500',
  },
  viewToggleTextActive: {
    color: '#FFFFFF',
  },
  changeFormationButton: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
  },
  changeFormationText: {
    fontSize: 12,
    color: '#1FA2A6', // âœ… Design System: Secondary (turkuaz)
    fontWeight: '500',
    flex: 1,
  },
  bottomBarRight: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  playerCount: {
    fontSize: 14,
    fontWeight: 'bold',
    color: '#E6E6E6', // âœ… Design System: DARK_MODE.foreground
  },
  completeButton: {
    borderRadius: 8,
    overflow: 'hidden',
  },
  completeButtonDisabled: {
    opacity: 0.5,
  },
  completeButtonGradient: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
    paddingHorizontal: 12,
    paddingVertical: 8,
  },
  completeButtonText: {
    fontSize: 13,
    fontWeight: '600',
    color: '#FFFFFF',
  },
  // âœ… Kilit ButonlarÄ±
  lockButton: {
    width: 36,
    height: 36,
    borderRadius: 8,
    backgroundColor: 'rgba(239, 68, 68, 0.2)',
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 1.5,
    borderColor: '#EF4444',
    marginRight: 8,
  },
  lockButtonOpen: {
    width: 36,
    height: 36,
    borderRadius: 8,
    backgroundColor: 'rgba(16, 185, 129, 0.2)',
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 1.5,
    borderColor: '#10B981',
    marginRight: 8,
  },
  
  // âœ… Simetrik Toolbar: [Formasyon] | ğŸ”“ | [Tamamla] - Kilit kesinlikle ortada
  symmetricToolbar: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center', // âœ… Ortala
    flex: 1,
    position: 'relative', // âœ… Kilit iÃ§in absolute container
  },
  // 2 SatÄ±rlÄ± Formasyon Butonu - SOL
  dualLineFormationButton: {
    flexDirection: 'column',
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 8,
    backgroundColor: 'rgba(31, 162, 166, 0.1)',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)',
    minWidth: 100,
    maxWidth: 130,
    gap: 2,
    position: 'absolute', // âœ… Sol tarafa sabitle
    left: 0,
  },
  formationLine: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
    paddingVertical: 1,
  },
  formationLineActive: {
    // Aktif satÄ±r iÃ§in ek stil (isteÄŸe baÄŸlÄ±)
  },
  formationLineText: {
    fontSize: 11,
    color: '#9CA3AF',
    fontWeight: '500',
    flex: 1,
  },
  formationLineTextActive: {
    color: '#FFFFFF',
    fontWeight: '600',
  },
  // Kilit Butonu - KESÄ°NLÄ°KLE ORTADA
  lockButtonCenter: {
    width: 36,
    height: 36,
    borderRadius: 18,
    alignItems: 'center',
    justifyContent: 'center',
    // Ortada kalmasÄ± iÃ§in position yok - normal flow'da
  },
  lockButtonCenterLocked: {
    backgroundColor: 'rgba(239, 68, 68, 0.2)',
    borderWidth: 1.5,
    borderColor: '#EF4444',
  },
  lockButtonCenterOpen: {
    backgroundColor: 'rgba(16, 185, 129, 0.2)',
    borderWidth: 1.5,
    borderColor: '#10B981',
  },
  lockButtonCenterDisabled: {
    backgroundColor: 'rgba(100, 116, 139, 0.15)',
    borderWidth: 1,
    borderColor: 'rgba(100, 116, 139, 0.3)',
  },
  // Tamamla Butonu - SAÄ tarafa sabitle
  completeButtonSymmetric: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
    paddingHorizontal: 10,
    paddingVertical: 8,
    borderRadius: 8,
    backgroundColor: '#1FA2A6',
    minWidth: 100,
    maxWidth: 130,
    position: 'absolute', // âœ… SaÄŸ tarafa sabitle
    right: 0,
  },
  completeButtonSymmetricDisabled: {
    backgroundColor: '#374151',
    opacity: 0.5,
  },
  completeButtonSymmetricText: {
    fontSize: 12,
    fontWeight: '600',
    color: '#FFFFFF',
  },
  
  // Modal - Design System uyumlu
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.8)',
    justifyContent: 'flex-end',
    alignItems: 'center', // âœ… Yatay ortala
    paddingBottom: 0, // âœ… Alt boÅŸluk yok - zemine yapÄ±ÅŸÄ±k
  },
  modalContent: {
    backgroundColor: '#1A2E2A', // âœ… Design System: Slightly lighter than primary for better contrast
    borderTopLeftRadius: 24,
    borderTopRightRadius: 24,
    borderBottomLeftRadius: 0, // âœ… Alt kÃ¶ÅŸeler dÃ¼z - zemine oturur
    borderBottomRightRadius: 0,
    maxHeight: height * 0.85, // âœ… Scroll alanÄ± iÃ§in yeterli alan bÄ±rak
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)',
    borderBottomWidth: 0, // âœ… Alt border yok - zemine yapÄ±ÅŸÄ±k
    width: '100%', // âœ… Tam geniÅŸlik (mobil)
    maxWidth: 380, // âœ… STANDART: 380px geniÅŸlik (tÃ¼m popup'lar iÃ§in standart)
    marginBottom: 0, // âœ… Alt margin yok - zemine yapÄ±ÅŸÄ±k
  },
  modalHeader: {
    padding: 12, // âœ… Daha az padding - kompakt header
    paddingLeft: 16,
    paddingRight: 56,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(31, 162, 166, 0.15)',
  },
  modalHeaderContent: {
    flex: 1,
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#F8FAFB',
  },
  modalSubtitle: {
    fontSize: 12,
    color: '#64748B',
    marginTop: 4,
  },
  formationModalTabs: {
    flexDirection: 'row',
    paddingHorizontal: 8, // âœ… Daha az yatay padding - geniÅŸ gÃ¶rÃ¼nÃ¼m
    paddingVertical: 10,
    gap: 8,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(31, 162, 166, 0.15)',
  },
  formationModalTab: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    paddingVertical: 10,
    borderRadius: 10,
    backgroundColor: 'rgba(31, 162, 166, 0.1)',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.25)',
  },
  formationModalTabActive: {
    backgroundColor: '#1FA2A6',
    borderColor: '#1FA2A6',
  },
  formationModalTabDisabled: {
    opacity: 0.6,
  },
  formationModalTabText: {
    fontSize: 14,
    fontWeight: '600',
    color: '#1FA2A6',
  },
  formationModalTabTextActive: {
    color: '#FFFFFF',
  },
  formationModalTabTextDisabled: {
    color: '#6B7280',
  },
  modalCloseButton: {
    width: 36,
    height: 36,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: 'rgba(71, 85, 105, 0.6)',
    borderRadius: 18,
    borderWidth: 1,
    borderColor: 'rgba(148, 163, 184, 0.3)',
  },
  defenseModeInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    backgroundColor: 'rgba(59, 130, 246, 0.15)',
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 8,
    marginBottom: 12,
    borderWidth: 1,
    borderColor: 'rgba(59, 130, 246, 0.3)',
  },
  defenseModeInfoText: {
    fontSize: 12,
    color: '#93C5FD',
    flex: 1,
  },
  // âœ… Atak modu bilgi kutusu
  attackModeInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    backgroundColor: 'rgba(31, 162, 166, 0.15)',
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 8,
    marginBottom: 12,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)',
  },
  attackModeInfoText: {
    fontSize: 12,
    color: '#5EEAD4',
    flex: 1,
  },
  modalCloseButtonAbsolute: {
    position: 'absolute',
    top: 12,
    right: 12,
    width: 36,
    height: 36,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: 'rgba(31, 162, 166, 0.15)', // âœ… Design System
    borderRadius: 18,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)',
    zIndex: 1000,
  },
  modalTabs: {
    flexDirection: 'row',
    paddingHorizontal: 12,
    paddingVertical: 10,
    gap: 8,
  },
  modalTab: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
    paddingVertical: 10,
    borderRadius: 10,
    backgroundColor: 'rgba(31, 162, 166, 0.08)', // âœ… Design System
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.15)',
  },
  modalTabActive: {
    backgroundColor: 'rgba(31, 162, 166, 0.25)', // âœ… Aktif tab
    borderWidth: 1,
    borderColor: '#1FA2A6',
  },
  modalTabText: {
    fontSize: 14,
    fontWeight: '600',
    color: '#64748B',
  },
  modalTabTextActive: {
    color: '#1FA2A6',
    fontWeight: '700',
  },
  modalScroll: {
    flex: 1,
  },
  
  // Formation Grid - 3 Columns COMPACT - EÅŸit boÅŸluklar
  formationGridContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    paddingHorizontal: 4, // âœ… Minimal saÄŸ-sol boÅŸluk - daha geniÅŸ gÃ¶rÃ¼nÃ¼m
    paddingTop: 4,
    paddingBottom: Platform.OS === 'web' ? 8 : 24, // âœ… Web: minimal, iOS: home indicator iÃ§in boÅŸluk
    justifyContent: 'space-between', // âœ… EÅŸit daÄŸÄ±lÄ±m
  },
  formationGridItem: {
    width: '32%', // 3 columns
    marginBottom: 6, // âœ… Alt boÅŸluk
    marginBottom: 2,
  },
  formationCard: {
    backgroundColor: '#1E3A3A', // âœ… Design System: Standard card background (not blue)
    borderRadius: 10,
    padding: 6,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)', // âœ… Turkuaz border
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: 52, // âœ… Daha kompakt
    position: 'relative',
  },
  formationCardId: {
    fontSize: 14,
    fontWeight: 'bold',
    color: '#FFFFFF',
    marginBottom: 2,
  },
  formationCardSubtitle: {
    fontSize: 9,
    color: '#64748B',
    textAlign: 'center',
  },
  formationCardSelected: {
    borderColor: '#1FA2A6',
    borderWidth: 2,
    backgroundColor: 'rgba(31, 162, 166, 0.15)',
  },
  // âœ… SeÃ§ili formasyon (mevcut atak/defans formasyonu)
  formationCardCurrentlySelected: {
    borderColor: '#10B981',
    borderWidth: 2,
    backgroundColor: 'rgba(16, 185, 129, 0.15)',
  },
  formationSelectedBadge: {
    position: 'absolute',
    top: -6,
    right: -6,
    backgroundColor: '#0F2A24',
    borderRadius: 10,
    padding: 2,
    zIndex: 10,
  },
  
  // âœ… Formation Preview Modal - AyrÄ± popup
  formationPreviewOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.85)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  formationPreviewModal: {
    backgroundColor: '#1A3D37', // âœ… Daha aÃ§Ä±k ton - belirgin
    borderRadius: 16,
    padding: 20,
    width: '100%',
    maxWidth: 380,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.4)',
    ...Platform.select({
      ios: {
        shadowColor: '#1FA2A6',
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.3,
        shadowRadius: 12,
      },
      android: {
        elevation: 10,
      },
      web: {
        boxShadow: '0 4px 24px rgba(31, 162, 166, 0.25)',
      },
    }),
  },
  formationPreviewHeader: {
    marginBottom: 12,
  },
  formationPreviewTitleRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    marginBottom: 8,
  },
  formationPreviewName: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#FFFFFF',
    flex: 1,
  },
  formationPreviewCloseBtn: {
    width: 32,
    height: 32,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: 'rgba(148, 163, 184, 0.15)',
    borderRadius: 16,
  },
  formationPreviewTypeBadge: {
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 8,
    alignSelf: 'flex-start',
  },
  formationPreviewTypeText: {
    fontSize: 12,
    fontWeight: '600',
  },
  formationPreviewContextHint: {
    fontSize: 12,
    color: '#3B82F6',
    marginTop: 8,
    fontWeight: '500',
  },
  formationPreviewDesc: {
    fontSize: 14,
    color: '#E2E8F0',
    lineHeight: 20,
    marginBottom: 16,
  },
  formationPreviewSection: {
    marginBottom: 12,
  },
  formationPreviewSectionTitle: {
    fontSize: 13,
    fontWeight: '700',
    color: '#FFFFFF',
    marginBottom: 8,
  },
  formationPreviewListItem: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    marginBottom: 4,
    gap: 8,
  },
  formationPreviewBullet: {
    width: 6,
    height: 6,
    borderRadius: 3,
    backgroundColor: '#1FA2A6',
    marginTop: 6,
  },
  formationPreviewListText: {
    fontSize: 12,
    color: '#CBD5E1',
    flex: 1,
    lineHeight: 18,
  },
  formationPreviewBestFor: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    gap: 8,
    backgroundColor: 'rgba(245, 158, 11, 0.12)',
    padding: 12,
    borderRadius: 10,
    marginBottom: 16,
    borderWidth: 1,
    borderColor: 'rgba(245, 158, 11, 0.25)',
  },
  formationPreviewBestForLabel: {
    fontWeight: '700',
    color: '#F59E0B',
  },
  formationPreviewBestForText: {
    fontSize: 12,
    color: '#FDE68A',
    flex: 1,
    lineHeight: 18,
  },
  // âœ… Formasyon PopÃ¼lerlik Stilleri - DÄ°KKAT Ã‡EKÄ°CÄ° TASARIM
  formationPopularitySection: {
    backgroundColor: 'rgba(239, 68, 68, 0.15)', // KÄ±rmÄ±zÄ±msÄ± arka plan
    padding: 14,
    borderRadius: 12,
    marginBottom: 16,
    borderWidth: 2,
    borderColor: 'rgba(249, 115, 22, 0.6)', // Turuncu border
    ...Platform.select({
      ios: {
        shadowColor: '#F97316',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.3,
        shadowRadius: 6,
      },
      android: {
        elevation: 4,
      },
    }),
  },
  formationPopularityHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    marginBottom: 10,
    backgroundColor: 'rgba(249, 115, 22, 0.2)', // Turuncu header arka planÄ±
    padding: 8,
    borderRadius: 8,
    marginHorizontal: -6,
    marginTop: -6,
  },
  formationPopularitySectionTitle: {
    fontSize: 14,
    fontWeight: '800',
    color: '#F97316', // Turuncu baÅŸlÄ±k
    textTransform: 'uppercase',
    letterSpacing: 0.5,
  },
  formationPopularityLoading: {
    fontSize: 12,
    color: '#9CA3AF',
    textAlign: 'center',
    padding: 8,
  },
  formationPopularityContent: {
    gap: 10,
  },
  formationPopularityText: {
    fontSize: 13,
    color: '#F1F5F9', // Daha parlak text
    lineHeight: 20,
    fontWeight: '500',
  },
  formationPopularityHighlight: {
    fontWeight: '800',
    color: '#F97316', // Turuncu vurgu
    fontSize: 16,
  },
  formationPopularityBarBg: {
    height: 8, // Daha kalÄ±n bar
    backgroundColor: 'rgba(100, 116, 139, 0.4)',
    borderRadius: 4,
    overflow: 'hidden',
  },
  formationPopularityBarFill: {
    height: '100%',
    borderRadius: 3,
  },
  formationPreviewButtons: {
    flexDirection: 'row',
    gap: 12,
  },
  formationPreviewCancelBtn: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 12,
    borderRadius: 10,
    backgroundColor: 'rgba(100, 116, 139, 0.2)',
    borderWidth: 1,
    borderColor: 'rgba(100, 116, 139, 0.4)',
  },
  formationPreviewCancelText: {
    fontSize: 14,
    fontWeight: '600',
    color: '#94A3B8',
  },
  formationPreviewSelectBtn: {
    flex: 2,
    borderRadius: 10,
    overflow: 'hidden',
    backgroundColor: '#1FA2A6', // âœ… Opak turkuaz â€“ aÃ§Ä±klama popupâ€™Ä± ile aynÄ±, mavi/ÅŸeffaf gÃ¶rÃ¼nmesin
  },
  formationPreviewSelectGradient: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    paddingVertical: 12,
    opacity: 1,
  },
  formationPreviewSelectText: {
    fontSize: 14,
    fontWeight: '700',
    color: '#FFFFFF',
  },
  
  // âœ… Defense Confirmation Modal Styles
  defenseConfirmOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.85)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 24,
  },
  defenseConfirmModal: {
    backgroundColor: '#1A3D37',
    borderRadius: 20,
    padding: 24,
    width: '100%',
    maxWidth: 380, // âœ… STANDART: 380px geniÅŸlik
    alignItems: 'center',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)',
    ...Platform.select({
      ios: {
        shadowColor: '#1FA2A6',
        shadowOffset: { width: 0, height: 8 },
        shadowOpacity: 0.3,
        shadowRadius: 16,
      },
      android: {
        elevation: 12,
      },
      web: {
        boxShadow: '0 8px 32px rgba(31, 162, 166, 0.25)',
      },
    }),
  },
  defenseConfirmIcon: {
    width: 80,
    height: 80,
    borderRadius: 40,
    backgroundColor: 'rgba(31, 162, 166, 0.15)',
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 16,
  },
  defenseConfirmTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#FFFFFF',
    marginBottom: 12,
    textAlign: 'center',
  },
  defenseConfirmDesc: {
    fontSize: 14,
    color: '#CBD5E1',
    textAlign: 'center',
    lineHeight: 22,
    marginBottom: 16,
  },
  defenseConfirmInfo: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    gap: 10,
    backgroundColor: 'rgba(245, 158, 11, 0.12)',
    padding: 12,
    borderRadius: 10,
    marginBottom: 20,
    borderWidth: 1,
    borderColor: 'rgba(245, 158, 11, 0.25)',
  },
  defenseConfirmInfoText: {
    fontSize: 12,
    color: '#FDE68A',
    flex: 1,
    lineHeight: 18,
  },
  defenseConfirmButtons: {
    flexDirection: 'row',
    gap: 12,
    width: '100%',
  },
  defenseConfirmNoBtn: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
    paddingVertical: 14,
    borderRadius: 12,
    backgroundColor: 'rgba(100, 116, 139, 0.2)',
    borderWidth: 1,
    borderColor: 'rgba(100, 116, 139, 0.4)',
  },
  defenseConfirmNoText: {
    fontSize: 13,
    fontWeight: '600',
    color: '#94A3B8',
  },
  defenseConfirmYesBtn: {
    flex: 1,
    borderRadius: 12,
    overflow: 'hidden',
  },
  defenseConfirmYesGradient: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    paddingVertical: 14,
  },
  defenseConfirmYesText: {
    fontSize: 14,
    fontWeight: '700',
    color: '#FFFFFF',
  },
  

  // Formation Detail Modal
  formationDetailOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.8)',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 20,
  },
  
  // Player Item
  playersList: {
    paddingBottom: 20,
  },
  playerItem: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(255, 255, 255, 0.1)',
  },
  playerItemLeft: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
  },
  playerItemRating: {
    width: 40,
    height: 40,
    borderRadius: 8,
    alignItems: 'center',
    justifyContent: 'center',
  },
  playerItemRatingText: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  // âœ… Jersey Number Badge - Circular
  playerItemJerseyNumber: {
    width: 40,
    height: 40,
    borderRadius: 20, // Fully circular
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 12,
  },
  playerItemJerseyNumberText: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  playerItemInfo: {
    flex: 1,
  },
  playerItemNameRow: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  playerItemName: {
    fontSize: 15,
    fontWeight: '600',
    color: '#FFFFFF',
  },
  playerItemBottomRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 2,
    gap: 8,
  },
  playerItemRatingBottom: {
    fontSize: 13,
    fontWeight: '700',
    color: '#C9A44C', // Gold color for rating
  },
  playerItemPosition: {
    fontSize: 13,
    color: '#9CA3AF',
  },
  playerItemAddBtn: {
    padding: 4,
  },
  playerItemLocked: {
    opacity: 0.5,
    backgroundColor: 'rgba(75, 85, 99, 0.1)',
  },
  playerItemNameLocked: {
    color: '#6B7280',
  },
  playerItemPositionLocked: {
    color: '#4B5563',
  },
  playerItemLockedIcon: {
    padding: 4,
    width: 36,
    alignItems: 'center',
    justifyContent: 'center',
  },
  
  // âœ… Player Modal Close Button
  playerModalCloseBtn: {
    width: 36,
    height: 36,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: 'rgba(148, 163, 184, 0.15)',
    borderRadius: 18,
    borderWidth: 1,
    borderColor: 'rgba(148, 163, 184, 0.3)',
  },
  playerModalHeader: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    justifyContent: 'space-between',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(31, 162, 166, 0.15)',
  },
  playerModalHeaderText: {
    flex: 1,
    marginRight: 12,
  },
  playerModalCloseBtnTopRight: {
    width: 36,
    height: 36,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: 'rgba(148, 163, 184, 0.15)',
    borderRadius: 18,
    borderWidth: 1,
    borderColor: 'rgba(148, 163, 184, 0.3)',
  },

  // âœ… Player Card Modal - FIFA Style
  playerCardOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.9)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  playerCardContainer: {
    width: '100%',
    maxWidth: 340,
    borderRadius: 24,
    overflow: 'hidden',
    backgroundColor: '#0F2027',
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 10 },
        shadowOpacity: 0.5,
        shadowRadius: 20,
      },
      android: {
        elevation: 20,
      },
    }),
  },
  playerCardHeader: {
    paddingTop: 40,
    paddingBottom: 24,
    paddingHorizontal: 20,
    alignItems: 'center',
    position: 'relative',
  },
  playerCardCloseBtn: {
    position: 'absolute',
    top: 12,
    right: 12,
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: 'rgba(255, 255, 255, 0.2)',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 10,
  },
  playerCardRatingCircle: {
    width: 72,
    height: 72,
    borderRadius: 36,
    backgroundColor: 'rgba(255, 255, 255, 0.25)',
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 12,
    borderWidth: 3,
    borderColor: 'rgba(255, 255, 255, 0.5)',
  },
  playerCardRatingText: {
    fontSize: 32,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  playerCardName: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#FFFFFF',
    textAlign: 'center',
    marginBottom: 8,
    ...Platform.select({
      web: { textShadow: '0px 1px 2px rgba(0,0,0,0.3)' },
      default: {
        textShadowColor: 'rgba(0,0,0,0.3)',
        textShadowOffset: { width: 0, height: 1 },
        textShadowRadius: 2,
      },
    }),
  },
  playerCardPositionRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 10,
    marginBottom: 6,
  },
  playerCardPositionBadge: {
    backgroundColor: 'rgba(255, 255, 255, 0.3)',
    paddingHorizontal: 12,
    paddingVertical: 4,
    borderRadius: 12,
  },
  playerCardPositionText: {
    fontSize: 13,
    fontWeight: '700',
    color: '#FFFFFF',
  },
  playerCardTeam: {
    fontSize: 14,
    color: 'rgba(255, 255, 255, 0.9)',
  },
  playerCardInfoRow: {
    marginTop: 4,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    width: '100%',
  },
  playerCardInfoText: {
    fontSize: 12,
    color: 'rgba(255, 255, 255, 0.7)',
  },
  playerCardRatingBottom: {
    fontSize: 14,
    fontWeight: '700',
    color: '#C9A44C', // Gold color for rating
  },
  playerCardBody: {
    backgroundColor: '#0F2027',
    padding: 20,
  },
  playerCardStatusRow: {
    flexDirection: 'row',
    gap: 12,
    marginBottom: 20,
  },
  playerCardStatusItem: {
    flex: 1,
    alignItems: 'center',
    paddingVertical: 12,
    borderRadius: 14,
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    borderWidth: 2,
  },
  playerCardStatusLabel: {
    fontSize: 10,
    color: '#94A3B8',
    marginTop: 4,
    textTransform: 'uppercase',
  },
  playerCardStatusValue: {
    fontSize: 14,
    fontWeight: '700',
    marginTop: 2,
  },
  playerCardStatsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    marginBottom: 16,
  },
  playerCardStatItem: {
    width: '30%',
    alignItems: 'center',
    marginBottom: 16,
  },
  playerCardStatCircle: {
    width: 52,
    height: 52,
    borderRadius: 26,
    borderWidth: 3,
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 6,
  },
  playerCardStatValue: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  playerCardStatLabel: {
    fontSize: 9,
    color: '#64748B',
    fontWeight: '600',
    textAlign: 'center',
  },
  // âœ… Oyuncu Preview - Topluluk Tercihleri Stilleri
  playerPreviewCommunitySection: {
    backgroundColor: 'rgba(249, 115, 22, 0.12)',
    padding: 12,
    borderRadius: 12,
    marginBottom: 12,
    borderWidth: 1.5,
    minHeight: 130, // âœ… Sabit minimum yÃ¼kseklik - 3 satÄ±r + header iÃ§in yeterli
    borderColor: 'rgba(249, 115, 22, 0.4)',
  },
  playerPreviewCommunityHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
    marginBottom: 10,
  },
  playerPreviewCommunityTitle: {
    fontSize: 12,
    fontWeight: '700',
    color: '#F97316',
    textTransform: 'uppercase',
    letterSpacing: 0.3,
  },
  playerPreviewCommunityLoading: {
    fontSize: 11,
    color: '#9CA3AF',
    textAlign: 'center',
    paddingVertical: 36, // âœ… Loading durumunda da aynÄ± yÃ¼ksekliÄŸi koru - iÃ§erikle eÅŸit
  },
  playerPreviewCommunityContent: {
    gap: 8,
    minHeight: 85, // âœ… Sabit minimum yÃ¼kseklik - 3 satÄ±r iÃ§in
  },
  playerPreviewCommunityRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  playerPreviewCommunityText: {
    fontSize: 11,
    color: '#E2E8F0',
    flex: 1,
    lineHeight: 16,
  },
  playerPreviewCommunityHighlight: {
    fontWeight: '700',
    color: '#F97316',
    fontSize: 12,
  },
  
  playerCardAssignInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    backgroundColor: 'rgba(31, 162, 166, 0.15)',
    paddingVertical: 10,
    paddingHorizontal: 16,
    borderRadius: 12,
    marginBottom: 16,
  },
  playerCardAssignText: {
    fontSize: 13,
    color: '#94A3B8',
  },
  playerCardActions: {
    flexDirection: 'row',
    gap: 12,
  },
  playerCardCancelBtn: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 14,
    borderRadius: 14,
    backgroundColor: 'rgba(100, 116, 139, 0.15)',
    borderWidth: 1,
    borderColor: 'rgba(100, 116, 139, 0.3)',
  },
  playerCardCancelText: {
    fontSize: 14,
    fontWeight: '600',
    color: '#94A3B8',
  },
  playerCardAddBtn: {
    flex: 2,
    borderRadius: 14,
    overflow: 'hidden',
  },
  playerCardAddGradient: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    paddingVertical: 14,
  },
  playerCardAddText: {
    fontSize: 14,
    fontWeight: '700',
    color: '#FFFFFF',
  },
  playerCardWarning: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    backgroundColor: 'rgba(245, 158, 11, 0.1)',
    padding: 12,
    borderRadius: 12,
    marginTop: 12,
    borderWidth: 1,
    borderColor: 'rgba(245, 158, 11, 0.2)',
  },
  playerCardWarningText: {
    fontSize: 11,
    color: '#FDE68A',
    flex: 1,
  },
  
  // Player Detail Modal - STANDART POPUP STÄ°LÄ° (alttan aÃ§Ä±lÄ±r, zemine yapÄ±ÅŸÄ±k, SCROLL YOK)
  playerDetailModal: {
    backgroundColor: '#1E3A3A',
    borderTopLeftRadius: 24,
    borderTopRightRadius: 24,
    borderBottomLeftRadius: 0,
    borderBottomRightRadius: 0,
    overflow: 'hidden', // âœ… KÃ¶ÅŸelerin yuvarlaklÄ±ÄŸÄ±nÄ± zorla
    width: '92%',
    maxWidth: 380, // âœ… STANDART: 380px geniÅŸlik
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)',
    borderBottomWidth: 0,
    marginBottom: 0,
    marginHorizontal: '4%',
    paddingBottom: Platform.OS === 'web' ? 16 : 34,
  },
  playerDetailHeader: {
    padding: 20,
    paddingTop: 16,
  },
  playerDetailHeaderContent: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 16,
    marginTop: 8,
  },
  playerDetailRating: {
    width: 60,
    height: 60,
    borderRadius: 12,
    alignItems: 'center',
    justifyContent: 'center',
  },
  playerDetailRatingText: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  playerDetailInfo: {
    flex: 1,
  },
  playerDetailName: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  playerDetailMeta: {
    fontSize: 13,
    color: '#9CA3AF',
    marginTop: 4,
  },
  playerDetailBadges: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    marginTop: 8,
  },
  nationalityBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
    backgroundColor: 'rgba(5, 150, 105, 0.2)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  nationalityText: {
    fontSize: 11,
    color: '#1FA2A6',
    fontWeight: '600',
  },
  formBadgeLarge: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
    backgroundColor: 'rgba(245, 158, 11, 0.2)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  formTextLarge: {
    fontSize: 11,
    color: '#F59E0B',
    fontWeight: '600',
  },
  injuryBadgeLarge: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
    backgroundColor: 'rgba(239, 68, 68, 0.2)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  injuryTextLarge: {
    fontSize: 11,
    color: '#EF4444',
    fontWeight: '600',
  },
  // âœ… Elit oyuncu badge
  eliteBadgeLarge: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
    backgroundColor: 'rgba(201, 164, 76, 0.2)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
    borderWidth: 1,
    borderColor: 'rgba(201, 164, 76, 0.4)',
  },
  eliteTextLarge: {
    fontSize: 11,
    color: '#C9A44C',
    fontWeight: '700',
  },
  // âœ… Elit oyuncu header stili
  playerDetailHeaderElite: {
    borderWidth: 2,
    borderColor: '#C9A44C',
    borderTopLeftRadius: 24,
    borderTopRightRadius: 24,
  },
  playerDetailContent: {
    flex: 1,
    padding: 20,
  },
  // âœ… YENI: Scroll olmayan kompakt iÃ§erik alanÄ±
  playerDetailContentNoScroll: {
    paddingHorizontal: 16,
    paddingTop: 12,
    paddingBottom: 8,
  },
  playerDetailSectionTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#FFFFFF',
    marginBottom: 16,
  },
  // âœ… YENI: Kompakt baÅŸlÄ±k
  playerDetailSectionTitleCompact: {
    fontSize: 13,
    fontWeight: '700',
    color: '#FFFFFF',
    marginBottom: 8,
  },
  statsGrid: {
    gap: 12,
  },
  // âœ… YENI: 1 sÃ¼tun 6 satÄ±r dikey layout - scroll yok, tek sayfada
  statsGridCompact: {
    flexDirection: 'column', // âœ… Dikey layout
    gap: 6,
    marginBottom: 12,
  },
  statItemCompact: {
    width: '100%', // âœ… Tam geniÅŸlik - tek sÃ¼tun
    backgroundColor: 'rgba(15, 23, 42, 0.5)',
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 8,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.15)',
    flexDirection: 'row', // âœ… Yatay iÃ§erik: Label | Bar | Value
    alignItems: 'center',
    gap: 10,
  },
  // statItemCompactHeader artÄ±k kullanÄ±lmÄ±yor - dikey layout'ta label/bar/value ayrÄ±
  statLabelCompact: {
    fontSize: 11,
    fontWeight: '600',
    color: '#9CA3AF',
    width: 55, // âœ… Sabit geniÅŸlik - label iÃ§in
  },
  statValueCompact: {
    fontSize: 14,
    fontWeight: 'bold',
    width: 28, // âœ… Sabit geniÅŸlik - value iÃ§in
    textAlign: 'right',
  },
  statBarBackgroundCompact: {
    flex: 1, // âœ… Kalan alanÄ± doldur
    height: 6,
    backgroundColor: 'rgba(100, 116, 139, 0.3)',
    borderRadius: 3,
    overflow: 'hidden',
  },
  statBarFillCompact: {
    height: '100%',
    borderRadius: 3,
  },
  statItem: {
    gap: 6,
  },
  statLabel: {
    fontSize: 13,
    fontWeight: '600',
    color: '#FFFFFF',
  },
  statBarContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
  },
  statBarBackground: {
    flex: 1,
    height: 8,
    backgroundColor: 'rgba(100, 116, 139, 0.3)',
    borderRadius: 4,
    overflow: 'hidden',
  },
  statBarFill: {
    height: '100%',
    borderRadius: 4,
  },
  statValue: {
    fontSize: 14,
    fontWeight: 'bold',
    width: 30,
    textAlign: 'right',
  },
  additionalInfo: {
    flexDirection: 'row',
    gap: 12,
    marginTop: 24,
  },
  // âœ… YENI: Kompakt info chips
  additionalInfoCompact: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 6,
    marginBottom: 12,
  },
  infoChip: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
    backgroundColor: 'rgba(31, 162, 166, 0.1)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)',
  },
  infoChipText: {
    fontSize: 11,
    fontWeight: '600',
    color: '#FFFFFF',
  },
  infoCard: {
    flex: 1,
    backgroundColor: 'rgba(15, 23, 42, 0.5)',
    padding: 12,
    borderRadius: 12,
    alignItems: 'center',
    gap: 6,
    borderWidth: 1,
    borderColor: 'rgba(5, 150, 105, 0.3)',
  },
  infoCardLabel: {
    fontSize: 11,
    color: '#9CA3AF',
  },
  infoCardValue: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  // âœ… YENI: Kompakt topluluk istatistikleri
  communityStatsSectionCompact: {
    marginTop: -5,
    paddingTop: 8,
    borderTopWidth: 1,
    borderTopColor: 'rgba(255, 255, 255, 0.1)',
  },
  communityStatsCompactRow: {
    flexDirection: 'row',
    gap: 8,
  },
  communityStatChip: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
    backgroundColor: 'rgba(15, 23, 42, 0.5)',
    padding: 10,
    borderRadius: 10,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)',
  },
  communityStatChipLabel: {
    fontSize: 11,
    color: '#9CA3AF',
    flex: 1,
  },
  communityStatChipValue: {
    fontSize: 14,
    fontWeight: 'bold',
  },
  communityStatsCompactLoading: {
    alignItems: 'center',
    paddingVertical: 12,
  },
  communityStatsCompactLocked: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
    paddingVertical: 10,
    backgroundColor: 'rgba(100, 116, 139, 0.1)',
    borderRadius: 8,
  },
  communityStatsCompactLockedText: {
    fontSize: 11,
    color: '#9CA3AF',
  },
  playerDetailActions: {
    marginTop: -5,
    padding: 16,
    paddingBottom: 8, // âœ… Modal paddingBottom zaten var
    borderTopWidth: 1,
    borderTopColor: 'rgba(255, 255, 255, 0.1)',
  },
  playerDetailCloseButton: {
    height: 50,
    borderRadius: 12,
    overflow: 'hidden',
  },
  playerDetailCloseButtonGradient: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
  },
  playerDetailCloseButtonText: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  
  // âœ… Topluluk istatistikleri stilleri
  communityStatsSection: {
    marginTop: 24,
    paddingTop: 16,
    borderTopWidth: 1,
    borderTopColor: 'rgba(255, 255, 255, 0.1)',
  },
  communityStatsContainer: {
    gap: 16,
  },
  communityStatsLoadingPlaceholder: {
    opacity: 0.5,
  },
  communityStatRow: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    gap: 12,
    backgroundColor: 'rgba(15, 23, 42, 0.5)',
    padding: 14,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.2)',
  },
  communityStatIcon: {
    width: 36,
    height: 36,
    borderRadius: 10,
    backgroundColor: 'rgba(31, 162, 166, 0.15)',
    alignItems: 'center',
    justifyContent: 'center',
  },
  communityStatContent: {
    flex: 1,
    gap: 8,
  },
  communityStatLabel: {
    fontSize: 13,
    color: '#CBD5E1',
    lineHeight: 18,
  },
  communityStatHighlight: {
    color: '#1FA2A6',
    fontWeight: '700',
    fontSize: 14,
  },
  communityStatBarBg: {
    height: 6,
    backgroundColor: 'rgba(100, 116, 139, 0.3)',
    borderRadius: 3,
    overflow: 'hidden',
  },
  communityStatBarFill: {
    height: '100%',
    borderRadius: 3,
  },
  
  // Button Gradient
  buttonGradient: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    paddingVertical: 14,
  },
  buttonText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#FFFFFF',
  },
  
  // âœ… Kaydediliyor... Overlay Stilleri
  savingOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.9)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  savingContainer: {
    backgroundColor: 'rgba(15, 42, 36, 0.95)',
    borderRadius: 20,
    padding: 32,
    alignItems: 'center',
    borderWidth: 1,
    borderColor: 'rgba(31, 162, 166, 0.3)',
    ...Platform.select({
      ios: {
        shadowColor: '#1FA2A6',
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.3,
        shadowRadius: 12,
      },
      android: {
        elevation: 8,
      },
    }),
  },
  savingText: {
    fontSize: 20,
    fontWeight: '700',
    color: '#FFFFFF',
    marginTop: 16,
  },
  savingSubtext: {
    fontSize: 14,
    color: '#9CA3AF',
    marginTop: 8,
    textAlign: 'center',
  },
});
